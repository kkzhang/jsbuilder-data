cc.TGA_OK=0,cc.TGA_ERROR_FILE_OPEN=1,cc.TGA_ERROR_READING_FILE=2,cc.TGA_ERROR_INDEXED_COLOR=3,cc.TGA_ERROR_MEMORY=4,cc.TGA_ERROR_COMPRESSED_FILE=5,cc.ImageTGA=function(a,b,c,d,e,f,g){this.status=a||0,this.type=b||0,this.pixelDepth=c||0,this.width=d||0,this.height=e||0,this.imageData=f||[],this.flipped=g||0},cc.tgaLoadHeader=function(a,b,c){var d=2;if(d+1>b)return!1;var e=new cc.BinaryStreamReader(a);if(e.setOffset(d),c.type=e.readByte(),d+=10,d+4+1>b)return!1;if(e.setOffset(d),c.width=e.readUnsignedShort(),c.height=e.readUnsignedInteger(),c.pixelDepth=e.readByte(),d+=5,d+1>b)return!1;var f=e.readByte();return c.flipped=0,32&f&&(c.flipped=1),!0},cc.tgaLoadImageData=function(a,b,c){var d,e,f,g,h=18;if(d=0|c.pixelDepth/2,e=c.height*c.width*d,h+e>b)return!1;if(c.imageData=cc.__getSubArray(a,h,h+e),d>=3)for(f=0;f<e;f+=d)g=c.imageData[f],c.imageData[f]=c.imageData[f+2],c.imageData[f+2]=g;return!0},cc.tgaRGBtogreyscale=function(a){var b,c;if(8!==a.pixelDepth){var d=a.pixelDepth/8,e=new Uint8Array(a.height*a.width);if(null!==e){for(b=0,c=0;c<a.width*a.height;b+=d,c++)e[c]=.3*a.imageData[b]+.59*a.imageData[b+1]+.11*a.imageData[b+2];a.pixelDepth=8,a.type=3,a.imageData=e}}},cc.tgaDestroy=function(a){a&&(a.imageData=null,a=null)},cc.tgaLoadRLEImageData=function(a,b,c){var d,e,f,g=0,h=0,i=0,j=[],k=0,l=18;for(d=c.pixelDepth/8,e=c.height*c.width,f=0;f<e;f++){if(0!==k)k--,h=0!==i;else{if(l+1>b)break;k=a[l],l+=1,i=128&k,i&&(k-=128),h=0}if(!h){if(l+d>b)break;if(j=cc.__getSubArray(a,l,l+d),l+=d,d>=3){var m=j[0];j[0]=j[2],j[2]=m}}for(var n=0;n<d;n++)c.imageData[g+n]=j[n];g+=d}return!0},cc.tgaFlipImage=function(a){for(var b=a.pixelDepth/8,c=a.width*b,d=0;d<a.height/2;d++){var e=cc.__getSubArray(a.imageData,d*c,d*c+c);cc.__setDataToArray(cc.__getSubArray(a.imageData,(a.height-(d+1))*c,c),a.imageData,d*c),cc.__setDataToArray(e,a.imageData,(a.height-(d+1))*c)}a.flipped=0},cc.__getSubArray=function(a,b,c){return a instanceof Array?a.slice(b,c):a.subarray(b,c)},cc.__setDataToArray=function(a,b,c){for(var d=0;d<a.length;d++)b[c+d]=a[d]},cc.BinaryStreamReader=cc.Class.extend({_binaryData:null,_offset:0,ctor:function(a){this._binaryData=a},setBinaryData:function(a){this._binaryData=a,this._offset=0},getBinaryData:function(){return this._binaryData},_checkSize:function(a){if(!(this._offset+Math.ceil(a/8)<this._data.length))throw new Error("Index out of bound")},_decodeFloat:function(a,b){var c=a+b+1,d=c>>3;this._checkSize(c);var e=Math.pow(2,b-1)-1,f=this._readBits(a+b,1,d),g=this._readBits(a,b,d),h=0,i=2,j=0;do for(var k=this._readByte(++j,d),l=a%8||8,m=1<<l;m>>=1;)k&m&&(h+=1/i),i*=2;while(a-=l);return this._offset+=d,g===(e<<1)+1?h?NaN:f?-(1/0):+(1/0):(1+f*-2)*(g||h?g?Math.pow(2,g-e)*(1+h):Math.pow(2,-e+1)*h:0)},_readByte:function(a,b){return this._data[this._offset+b-a-1]},_decodeInt:function(a,b){var c=this._readBits(0,a,a/8),d=Math.pow(2,a),e=b&&c>=d/2?c-d:c;return this._offset+=a/8,e},_shl:function(a,b){for(++b;--b;a=1073741824===(1073741824&(a%=2147483648))?2*a:2*(a-1073741824)+2147483647+1);return a},_readBits:function(a,b,c){var d=(a+b)%8,e=a%8,f=c-(a>>3)-1,g=c+(-(a+b)>>3),h=f-g,i=this._readByte(f,c)>>e&(1<<(h?8-e:b))-1;for(h&&d&&(i+=(this._readByte(g++,c)&(1<<d)-1)<<(h--<<3)-e);h;)i+=this._shl(this._readByte(g++,c),(h--<<3)-e);return i},readInteger:function(){return this._decodeInt(32,!0)},readUnsignedInteger:function(){return this._decodeInt(32,!1)},readSingle:function(){return this._decodeFloat(23,8)},readShort:function(){return this._decodeInt(16,!0)},readUnsignedShort:function(){return this._decodeInt(16,!1)},readByte:function(){var a=this._data[this._offset];return this._offset+=1,a},readData:function(a,b){return this._binaryData instanceof Array?this._binaryData.slice(a,b):this._binaryData.subarray(a,b)},setOffset:function(a){this._offset=a},getOffset:function(){return this._offset}}),cc.TMX_ORIENTATION_ORTHO=0,cc.TMX_ORIENTATION_HEX=1,cc.TMX_ORIENTATION_ISO=2,cc.TMXTiledMap=cc.Node.extend({properties:null,mapOrientation:null,objectGroups:null,_mapSize:null,_tileSize:null,_tileProperties:null,_className:"TMXTiledMap",ctor:function(a,b){cc.Node.prototype.ctor.call(this),this._mapSize=cc.size(0,0),this._tileSize=cc.size(0,0),void 0!==b?this.initWithXML(a,b):void 0!==a&&this.initWithTMXFile(a)},getMapSize:function(){return cc.size(this._mapSize.width,this._mapSize.height)},setMapSize:function(a){this._mapSize.width=a.width,this._mapSize.height=a.height},_getMapWidth:function(){return this._mapSize.width},_setMapWidth:function(a){this._mapSize.width=a},_getMapHeight:function(){return this._mapSize.height},_setMapHeight:function(a){this._mapSize.height=a},getTileSize:function(){return cc.size(this._tileSize.width,this._tileSize.height)},setTileSize:function(a){this._tileSize.width=a.width,this._tileSize.height=a.height},_getTileWidth:function(){return this._tileSize.width},_setTileWidth:function(a){this._tileSize.width=a},_getTileHeight:function(){return this._tileSize.height},_setTileHeight:function(a){this._tileSize.height=a},getMapOrientation:function(){return this.mapOrientation},setMapOrientation:function(a){this.mapOrientation=a},getObjectGroups:function(){return this.objectGroups},setObjectGroups:function(a){this.objectGroups=a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},initWithTMXFile:function(a){if(!a||0===a.length)throw new Error("cc.TMXTiledMap.initWithTMXFile(): tmxFile should be non-null or non-empty string.");this.width=0,this.height=0;var b=new cc.TMXMapInfo(a);if(!b)return!1;var c=b.getTilesets();return c&&0!==c.length||cc.log("cc.TMXTiledMap.initWithTMXFile(): Map not found. Please check the filename."),this._buildWithMapInfo(b),!0},initWithXML:function(a,b){this.width=0,this.height=0;var c=new cc.TMXMapInfo(a,b),d=c.getTilesets();return d&&0!==d.length||cc.log("cc.TMXTiledMap.initWithXML(): Map not found. Please check the filename."),this._buildWithMapInfo(c),!0},_buildWithMapInfo:function(a){this._mapSize=a.getMapSize(),this._tileSize=a.getTileSize(),this.mapOrientation=a.orientation,this.objectGroups=a.getObjectGroups(),this.properties=a.properties,this._tileProperties=a.getTileProperties();var b=0,c=a.getLayers();if(c)for(var d=null,e=0,f=c.length;e<f;e++)if(d=c[e],d&&d.visible){var g=this._parseLayer(d,a);this.addChild(g,b,b),this.width=Math.max(this.width,g.width),this.height=Math.max(this.height,g.height),b++}},allLayers:function(){for(var a=[],b=this._children,c=0,d=b.length;c<d;c++){var e=b[c];e&&e instanceof cc.TMXLayer&&a.push(e)}return a},getLayer:function(a){if(!a||0===a.length)throw new Error("cc.TMXTiledMap.getLayer(): layerName should be non-null or non-empty string.");for(var b=this._children,c=0;c<b.length;c++){var d=b[c];if(d&&d.layerName===a)return d}return null},getObjectGroup:function(a){if(!a||0===a.length)throw new Error("cc.TMXTiledMap.getObjectGroup(): groupName should be non-null or non-empty string.");if(this.objectGroups)for(var b=0;b<this.objectGroups.length;b++){var c=this.objectGroups[b];if(c&&c.groupName===a)return c}return null},getProperty:function(a){return this.properties[a.toString()]},propertiesForGID:function(a){return cc.log("propertiesForGID is deprecated. Please use getPropertiesForGID instead."),this.getPropertiesForGID[a]},getPropertiesForGID:function(a){return this._tileProperties[a]},_parseLayer:function(a,b){var c=this._tilesetForLayer(a,b),d=new cc.TMXLayer(c,a,b);return a.ownTiles=!1,d},_tilesetForLayer:function(a,b){var c=a._layerSize,d=b.getTilesets();if(d)for(var e=d.length-1;e>=0;e--){var f=d[e];if(f)for(var g=0;g<c.height;g++)for(var h=0;h<c.width;h++){var i=h+c.width*g,j=a._tiles[i];if(0!==j&&(j&cc.TMX_TILE_FLIPPED_MASK)>>>0>=f.firstGid)return f}}return cc.log("cocos2d: Warning: TMX Layer "+a.name+" has no tiles"),null}});var _p=cc.TMXTiledMap.prototype;_p.mapWidth,cc.defineGetterSetter(_p,"mapWidth",_p._getMapWidth,_p._setMapWidth),_p.mapHeight,cc.defineGetterSetter(_p,"mapHeight",_p._getMapHeight,_p._setMapHeight),_p.tileWidth,cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth),_p.tileHeight,cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight),cc.TMXTiledMap.create=function(a,b){return new cc.TMXTiledMap(a,b)},cc.TMX_PROPERTY_NONE=0,cc.TMX_PROPERTY_MAP=1,cc.TMX_PROPERTY_LAYER=2,cc.TMX_PROPERTY_OBJECTGROUP=3,cc.TMX_PROPERTY_OBJECT=4,cc.TMX_PROPERTY_TILE=5,cc.TMX_TILE_HORIZONTAL_FLAG=2147483648,cc.TMX_TILE_VERTICAL_FLAG=1073741824,cc.TMX_TILE_DIAGONAL_FLAG=536870912,cc.TMX_TILE_FLIPPED_ALL=(cc.TMX_TILE_HORIZONTAL_FLAG|cc.TMX_TILE_VERTICAL_FLAG|cc.TMX_TILE_DIAGONAL_FLAG)>>>0,cc.TMX_TILE_FLIPPED_MASK=~cc.TMX_TILE_FLIPPED_ALL>>>0,cc.TMXLayerInfo=cc.Class.extend({properties:null,name:"",_layerSize:null,_tiles:null,visible:null,_opacity:null,ownTiles:!0,_minGID:1e5,_maxGID:0,offset:null,ctor:function(){this.properties=[],this.name="",this._layerSize=null,this._tiles=null,this.visible=!0,this._opacity=0,this.ownTiles=!0,this._minGID=1e5,this._maxGID=0,this.offset=cc.p(0,0)},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a}}),cc.TMXTilesetInfo=cc.Class.extend({name:"",firstGid:0,_tileSize:null,spacing:0,margin:0,sourceImage:"",imageSize:null,ctor:function(){this._tileSize=cc.size(0,0),this.imageSize=cc.size(0,0)},rectForGID:function(a,b){var c=b||cc.rect(0,0,0,0);c.width=this._tileSize.width,c.height=this._tileSize.height,a&=cc.TMX_TILE_FLIPPED_MASK,a-=parseInt(this.firstGid,10);var d=parseInt((this.imageSize.width-2*this.margin+this.spacing)/(this._tileSize.width+this.spacing),10);return c.x=parseInt(a%d*(this._tileSize.width+this.spacing)+this.margin,10),c.y=parseInt(parseInt(a/d,10)*(this._tileSize.height+this.spacing)+this.margin,10),c}}),cc.TMXMapInfo=cc.SAXParser.extend({properties:null,orientation:null,parentElement:null,parentGID:null,layerAttrs:0,storingCharacters:!1,tmxFileName:null,currentString:null,_objectGroups:null,_mapSize:null,_tileSize:null,_layers:null,_tilesets:null,_tileProperties:null,_resources:"",_currentFirstGID:0,ctor:function(a,b){cc.SAXParser.prototype.ctor.apply(this),this._mapSize=cc.size(0,0),this._tileSize=cc.size(0,0),this._layers=[],this._tilesets=[],this._objectGroups=[],this.properties=[],this._tileProperties={},this._currentFirstGID=0,void 0!==b?this.initWithXML(a,b):void 0!==a&&this.initWithTMXFile(a)},getOrientation:function(){return this.orientation},setOrientation:function(a){this.orientation=a},getMapSize:function(){return cc.size(this._mapSize.width,this._mapSize.height)},setMapSize:function(a){this._mapSize.width=a.width,this._mapSize.height=a.height},_getMapWidth:function(){return this._mapSize.width},_setMapWidth:function(a){this._mapSize.width=a},_getMapHeight:function(){return this._mapSize.height},_setMapHeight:function(a){this._mapSize.height=a},getTileSize:function(){return cc.size(this._tileSize.width,this._tileSize.height)},setTileSize:function(a){this._tileSize.width=a.width,this._tileSize.height=a.height},_getTileWidth:function(){return this._tileSize.width},_setTileWidth:function(a){this._tileSize.width=a},_getTileHeight:function(){return this._tileSize.height},_setTileHeight:function(a){this._tileSize.height=a},getLayers:function(){return this._layers},setLayers:function(a){this._layers.push(a)},getTilesets:function(){return this._tilesets},setTilesets:function(a){this._tilesets.push(a)},getObjectGroups:function(){return this._objectGroups},setObjectGroups:function(a){this._objectGroups.push(a)},getParentElement:function(){return this.parentElement},setParentElement:function(a){this.parentElement=a},getParentGID:function(){return this.parentGID},setParentGID:function(a){this.parentGID=a},getLayerAttribs:function(){return this.layerAttrs},setLayerAttribs:function(a){this.layerAttrs=a},getStoringCharacters:function(){return this.storingCharacters},setStoringCharacters:function(a){this.storingCharacters=a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},initWithTMXFile:function(a){return this._internalInit(a,null),this.parseXMLFile(a)},initWithXML:function(a,b){return this._internalInit(null,b),this.parseXMLString(a)},parseXMLFile:function(a,b){b=b||!1;var c=b?a:cc.loader.getRes(a);if(!c)throw new Error("Please load the resource first : "+a);var d,e,f=this._parseXML(c),g=f.documentElement,h=g.getAttribute("version"),i=g.getAttribute("orientation");if("map"===g.nodeName){"1.0"!==h&&null!==h&&cc.log("cocos2d: TMXFormat: Unsupported TMX version:"+h),"orthogonal"===i?this.orientation=cc.TMX_ORIENTATION_ORTHO:"isometric"===i?this.orientation=cc.TMX_ORIENTATION_ISO:"hexagonal"===i?this.orientation=cc.TMX_ORIENTATION_HEX:null!==i&&cc.log("cocos2d: TMXFomat: Unsupported orientation:"+i);var j=cc.size(0,0);j.width=parseFloat(g.getAttribute("width")),j.height=parseFloat(g.getAttribute("height")),this.setMapSize(j),j=cc.size(0,0),j.width=parseFloat(g.getAttribute("tilewidth")),j.height=parseFloat(g.getAttribute("tileheight")),this.setTileSize(j);var k=g.querySelectorAll("map > properties >  property");if(k){var l={};for(d=0;d<k.length;d++)l[k[d].getAttribute("name")]=k[d].getAttribute("value");this.properties=l}}var m=g.getElementsByTagName("tileset");for("map"!==g.nodeName&&(m=[],m.push(g)),d=0;d<m.length;d++){var n=m[d],o=n.getAttribute("source");if(o){var p=b?cc.path.join(this._resources,o):cc.path.changeBasename(a,o);this.parseXMLFile(p)}else{var q=new cc.TMXTilesetInfo;q.name=n.getAttribute("name")||"",q.firstGid=parseInt(n.getAttribute("firstgid"))||0,q.spacing=parseInt(n.getAttribute("spacing"))||0,q.margin=parseInt(n.getAttribute("margin"))||0;var r=cc.size(0,0);r.width=parseFloat(n.getAttribute("tilewidth")),r.height=parseFloat(n.getAttribute("tileheight")),q._tileSize=r;var s=n.getElementsByTagName("image")[0],t=s.getAttribute("source"),u=-1;if(this.tmxFileName&&(u=this.tmxFileName.lastIndexOf("/")),u!==-1){var v=this.tmxFileName.substr(0,u+1);q.sourceImage=v+t}else q.sourceImage=this._resources+(this._resources?"/":"")+t;this.setTilesets(q);var w=n.getElementsByTagName("tile");if(w)for(var x=0;x<w.length;x++){var y=w[x];this.parentGID=parseInt(q.firstGid)+parseInt(y.getAttribute("id")||0);var z=y.querySelectorAll("properties > property");if(z){var A={};for(e=0;e<z.length;e++){var B=z[e].getAttribute("name");A[B]=z[e].getAttribute("value")}this._tileProperties[this.parentGID]=A}}}}var C=g.getElementsByTagName("layer");if(C)for(d=0;d<C.length;d++){var D=C[d],E=D.getElementsByTagName("data")[0],F=new cc.TMXLayerInfo;F.name=D.getAttribute("name");var G=cc.size(0,0);G.width=parseFloat(D.getAttribute("width")),G.height=parseFloat(D.getAttribute("height")),F._layerSize=G;var H=D.getAttribute("visible");F.visible=!("0"==H);var I=D.getAttribute("opacity")||1;I?F._opacity=parseInt(255*parseFloat(I)):F._opacity=255,F.offset=cc.p(parseFloat(D.getAttribute("x"))||0,parseFloat(D.getAttribute("y"))||0);var J="";for(e=0;e<E.childNodes.length;e++)J+=E.childNodes[e].nodeValue;J=J.trim();var K=E.getAttribute("compression"),L=E.getAttribute("encoding");if(K&&"gzip"!==K&&"zlib"!==K)return cc.log("cc.TMXMapInfo.parseXMLFile(): unsupported compression method"),null;var w;switch(K){case"gzip":w=cc.unzipBase64AsArray(J,4);break;case"zlib":var M=new Zlib.Inflate(cc.Codec.Base64.decodeAsArray(J,1));w=cc.uint8ArrayToUint32Array(M.decompress());break;case null:case"":if("base64"===L)w=cc.Codec.Base64.decodeAsArray(J,4);else if("csv"===L){w=[];for(var N=J.split(","),O=0;O<N.length;O++)w.push(parseInt(N[O]))}else{var P=E.getElementsByTagName("tile");w=[];for(var Q=0;Q<P.length;Q++)w.push(parseInt(P[Q].getAttribute("gid")))}break;default:this.layerAttrs===cc.TMXLayerInfo.ATTRIB_NONE&&cc.log("cc.TMXMapInfo.parseXMLFile(): Only base64 and/or gzip/zlib maps are supported")}w&&(F._tiles=new Uint32Array(w));var R=D.querySelectorAll("properties > property");if(R){var S={};for(e=0;e<R.length;e++)S[R[e].getAttribute("name")]=R[e].getAttribute("value");F.properties=S}this.setLayers(F)}var T=g.getElementsByTagName("objectgroup");if(T)for(d=0;d<T.length;d++){var U=T[d],V=new cc.TMXObjectGroup;V.groupName=U.getAttribute("name"),V.setPositionOffset(cc.p(parseFloat(U.getAttribute("x"))*this.getTileSize().width||0,parseFloat(U.getAttribute("y"))*this.getTileSize().height||0));var W=U.querySelectorAll("objectgroup > properties > property");if(W)for(e=0;e<W.length;e++){var X={};X[W[e].getAttribute("name")]=W[e].getAttribute("value"),V.properties=X}var Y=U.querySelectorAll("object"),Z=cc.director.getContentScaleFactor();if(Y)for(e=0;e<Y.length;e++){var $=Y[e],_={};_.name=$.getAttribute("name")||"",_.type=$.getAttribute("type")||"",_.width=parseInt($.getAttribute("width"))||0,_.height=parseInt($.getAttribute("height"))||0,_.x=((0|($.getAttribute("x")||0))+V.getPositionOffset().x)/Z;var aa=(0|($.getAttribute("y")||0))+V.getPositionOffset().y/Z;_.y=(parseInt(this.getMapSize().height*this.getTileSize().height)-aa-_.height)/cc.director.getContentScaleFactor(),_.rotation=parseInt($.getAttribute("rotation"))||0;var ba=$.querySelectorAll("properties > property");if(ba)for(var ca=0;ca<ba.length;ca++)_[ba[ca].getAttribute("name")]=ba[ca].getAttribute("value");var da=$.querySelectorAll("polygon");if(da&&da.length>0){var ea=da[0].getAttribute("points");ea&&(_.points=this._parsePointsString(ea))}var fa=$.querySelectorAll("polyline");if(fa&&fa.length>0){var ga=fa[0].getAttribute("points");ga&&(_.polylinePoints=this._parsePointsString(ga))}V.setObjects(_)}this.setObjectGroups(V)}return g},_parsePointsString:function(a){if(!a)return null;for(var b=[],c=a.split(" "),d=0;d<c.length;d++){var e=c[d].split(",");b.push({x:e[0],y:e[1]})}return b},parseXMLString:function(a){return this.parseXMLFile(a,!0)},getTileProperties:function(){return this._tileProperties},setTileProperties:function(a){this._tileProperties.push(a)},getCurrentString:function(){return this.currentString},setCurrentString:function(a){this.currentString=a},getTMXFileName:function(){return this.tmxFileName},setTMXFileName:function(a){this.tmxFileName=a},_internalInit:function(a,b){this._tilesets.length=0,this._layers.length=0,this.tmxFileName=a,b&&(this._resources=b),this._objectGroups.length=0,this.properties.length=0,this._tileProperties.length=0,this.currentString="",this.storingCharacters=!1,this.layerAttrs=cc.TMXLayerInfo.ATTRIB_NONE,this.parentElement=cc.TMX_PROPERTY_NONE,this._currentFirstGID=0}});var _p=cc.TMXMapInfo.prototype;_p.mapWidth,cc.defineGetterSetter(_p,"mapWidth",_p._getMapWidth,_p._setMapWidth),_p.mapHeight,cc.defineGetterSetter(_p,"mapHeight",_p._getMapHeight,_p._setMapHeight),_p.tileWidth,cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth),_p.tileHeight,cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight),cc.TMXMapInfo.create=function(a,b){return new cc.TMXMapInfo(a,b)},cc.loader.register(["tmx","tsx"],cc._txtLoader),cc.TMXLayerInfo.ATTRIB_NONE=1,cc.TMXLayerInfo.ATTRIB_BASE64=2,cc.TMXLayerInfo.ATTRIB_GZIP=4,cc.TMXLayerInfo.ATTRIB_ZLIB=8,cc.TMXObjectGroup=cc.Class.extend({properties:null,groupName:"",_positionOffset:null,_objects:null,ctor:function(){this.groupName="",this._positionOffset=cc.p(0,0),this.properties=[],this._objects=[]},getPositionOffset:function(){return cc.p(this._positionOffset)},setPositionOffset:function(a){this._positionOffset.x=a.x,this._positionOffset.y=a.y},getProperties:function(){return this.properties},setProperties:function(a){this.properties.push(a)},getGroupName:function(){return this.groupName.toString()},setGroupName:function(a){this.groupName=a},propertyNamed:function(a){return this.properties[a]},objectNamed:function(a){return this.getObject(a)},getObject:function(a){if(this._objects&&this._objects.length>0)for(var b=this._objects,c=0,d=b.length;c<d;c++){var e=b[c].name;if(e&&e===a)return b[c]}return null},getObjects:function(){return this._objects},setObjects:function(a){this._objects.push(a)}}),cc.TMXLayer=cc.SpriteBatchNode.extend({tiles:null,tileset:null,layerOrientation:null,properties:null,layerName:"",_textures:null,_texGrids:null,_spriteTiles:null,_layerSize:null,_mapTileSize:null,_opacity:255,_minGID:null,_maxGID:null,_vertexZvalue:null,_useAutomaticVertexZ:null,_reusedTile:null,_atlasIndexArray:null,_contentScaleFactor:null,_className:"TMXLayer",ctor:function(a,b,c){cc.SpriteBatchNode.prototype.ctor.call(this),this._descendants=[],this._layerSize=cc.size(0,0),this._mapTileSize=cc.size(0,0),this._spriteTiles={},void 0!==c&&this.initWithTilesetInfo(a,b,c)},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new cc.TMXLayer.CanvasRenderCmd(this):new cc.TMXLayer.WebGLRenderCmd(this)},_fillTextureGrids:function(a,b){var c=this._textures[b];if(!c.isLoaded())return void c.addEventListener("load",function(){this._fillTextureGrids(a,b)},this);a.imageSize.width&&a.imageSize.height||(a.imageSize.width=c.width,a.imageSize.height=c.height);for(var d=a._tileSize.width,e=a._tileSize.height,f=c._contentSize.width,g=c._contentSize.height,h=a.spacing,i=a.margin,j=Math.floor((f-2*i+h)/(d+h)),k=Math.floor((g-2*i+h)/(e+h)),l=k*j,m=a.firstGid,n=a.firstGid+l,o=this._texGrids,p=null,q=!!o[m];m<n&&(q&&!o[m]&&(q=!1),q||!o[m]);++m)p={texId:b,x:0,y:0,width:d,height:e,t:0,l:0,r:0,b:0},a.rectForGID(m,p),p.t=p.y/g,p.l=p.x/f,p.r=(p.x+p.width)/f,p.b=(p.y+p.height)/g,o[m]=p},initWithTilesetInfo:function(a,b,c){var d=b._layerSize;parseInt(d.width*d.height);this.layerName=b.name,this.tiles=b._tiles,this.properties=b.properties,this._layerSize=d,this._minGID=b._minGID,this._maxGID=b._maxGID,this._opacity=b._opacity,this.tileset=a,this.layerOrientation=c.orientation,this._mapTileSize=c.getTileSize();var e=c._tilesets;if(e){this._textures=[],this._texGrids=[];var f,g,h,i=e.length;for(f=0;f<i;++f)g=e[f],h=cc.textureCache.addImage(g.sourceImage),this._textures.push(h),this._fillTextureGrids(g,f),g===a&&(this._texture=h)}var j=this._calculateLayerOffset(b.offset);return this.setPosition(cc.pointPixelsToPoints(j)),this._parseInternalProperties(),this.setContentSize(cc.sizePixelsToPoints(cc.size(this._layerSize.width*this._mapTileSize.width,this._layerSize.height*this._mapTileSize.height))),this._useAutomaticVertexZ=!1,this._vertexZvalue=0,!0},getLayerSize:function(){return cc.size(this._layerSize.width,this._layerSize.height)},setLayerSize:function(a){this._layerSize.width=a.width,this._layerSize.height=a.height},_getLayerWidth:function(){return this._layerSize.width},_setLayerWidth:function(a){this._layerSize.width=a},_getLayerHeight:function(){return this._layerSize.height},_setLayerHeight:function(a){this._layerSize.height=a},getMapTileSize:function(){return cc.size(this._mapTileSize.width,this._mapTileSize.height)},setMapTileSize:function(a){this._mapTileSize.width=a.width,this._mapTileSize.height=a.height},_getTileWidth:function(){return this._mapTileSize.width},_setTileWidth:function(a){this._mapTileSize.width=a},_getTileHeight:function(){return this._mapTileSize.height},_setTileHeight:function(a){this._mapTileSize.height=a},getTiles:function(){return this.tiles},setTiles:function(a){this.tiles=a},getTileset:function(){return this.tileset},setTileset:function(a){this.tileset=a},getLayerOrientation:function(){return this.layerOrientation},setLayerOrientation:function(a){this.layerOrientation=a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},getLayerName:function(){return this.layerName},setLayerName:function(a){this.layerName=a},releaseMap:function(){this._spriteTiles={}},getTileAt:function(a,b){if(void 0===a)throw new Error("cc.TMXLayer.getTileAt(): pos should be non-null");var c=a;if(void 0===b&&(c=a.x,b=a.y),c>=this._layerSize.width||b>=this._layerSize.height||c<0||b<0)throw new Error("cc.TMXLayer.getTileAt(): invalid position");if(!this.tiles)return cc.log("cc.TMXLayer.getTileAt(): TMXLayer: the tiles map has been released"),null;var d=null,e=this.getTileGIDAt(c,b);if(0===e)return d;var f=0|c+b*this._layerSize.width;if(d=this._spriteTiles[f],!d){var g=this._texGrids[e],h=this._textures[g.texId];g=cc.rectPixelsToPoints(g),d=new cc.Sprite(h,g),d.setPosition(this.getPositionAt(c,b));var i=this._vertexZForPos(c,b);d.setVertexZ(i),d.setAnchorPoint(0,0),d.setOpacity(this._opacity),this.addChild(d,i,f)}return d},getTileGIDAt:function(a,b){if(void 0===a)throw new Error("cc.TMXLayer.getTileGIDAt(): pos should be non-null");var c=a;if(void 0===b&&(c=a.x,b=a.y),c>=this._layerSize.width||b>=this._layerSize.height||c<0||b<0)throw new Error("cc.TMXLayer.getTileGIDAt(): invalid position");if(!this.tiles)return cc.log("cc.TMXLayer.getTileGIDAt(): TMXLayer: the tiles map has been released"),null;var d=0|c+b*this._layerSize.width,e=this.tiles[d];return(e&cc.TMX_TILE_FLIPPED_MASK)>>>0},setTileGID:function(a,b,c,d){if(void 0===b)throw new Error("cc.TMXLayer.setTileGID(): pos should be non-null");var e;if(void 0!==d?e=cc.p(b,c):(e=b,d=c),e.x>=this._layerSize.width||e.y>=this._layerSize.height||e.x<0||e.y<0)throw new Error("cc.TMXLayer.setTileGID(): invalid position");if(!this.tiles)return void cc.log("cc.TMXLayer.setTileGID(): TMXLayer: the tiles map has been released");if(0!==a&&a<this.tileset.firstGid)return void cc.log("cc.TMXLayer.setTileGID(): invalid gid:"+a);d=d||0;var f=this.getTileFlagsAt(e),g=this.getTileGIDAt(e);if(g!==a||f!==d){var h=(a|d)>>>0;if(0===a)this.removeTileAt(e);else if(0===g)this._updateTileForGID(h,e);else{var i=e.x+e.y*this._layerSize.width,j=this.getChildByTag(i);if(j){var k=this._texGrids[a],l=this._textures[k.texId];k=cc.rectPixelsToPoints(k),j.setTexture(l),j.setTextureRect(k,!1),null!=d&&this._setupTileSprite(j,e,h),this.tiles[i]=h}else this._updateTileForGID(h,e)}}},addChild:function(a,b,c){cc.Node.prototype.addChild.call(this,a,b,c),void 0!==c&&(this._spriteTiles[c]=a,a._vertexZ=this._vertexZ+cc.renderer.assignedZStep*c/this.tiles.length)},removeChild:function(a,b){this._spriteTiles[a.tag]&&(this._spriteTiles[a.tag]=null),cc.Node.prototype.removeChild.call(this,a,b)},getTileFlagsAt:function(a,b){if(!a)throw new Error("cc.TMXLayer.getTileFlagsAt(): pos should be non-null");if(void 0!==b&&(a=cc.p(a,b)),a.x>=this._layerSize.width||a.y>=this._layerSize.height||a.x<0||a.y<0)throw new Error("cc.TMXLayer.getTileFlagsAt(): invalid position");if(!this.tiles)return cc.log("cc.TMXLayer.getTileFlagsAt(): TMXLayer: the tiles map has been released"),null;var c=0|a.x+a.y*this._layerSize.width,d=this.tiles[c];return(d&cc.TMX_TILE_FLIPPED_ALL)>>>0},removeTileAt:function(a,b){if(!a)throw new Error("cc.TMXLayer.removeTileAt(): pos should be non-null");if(void 0!==b&&(a=cc.p(a,b)),a.x>=this._layerSize.width||a.y>=this._layerSize.height||a.x<0||a.y<0)throw new Error("cc.TMXLayer.removeTileAt(): invalid position");if(!this.tiles)return void cc.log("cc.TMXLayer.removeTileAt(): TMXLayer: the tiles map has been released");var c=this.getTileGIDAt(a);if(0!==c){var d=0|a.x+a.y*this._layerSize.width;this.tiles[d]=0;var e=this._spriteTiles[d];e&&this.removeChild(e,!0)}},getPositionAt:function(a,b){void 0!==b&&(a=cc.p(a,b));var c=cc.p(0,0);switch(this.layerOrientation){case cc.TMX_ORIENTATION_ORTHO:c=this._positionForOrthoAt(a);break;case cc.TMX_ORIENTATION_ISO:c=this._positionForIsoAt(a);break;case cc.TMX_ORIENTATION_HEX:c=this._positionForHexAt(a)}return cc.pointPixelsToPoints(c)},_positionForIsoAt:function(a){return cc.p(this._mapTileSize.width/2*(this._layerSize.width+a.x-a.y-1),this._mapTileSize.height/2*(2*this._layerSize.height-a.x-a.y-2))},_positionForOrthoAt:function(a){return cc.p(a.x*this._mapTileSize.width,(this._layerSize.height-a.y-1)*this._mapTileSize.height)},_positionForHexAt:function(a){var b=a.x%2===1?-this._mapTileSize.height/2:0;return cc.p(a.x*this._mapTileSize.width*3/4,(this._layerSize.height-a.y-1)*this._mapTileSize.height+b)},_calculateLayerOffset:function(a){var b=cc.p(0,0);switch(this.layerOrientation){case cc.TMX_ORIENTATION_ORTHO:b=cc.p(a.x*this._mapTileSize.width,-a.y*this._mapTileSize.height);break;case cc.TMX_ORIENTATION_ISO:b=cc.p(this._mapTileSize.width/2*(a.x-a.y),this._mapTileSize.height/2*(-a.x-a.y));break;case cc.TMX_ORIENTATION_HEX:0===a.x&&0===a.y||cc.log("offset for hexagonal map not implemented yet")}return b},_updateTileForGID:function(a,b){if(this._texGrids[a]){var c=0|b.x+b.y*this._layerSize.width;c<this.tiles.length&&(this.tiles[c]=a)}},_parseInternalProperties:function(){var a=this.getProperty("cc_vertexz");if(a)if("automatic"===a){this._useAutomaticVertexZ=!0;var b=this.getProperty("cc_alpha_func"),c=0;b&&(c=parseFloat(b)),cc._renderType===cc.game.RENDER_TYPE_WEBGL&&(this.shaderProgram=cc.shaderCache.programForKey(cc.SHADER_SPRITE_POSITION_TEXTURECOLORALPHATEST),this.shaderProgram.use(),this.shaderProgram.setUniformLocationWith1f(cc.UNIFORM_ALPHA_TEST_VALUE_S,c))}else this._vertexZvalue=parseInt(a,10)},_setupTileSprite:function(a,b,c){var d=(b.x+b.y*this._layerSize.width,this.getPositionAt(b));if(a.setPosition(d),a.setVertexZ(this._vertexZForPos(b)),a.setAnchorPoint(0,0),a.setOpacity(this._opacity),a.setFlippedX(!1),a.setFlippedY(!1),a.setRotation(0),(c&cc.TMX_TILE_DIAGONAL_FLAG)>>>0){a.setAnchorPoint(.5,.5),a.setPosition(d.x+a.width/2,d.y+a.height/2);var e=(c&(cc.TMX_TILE_HORIZONTAL_FLAG|cc.TMX_TILE_VERTICAL_FLAG)>>>0)>>>0;e===cc.TMX_TILE_HORIZONTAL_FLAG?a.setRotation(90):e===cc.TMX_TILE_VERTICAL_FLAG?a.setRotation(270):e===(cc.TMX_TILE_VERTICAL_FLAG|cc.TMX_TILE_HORIZONTAL_FLAG)>>>0?(a.setRotation(90),a.setFlippedX(!0)):(a.setRotation(270),a.setFlippedX(!0))}else(c&cc.TMX_TILE_HORIZONTAL_FLAG)>>>0&&a.setFlippedX(!0),(c&cc.TMX_TILE_VERTICAL_FLAG)>>>0&&a.setFlippedY(!0)},_vertexZForPos:function(a,b){void 0===b&&(b=a.y,a=a.x);var c=0,d=0;if(this._useAutomaticVertexZ)switch(this.layerOrientation){case cc.TMX_ORIENTATION_ISO:d=this._layerSize.width+this._layerSize.height,c=-(d-(a+b));break;case cc.TMX_ORIENTATION_ORTHO:c=-(this._layerSize.height-b);break;case cc.TMX_ORIENTATION_HEX:cc.log("TMX Hexa zOrder not supported");break;default:cc.log("TMX invalid value")}else c=this._vertexZvalue;return c}});var _p=cc.TMXLayer.prototype;_p.layerWidth,cc.defineGetterSetter(_p,"layerWidth",_p._getLayerWidth,_p._setLayerWidth),_p.layerHeight,cc.defineGetterSetter(_p,"layerHeight",_p._getLayerHeight,_p._setLayerHeight),_p.tileWidth,cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth),_p.tileHeight,cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight),cc.TMXLayer.create=function(a,b,c){return new cc.TMXLayer(a,b,c)},function(){cc.TMXLayer.CanvasRenderCmd=function(a){cc.Node.CanvasRenderCmd.call(this,a),this._needDraw=!0};var a=cc.TMXLayer.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);a.constructor=cc.TMXLayer.CanvasRenderCmd,a.visit=function(a){var b=this._node,c=cc.renderer;if(a=a||this.getParentRenderCmd(),a&&(this._curLevel=a._curLevel+1),b._visible){isNaN(b._customZ)&&(b._vertexZ=c.assignedZ,c.assignedZ+=c.assignedZStep),this._syncStatus(a);var d,e,f=b._children,g=b._spriteTiles,h=f.length;if(h>0){for(b.sortAllChildren(),e=0;e<h&&(d=f[e],d._localZOrder<0);e++)d._renderCmd.visit(this);for(c.pushRenderCommand(this);e<h;e++)d=f[e],0===d._localZOrder&&g[d.tag]?(isNaN(d._customZ)&&(d._vertexZ=c.assignedZ,c.assignedZ+=c.assignedZStep),d._renderCmd.updateStatus()):d._renderCmd.visit(this)}else c.pushRenderCommand(this);this._dirtyFlag=0}},a.rendering=function(a,b,c){var d=this._node,e=d._rotationX||d._rotationY,f=d.layerOrientation,g=d.tiles,h=d._opacity/255;if(g&&!(h<=0)){var i=d._mapTileSize.width,j=d._mapTileSize.height,k=d.tileset._tileSize.width/cc.director._contentScaleFactor,l=d.tileset._tileSize.height/cc.director._contentScaleFactor,m=k-i,n=l-j,o=cc.winSize.width,p=cc.winSize.height,q=d._layerSize.height,r=d._layerSize.width,s=d._texGrids,t=d._spriteTiles,u=this._worldTransform,v=-d._contentSize.width*d._anchorPoint.x,w=-d._contentSize.height*d._anchorPoint.y,x=u.a,y=u.b,z=u.c,A=u.d,B=v*x+w*z+u.tx,C=v*y+w*A+u.ty,D=a||cc._renderContext,E=D.getContext(),F=0,G=0,H=r,I=q;e||f!==cc.TMX_ORIENTATION_ORTHO||(F=Math.floor(-(B-m*x)/(i*x)),
G=Math.floor((C-n*A+j*q*A-p)/(j*A)),H=Math.ceil((o-B+m*x)/(i*x)),I=q-Math.floor(-(C+n*A)/(j*A)),F<0&&(F=0),G<0&&(G=0),H>r&&(H=r),I>q&&(I=q));var J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z=G*r,$=cc.TMX_TILE_FLIPPED_MASK,_=k,aa=l,ba=k*x,ca=l*A,da=!1,ea=!1;M=Z+F;for(J in t)if(J<M&&t[J])Q=t[J]._renderCmd,0===t[J]._localZOrder&&Q.rendering&&Q.rendering(a,b,c);else if(J>=M)break;for(D.setTransform(u,b,c),D.setGlobalAlpha(h),K=G;K<I;++K){for(L=F;L<H;++L)if(M=Z+L,t[M])Q=t[M]._renderCmd,0===t[M]._localZOrder&&Q.rendering&&(Q.rendering(a,b,c),D.setTransform(u,b,c),D.setGlobalAlpha(h));else if(N=d.tiles[M],O=s[(N&$)>>>0],O&&(P=d._textures[O.texId],P&&P._htmlElementObj)){switch(f){case cc.TMX_ORIENTATION_ORTHO:S=L*i,T=-(q-K-1)*j;break;case cc.TMX_ORIENTATION_ISO:S=i/2*(r+L-K-1),T=-j/2*(2*q-L-K-2);break;case cc.TMX_ORIENTATION_HEX:S=L*i*3/4,T=-(q-K-1)*j+(L%2===1?-j/2:0)}if(U=S+k,R=T-l,!e&&f===cc.TMX_ORIENTATION_ISO){if(X=-C+T*A,X<-p-ca){L+=Math.floor(2*(-p-X)/ca)-1;continue}if(Y=B+U*x,Y<-ba){L+=Math.floor(2*-Y/ba)-1;continue}if(W=B+S*x,V=-C+R*A,W>o||V>0){L=H;continue}}N>cc.TMX_TILE_DIAGONAL_FLAG&&(da=(N&cc.TMX_TILE_HORIZONTAL_FLAG)>>>0,ea=(N&cc.TMX_TILE_VERTICAL_FLAG)>>>0),da&&(S=-U,E.scale(-1,1)),ea&&(R=-T,E.scale(1,-1)),E.drawImage(P._htmlElementObj,O.x,O.y,O.width,O.height,S,R,_,aa),da&&E.scale(-1,1),ea&&E.scale(1,-1),cc.g_NumberOfDraws++}Z+=r}for(J in t)J>M&&t[J]&&(Q=t[J]._renderCmd,0===t[J]._localZOrder&&Q.rendering&&Q.rendering(a,b,c))}}}();