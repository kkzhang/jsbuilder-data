!function(){var a=8;cc.ProgressTimer.WebGLRenderCmd=function(a){cc.Node.WebGLRenderCmd.call(this,a),this._needDraw=!0,this._progressDirty=!0,this._bl=cc.p(),this._tr=cc.p(),this.initCmd()};var b=cc.ProgressTimer.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);b.constructor=cc.ProgressTimer.WebGLRenderCmd,b.transform=function(a,b){this.originTransform(a,b);var c=this._node._sprite;c._renderCmd.transform(this,b);var d=c._offsetPosition.x,e=d+c._rect.width,f=c._offsetPosition.y,g=f+c._rect.height,h=this._worldTransform;this._bl.x=d*h.a+f*h.c+h.tx,this._bl.y=d*h.b+f*h.d+h.ty,this._tr.x=e*h.a+g*h.c+h.tx,this._tr.y=e*h.b+g*h.d+h.ty},b.rendering=function(a){var b=this._node,c=a||cc._renderContext;if(0!==this._vertexDataCount&&b._sprite){this._shaderProgram.use(),this._shaderProgram._updateProjectionUniform();var d=b._sprite._blendFunc;cc.glBlendFunc(d.src,d.dst),cc.glBindTexture2D(b._sprite.texture),c.bindBuffer(c.ARRAY_BUFFER,this._vertexWebGLBuffer),c.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION),c.enableVertexAttribArray(cc.VERTEX_ATTRIB_COLOR),c.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS),this._vertexDataDirty&&(c.bufferSubData(c.ARRAY_BUFFER,0,this._float32View),this._vertexDataDirty=!1);var e=cc.V3F_C4B_T2F.BYTES_PER_ELEMENT;c.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION,3,c.FLOAT,!1,e,0),c.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR,4,c.UNSIGNED_BYTE,!0,e,12),c.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS,2,c.FLOAT,!1,e,16),b._type===cc.ProgressTimer.TYPE_RADIAL?c.drawArrays(c.TRIANGLE_FAN,0,this._vertexDataCount):b._type===cc.ProgressTimer.TYPE_BAR&&(b._reverseDirection?(c.drawArrays(c.TRIANGLE_STRIP,0,this._vertexDataCount/2),c.drawArrays(c.TRIANGLE_STRIP,4,this._vertexDataCount/2),cc.g_NumberOfDraws++):c.drawArrays(c.TRIANGLE_STRIP,0,this._vertexDataCount)),cc.g_NumberOfDraws++}},b._syncStatus=function(a){var b=this._node;if(b._sprite){var c=cc.Node._dirtyFlags,d=this._dirtyFlag,e=a?a._node:null;e&&e._cascadeColorEnabled&&a._dirtyFlag&c.colorDirty&&(d|=c.colorDirty),e&&e._cascadeOpacityEnabled&&a._dirtyFlag&c.opacityDirty&&(d|=c.opacityDirty),a&&a._dirtyFlag&c.transformDirty&&(d|=c.transformDirty),this._dirtyFlag=d;var f=b._sprite._renderCmd,g=f._dirtyFlag,h=(d|g)&c.colorDirty,i=(d|g)&c.opacityDirty;h&&(f._syncDisplayColor(),f._dirtyFlag=f._dirtyFlag&c.colorDirty^f._dirtyFlag,this._dirtyFlag=this._dirtyFlag&c.colorDirty^this._dirtyFlag),i&&(f._syncDisplayOpacity(),f._dirtyFlag=f._dirtyFlag&c.opacityDirty^f._dirtyFlag,this._dirtyFlag=this._dirtyFlag&c.opacityDirty^this._dirtyFlag),(h||i)&&this._updateColor(),d&c.transformDirty&&this.transform(a),d&c.textureDirty&&(this._updateProgressData(),this._dirtyFlag=this._dirtyFlag&c.textureDirty^this._dirtyFlag),f._dirtyFlag=0}},b.updateStatus=function(){var a=this._node;if(a._sprite){var b=cc.Node._dirtyFlags,c=this._dirtyFlag,d=a._sprite._renderCmd,e=d._dirtyFlag,f=(c|e)&b.colorDirty,g=(c|e)&b.opacityDirty;f&&(d._updateDisplayColor(),d._dirtyFlag=d._dirtyFlag&b.colorDirty^d._dirtyFlag,this._dirtyFlag=this._dirtyFlag&b.colorDirty^this._dirtyFlag),g&&(d._updateDisplayOpacity(),d._dirtyFlag=d._dirtyFlag&b.opacityDirty^d._dirtyFlag,this._dirtyFlag=this._dirtyFlag&b.opacityDirty^this._dirtyFlag),(f||g)&&this._updateColor(),c&b.transformDirty&&this.transform(this.getParentRenderCmd(),!0),c&b.orderDirty&&(this._dirtyFlag=this._dirtyFlag&b.orderDirty^this._dirtyFlag),c&b.textureDirty&&(this._updateProgressData(),this._dirtyFlag=this._dirtyFlag&b.textureDirty^this._dirtyFlag)}},b.releaseData=function(){if(this._vertexData){var a=this._vertexWebGLBuffer;setTimeout(function(){cc._renderContext.deleteBuffer(a)},.1),this._vertexWebGLBuffer=null,this._vertexData=null,this._float32View=null,this._vertexArrayBuffer=null,this._vertexDataCount=0}},b.initCmd=function(){if(!this._vertexData){this._vertexWebGLBuffer=cc._renderContext.createBuffer();var b=cc.V3F_C4B_T2F.BYTES_PER_ELEMENT;this._vertexArrayBuffer=new ArrayBuffer(a*b),this._float32View=new Float32Array(this._vertexArrayBuffer),this._vertexData=[];for(var c=0;a>c;c++)this._vertexData[c]=new cc.V3F_C4B_T2F(null,null,null,this._vertexArrayBuffer,c*b);gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexWebGLBuffer),gl.bufferData(gl.ARRAY_BUFFER,this._float32View,gl.DYNAMIC_DRAW),this._vertexDataCount=0,this._vertexDataDirty=!0,this._shaderProgram=cc.shaderCache.programForKey(cc.SHADER_SPRITE_POSITION_TEXTURECOLOR)}},b.resetVertexData=function(){this._vertexDataCount=0},b._updateProgressData=function(){var a=this._node,b=a._type;b===cc.ProgressTimer.TYPE_RADIAL?this._updateRadial():b===cc.ProgressTimer.TYPE_BAR&&this._updateBar(),this._vertexDataDirty=!0},b._updateProgress=function(){this.setDirtyFlag(cc.Node._dirtyFlags.textureDirty)},b._updateBar=function(){var a=this._node;if(a._sprite){var b=a._percentage/100,c=a._barChangeRate,d=cc.pMult(cc.p(1-c.x+b*c.x,1-c.y+b*c.y),.5),e=cc.pSub(a._midPoint,d),f=cc.pAdd(a._midPoint,d);e.x<0&&(f.x+=-e.x,e.x=0),f.x>1&&(e.x-=f.x-1,f.x=1),e.y<0&&(f.y+=-e.y,e.y=0),f.y>1&&(e.y-=f.y-1,f.y=1);var g;this._reverseDirection?(g=this._vertexData,this._vertexDataCount||(this._vertexDataCount=8,this._textureCoordFromAlphaPoint(g[0].texCoords,0,1),this._vertexFromAlphaPoint(g[0].vertices,0,1),this._textureCoordFromAlphaPoint(g[1].texCoords,0,0),this._vertexFromAlphaPoint(g[1].vertices,0,0),this._textureCoordFromAlphaPoint(g[6].texCoords,1,1),this._vertexFromAlphaPoint(g[6].vertices,1,1),this._textureCoordFromAlphaPoint(g[7].texCoords,1,0),this._vertexFromAlphaPoint(g[7].vertices,1,0)),this._textureCoordFromAlphaPoint(g[2].texCoords,e.x,f.y),this._vertexFromAlphaPoint(g[2].vertices,e.x,f.y),this._textureCoordFromAlphaPoint(g[3].texCoords,e.x,e.y),this._vertexFromAlphaPoint(g[3].vertices,e.x,e.y),this._textureCoordFromAlphaPoint(g[4].texCoords,f.x,f.y),this._vertexFromAlphaPoint(g[4].vertices,f.x,f.y),this._textureCoordFromAlphaPoint(g[5].texCoords,f.x,e.y),this._vertexFromAlphaPoint(g[5].vertices,f.x,e.y)):(this._vertexDataCount||(this._vertexDataCount=4),g=this._vertexData,this._textureCoordFromAlphaPoint(g[0].texCoords,e.x,f.y),this._vertexFromAlphaPoint(g[0].vertices,e.x,f.y),this._textureCoordFromAlphaPoint(g[1].texCoords,e.x,e.y),this._vertexFromAlphaPoint(g[1].vertices,e.x,e.y),this._textureCoordFromAlphaPoint(g[2].texCoords,f.x,f.y),this._vertexFromAlphaPoint(g[2].vertices,f.x,f.y),this._textureCoordFromAlphaPoint(g[3].texCoords,f.x,e.y),this._vertexFromAlphaPoint(g[3].vertices,f.x,e.y)),this._updateColor()}},b._updateRadial=function(){var a=this._node;if(a._sprite){var b,c,d=a._midPoint,e=a._percentage/100,f=2*cc.PI*(a._reverseDirection?e:1-e),g=cc.p(d.x,1),h=cc.pRotateByAngle(g,d,f),i=0;if(0===e)c=g,i=0;else if(1===e)c=g,i=4;else{var j=cc.FLT_MAX,k=cc.ProgressTimer.TEXTURE_COORDS_COUNT;for(b=0;k>=b;++b){var l=(b+(k-1))%k,m=this._boundaryTexCoord(b%k),n=this._boundaryTexCoord(l);0===b?n=cc.pLerp(m,n,1-d.x):4===b&&(m=cc.pLerp(m,n,1-d.x));var o=cc.p(0,0);if(cc.pLineIntersect(m,n,d,h,o)){if(!(0!==b&&4!==b||0<=o.x&&o.x<=1))continue;o.y>=0&&o.y<j&&(j=o.y,i=b)}}c=cc.pAdd(d,cc.pMult(cc.pSub(h,d),j))}var p=!0;this._vertexDataCount!==i+3&&(p=!1,this._vertexDataCount=i+3),this._updateColor();var q=this._vertexData;if(!p)for(this._textureCoordFromAlphaPoint(q[0].texCoords,d.x,d.y),this._vertexFromAlphaPoint(q[0].vertices,d.x,d.y),this._textureCoordFromAlphaPoint(q[1].texCoords,g.x,g.y),this._vertexFromAlphaPoint(q[1].vertices,g.x,g.y),b=0;i>b;b++){var r=this._boundaryTexCoord(b);this._textureCoordFromAlphaPoint(q[b+2].texCoords,r.x,r.y),this._vertexFromAlphaPoint(q[b+2].vertices,r.x,r.y)}this._textureCoordFromAlphaPoint(q[this._vertexDataCount-1].texCoords,c.x,c.y),this._vertexFromAlphaPoint(q[this._vertexDataCount-1].vertices,c.x,c.y)}},b._boundaryTexCoord=function(a){if(a<cc.ProgressTimer.TEXTURE_COORDS_COUNT){var b=cc.ProgressTimer.TEXTURE_COORDS;return this._node._reverseDirection?cc.p(b>>7-(a<<1)&1,b>>7-((a<<1)+1)&1):cc.p(b>>(a<<1)+1&1,b>>(a<<1)&1)}return cc.p(0,0)},b._textureCoordFromAlphaPoint=function(a,b,c){var d=this._node._sprite;if(!d)return a.u=0,void(a.v=0);var e=d._renderCmd._vertices,f=e[1],g=e[2],h=cc.p(f.u,f.v),i=cc.p(g.u,g.v);if(d.textureRectRotated){var j=b;b=c,c=j}a.u=h.x*(1-b)+i.x*b,a.v=h.y*(1-c)+i.y*c},b._vertexFromAlphaPoint=function(a,b,c){a.x=this._bl.x*(1-b)+this._tr.x*b,a.y=this._bl.y*(1-c)+this._tr.y*c,a.z=this._node._vertexZ},b._updateColor=function(){var a=this._node._sprite;if(this._vertexDataCount&&a){var b=this._displayedColor,c=a._renderCmd._displayedColor,d=c.r,e=c.g,f=c.b,g=a._renderCmd._displayedOpacity/255;a._opacityModifyRGB&&(d*=g,e*=g,f*=g),b.r=d,b.g=e,b.b=f,b.a=a._renderCmd._displayedOpacity;for(var h=this._vertexData,i=0,j=this._vertexDataCount;j>i;++i)h[i].colors=b;this._vertexDataDirty=!0}}}();