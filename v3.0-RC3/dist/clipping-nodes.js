cc.stencilBits=-1,cc.setProgram=function(a,b){a.shaderProgram=b;var c=a.children;if(c)for(var d=0;d<c.length;d++)cc.setProgram(c[d],b)},cc.ClippingNode=cc.Node.extend({alphaThreshold:0,inverted:!1,_stencil:null,_godhelpme:!1,ctor:function(a){cc.Node.prototype.ctor.call(this),this._stencil=null,this.alphaThreshold=0,this.inverted=!1,a=a||null,cc.ClippingNode.prototype.init.call(this,a)},init:null,_className:"ClippingNode",_initForWebGL:function(a){return this._stencil=a,this.alphaThreshold=1,this.inverted=!1,cc.ClippingNode._init_once=!0,cc.ClippingNode._init_once&&(cc.stencilBits=cc._renderContext.getParameter(cc._renderContext.STENCIL_BITS),cc.stencilBits<=0&&cc.log("Stencil buffer is not enabled."),cc.ClippingNode._init_once=!1),!0},_initForCanvas:function(a){this._stencil=a,this.alphaThreshold=1,this.inverted=!1},onEnter:function(){cc.Node.prototype.onEnter.call(this),this._stencil.onEnter()},onEnterTransitionDidFinish:function(){cc.Node.prototype.onEnterTransitionDidFinish.call(this),this._stencil.onEnterTransitionDidFinish()},onExitTransitionDidStart:function(){this._stencil.onExitTransitionDidStart(),cc.Node.prototype.onExitTransitionDidStart.call(this)},onExit:function(){this._stencil.onExit(),cc.Node.prototype.onExit.call(this)},visit:null,_visitForWebGL:function(a){var b=a||cc._renderContext;if(cc.stencilBits<1)return void cc.Node.prototype.visit.call(this,a);if(!this._stencil||!this._stencil.visible)return void(this.inverted&&cc.Node.prototype.visit.call(this,a));if(cc.ClippingNode._layer+1==cc.stencilBits)return cc.ClippingNode._visit_once=!0,cc.ClippingNode._visit_once&&(cc.log("Nesting more than "+cc.stencilBits+"stencils is not supported. Everything will be drawn without stencil for this node and its childs."),cc.ClippingNode._visit_once=!1),void cc.Node.prototype.visit.call(this,a);cc.ClippingNode._layer++;var c=1<<cc.ClippingNode._layer,d=c-1,e=c|d,f=b.isEnabled(b.STENCIL_TEST),g=b.getParameter(b.STENCIL_WRITEMASK),h=b.getParameter(b.STENCIL_FUNC),i=b.getParameter(b.STENCIL_REF),j=b.getParameter(b.STENCIL_VALUE_MASK),k=b.getParameter(b.STENCIL_FAIL),l=b.getParameter(b.STENCIL_PASS_DEPTH_FAIL),m=b.getParameter(b.STENCIL_PASS_DEPTH_PASS);b.enable(b.STENCIL_TEST),b.stencilMask(c);var n=b.getParameter(b.DEPTH_WRITEMASK);if(b.depthMask(!1),b.stencilFunc(b.NEVER,c,c),b.stencilOp(this.inverted?b.REPLACE:b.ZERO,b.KEEP,b.KEEP),cc.kmGLMatrixMode(cc.KM_GL_PROJECTION),cc.kmGLPushMatrix(),cc.kmGLLoadIdentity(),cc.kmGLMatrixMode(cc.KM_GL_MODELVIEW),cc.kmGLPushMatrix(),cc.kmGLLoadIdentity(),cc._drawingUtil.drawSolidRect(cc.p(-1,-1),cc.p(1,1),cc.color(255,255,255,255)),cc.kmGLMatrixMode(cc.KM_GL_PROJECTION),cc.kmGLPopMatrix(),cc.kmGLMatrixMode(cc.KM_GL_MODELVIEW),cc.kmGLPopMatrix(),b.stencilFunc(b.NEVER,c,c),b.stencilOp(this.inverted?b.ZERO:b.REPLACE,b.KEEP,b.KEEP),this.alphaThreshold<1){var o=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLORALPHATEST),p=b.getUniformLocation(o.getProgram(),cc.UNIFORM_ALPHA_TEST_VALUE_S);cc.glUseProgram(o.getProgram()),o.setUniformLocationWith1f(p,this.alphaThreshold),cc.setProgram(this._stencil,o)}cc.kmGLPushMatrix(),this.transform(),this._stencil.visit(),cc.kmGLPopMatrix(),b.depthMask(n),b.stencilFunc(b.EQUAL,e,e),b.stencilOp(b.KEEP,b.KEEP,b.KEEP),cc.Node.prototype.visit.call(this,a),b.stencilFunc(h,i,j),b.stencilOp(k,l,m),b.stencilMask(g),f||b.disable(b.STENCIL_TEST),cc.ClippingNode._layer--},_visitForCanvas:function(a){if(!this._stencil||!this._stencil.visible)return void(this.inverted&&cc.Node.prototype.visit.call(this,a));var b=a||cc._renderContext,c=b.canvas;if(this._cangodhelpme()||this._stencil instanceof cc.Sprite){var d=cc.ClippingNode._getSharedCache();d.width=c.width,d.height=c.height;var e=d.getContext("2d");e.drawImage(c,0,0),b.save(),cc.Node.prototype.visit.call(this,b),b.globalCompositeOperation=this.inverted?"destination-out":"destination-in",this.transform(b),this._stencil.visit(),b.restore(),b.save(),b.setTransform(1,0,0,1,0,0),b.globalCompositeOperation="destination-over",b.drawImage(d,0,0),b.restore()}else{var f,g,h=this._children;b.save(),this.transform(b),this._stencil.visit(b),this.inverted&&(b.save(),b.setTransform(1,0,0,1,0,0),b.moveTo(0,0),b.lineTo(0,c.height),b.lineTo(c.width,c.height),b.lineTo(c.width,0),b.lineTo(0,0),b.restore()),b.clip(),this._cangodhelpme(!0);var i=h.length;if(i>0){for(this.sortAllChildren(),f=0;i>f&&(g=h[f],g._localZOrder<0);f++)g.visit(b);for(this.draw(b);i>f;f++)h[f].visit(b)}else this.draw(b);this._cangodhelpme(!1),b.restore()}},getStencil:function(){return this._stencil},setStencil:null,_setStencilForWebGL:function(a){this._stencil=a},_setStencilForCanvas:function(a){this._stencil=a;var b=cc._renderContext;a instanceof cc.Sprite||a instanceof cc.DrawNode&&(a.draw=function(){var c=cc.view.getScaleX(),d=cc.view.getScaleY();b.beginPath();for(var e=0;e<a._buffer.length;e++){var f=a._buffer[e],g=f.verts,h=g[0];b.moveTo(h.x*c,-h.y*d);for(var i=1,j=g.length;j>i;i++)b.lineTo(g[i].x*c,-g[i].y*d)}})},getAlphaThreshold:function(){return this.alphaThreshold},setAlphaThreshold:function(a){this.alphaThreshold=a},isInverted:function(){return this.inverted},setInverted:function(a){this.inverted=a},_cangodhelpme:function(a){return(a===!0||a===!1)&&(cc.ClippingNode.prototype._godhelpme=a),cc.ClippingNode.prototype._godhelpme}});var _p=cc.ClippingNode.prototype;cc._renderType===cc._RENDER_TYPE_WEBGL?(_p.init=_p._initForWebGL,_p.visit=_p._visitForWebGL,_p.setStencil=_p._setStencilForWebGL):(_p.init=_p._initForCanvas,_p.visit=_p._visitForCanvas,_p.setStencil=_p._setStencilForCanvas),cc.defineGetterSetter(_p,"stencil",_p.getStencil,_p.setStencil),_p.stencil,cc.ClippingNode._init_once=null,cc.ClippingNode._visit_once=null,cc.ClippingNode._layer=-1,cc.ClippingNode._sharedCache=null,cc.ClippingNode._getSharedCache=function(){return cc.ClippingNode._sharedCache||(cc.ClippingNode._sharedCache=document.createElement("canvas"))},cc.ClippingNode.create=function(a){return new cc.ClippingNode(a)};