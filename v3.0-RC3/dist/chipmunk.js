!function(){Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b};var a;"undefined"==typeof exports?(a={},"object"==typeof window&&(window.cp=a)):a=exports;var b,c,d=function(a,b){if(!a)throw new Error("Assertion failed: "+b)},e=function(a,b){!a&&console&&console.warn&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},f=function(a,b){return b>a?a:b},g=function(a,b){return a>b?a:b};"object"==typeof window&&window.navigator.userAgent.indexOf("Firefox")>-1?(b=Math.min,c=Math.max):(b=f,c=g);var h=function(a,b){return b>a?a+" "+b:b+" "+a},i=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return a[c]=a[a.length-1],void a.length--},j=(a.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+D(d))},a.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)},a.momentForSegment=function(a,b,c){var d=s(u(c,b)),e=w(t(b,c),.5);return a*(d*d/12+D(e))},a.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*I(a,b))},a.momentForPoly=function(a,b,c){for(var d=0,e=0,f=b.length,g=0;f>g;g+=2){var h=b[g]+c.x,i=b[g+1]+c.y,j=b[(g+2)%f]+c.x,k=b[(g+3)%f]+c.y,l=y(j,k,h,i),m=r(h,i,h,i)+r(h,i,j,k)+r(j,k,j,k);d+=l*m,e+=l}return a*d/(6*e)},a.areaForPoly=function(a){for(var b=0,c=0,d=a.length;d>c;c+=2)b+=x(new o(a[c],a[c+1]),new o(a[(c+2)%d],a[(c+3)%d]));return-b/2},a.centroidForPoly=function(a){for(var b=0,c=new o(0,0),d=0,e=a.length;e>d;d+=2){var f=new o(a[d],a[d+1]),g=new o(a[(d+2)%e],a[(d+3)%e]),h=x(f,g);b+=h,c=t(c,w(t(f,g),h))}return w(c,1/(3*b))}),k=(a.recenterPoly=function(a){for(var b=j(a),c=0;c<a.length;c+=2)a[c]-=b.x,a[c+1]-=b.y},a.momentForBox=function(a,b,c){return a*(b*b+c*c)/12}),l=(a.momentForBox2=function(a,b){return width=b.r-b.l,height=b.t-b.b,offset=w([b.l+b.r,b.b+b.t],.5),k(a,width,height)+a*D(offset)},function(a,d,e){return b(c(a,d),e)}),m=a.clamp01=function(a){return c(0,b(a,1))},n=0,o=a.Vect=function(a,b){this.x=a,this.y=b,n++};a.v=function(a,b){return new o(a,b)};var p=a.vzero=new o(0,0),q=a.v.dot=function(a,b){return a.x*b.x+a.y*b.y},r=function(a,b,c,d){return a*c+b*d},s=a.v.len=function(a){return Math.sqrt(q(a,a))},t=(a.v.eql=function(a,b){return a.x===b.x&&a.y===b.y},a.v.add=function(a,b){return new o(a.x+b.x,a.y+b.y)});o.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this};var u=a.v.sub=function(a,b){return new o(a.x-b.x,a.y-b.y)};o.prototype.sub=function(a){return this.x-=a.x,this.y-=a.y,this};var v=a.v.neg=function(a){return new o(-a.x,-a.y)};o.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var w=a.v.mult=function(a,b){return new o(a.x*b,a.y*b)};o.prototype.mult=function(a){return this.x*=a,this.y*=a,this};var x=a.v.cross=function(a,b){return a.x*b.y-a.y*b.x},y=function(a,b,c,d){return a*d-b*c},z=a.v.perp=function(a){return new o(-a.y,a.x)},A=(a.v.pvrperp=function(a){return new o(a.y,-a.x)},a.v.project=function(a,b){return w(b,q(a,b)/D(b))});o.prototype.project=function(a){return this.mult(q(this,a)/D(a)),this};var B=a.v.rotate=function(a,b){return new o(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};o.prototype.rotate=function(a){return this.x=this.x*a.x-this.y*a.y,this.y=this.x*a.y+this.y*a.x,this};var C=a.v.unrotate=function(a,b){return new o(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},D=a.v.lengthsq=function(a){return q(a,a)},E=a.v.lerp=function(a,b,c){return t(w(a,1-c),w(b,c))},F=a.v.normalize=function(a){return w(a,1/s(a))},G=a.v.normalize_safe=function(a){return 0===a.x&&0===a.y?p:F(a)},H=a.v.clamp=function(a,b){return q(a,a)>b*b?w(F(a),b):a},I=(a.v.lerpconst=function(a,b,c){return t(a,H(u(b,a),c))},a.v.dist=function(a,b){return s(u(a,b))}),J=a.v.distsq=function(a,b){return D(u(a,b))},K=(a.v.near=function(a,b,c){return J(a,b)<c*c},a.v.slerp=function(a,b,c){var d=Math.acos(q(a,b));if(d){var e=1/Math.sin(d);return t(w(a,Math.sin((1-c)*d)*e),w(b,Math.sin(c*d)*e))}return a}),L=(a.v.slerpconst=function(a,c,d){var e=Math.acos(q(a,c));return K(a,c,b(d,e)/e)},a.v.forangle=function(a){return new o(Math.cos(a),Math.sin(a))},a.v.toangle=function(a){return Math.atan2(a.y,a.x)},a.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"},0),M=a.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d,L++};a.bb=function(a,b,c,d){return new M(a,b,c,d)};var N=function(a,b,c,d,e){return a.l<=d&&b<=a.r&&a.b<=e&&c<=a.t},O=function(a,b,c,d,e){return a<=e.x&&c>=e.x&&b<=e.y&&d>=e.y},P=0,Q=(a.NO_GROUP=0,a.ALL_LAYERS=-1);a.resetShapeIdCounter=function(){P=0};var R=a.Shape=function(a){this.body=a,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=P++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=p,this.collision_type=0,this.group=0,this.layers=Q,this.space=null,this.collisionCode=this.collisionCode};R.prototype.setElasticity=function(a){this.e=a},R.prototype.setFriction=function(a){this.body.activate(),this.u=a},R.prototype.setLayers=function(a){this.body.activate(),this.layers=a},R.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},R.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},R.prototype.getBody=function(){return this.body},R.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},R.prototype.setBody=function(a){d(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then "),this.body=a},R.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},R.prototype.update=function(a,b){d(!isNaN(b.x),"Rotation is NaN"),d(!isNaN(a.x),"Position is NaN"),this.cacheData(a,b)},R.prototype.getBB=function(){return new M(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var S=function(a){this.shape=a,this.d=1/0,this.n=p},T=function(a,b,c){this.shape=a,this.t=b,this.n=c};T.prototype.hitPoint=function(a,b){return E(a,b,this.t)},T.prototype.hitDist=function(a,b){return I(a,b)*this.t};var U=a.CircleShape=function(a,b,c){this.c=this.tc=c,this.r=b,this.type="circle",R.call(this,a)};U.prototype=Object.create(R.prototype),U.prototype.cacheData=function(a,b){var c=this.tc=B(this.c,b).add(a),d=this.r;this.bb_l=c.x-d,this.bb_b=c.y-d,this.bb_r=c.x+d,this.bb_t=c.y+d},U.prototype.pointQuery=function(a){var b=u(a,this.tc),c=D(b),d=this.r;if(d*d>c){var e=new S(this),f=Math.sqrt(c);return e.d=d-f,e.n=w(b,1/f),e}};var V=function(a,b,c,d,e){d=u(d,b),e=u(e,b);var f=q(d,d)-2*q(d,e)+q(e,e),g=-2*q(d,d)+2*q(d,e),h=q(d,d)-c*c,i=g*g-4*f*h;if(i>=0){var j=(-g-Math.sqrt(i))/(2*f);if(j>=0&&1>=j)return new T(a,j,F(E(d,e,j)))}};U.prototype.segmentQuery=function(a,b){return V(this,this.tc,this.r,a,b)};var W=a.SegmentShape=function(a,b,c,d){this.a=b,this.b=c,this.n=z(F(u(c,b))),this.ta=this.tb=this.tn=null,this.r=d,this.a_tangent=p,this.b_tangent=p,this.type="segment",R.call(this,a)};W.prototype=Object.create(R.prototype),W.prototype.cacheData=function(a,b){this.ta=t(a,B(this.a,b)),this.tb=t(a,B(this.b,b)),this.tn=B(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x),this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g,this.bb_b=e-g,this.bb_r=d+g,this.bb_t=f+g},W.prototype.pointQuery=function(a){if(O(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a)){var b=this.ta,c=this.tb,d=u(c,b),e=m(q(d,u(a,b))/D(d)),f=t(b,w(d,e)),g=u(a,f),h=D(g),i=this.r;if(i*i>h){var j=new S(this),k=Math.sqrt(h);return j.d=i-k,j.n=w(g,1/k),j}}},W.prototype.segmentQuery=function(a,b){var c=this.tn,d=q(u(this.ta,a),c),e=this.r,f=d>0?v(c):c,g=u(w(f,e),a),h=t(this.ta,g),i=t(this.tb,g),j=u(b,a);if(x(j,h)*x(j,i)<=0){var k=d+(d>0?-e:e),l=-k,m=q(j,c)-k;if(0>l*m)return new T(this,l/(l-m),f)}else if(0!==e){var n=V(this,this.ta,this.r,a,b),o=V(this,this.tb,this.r,a,b);return n?o&&o.t<n.t?o:n:o}},W.prototype.setNeighbors=function(a,b){this.a_tangent=u(a,this.a),this.b_tangent=u(b,this.b)},W.prototype.setEndpoints=function(a,b){this.a=a,this.b=b,this.n=z(F(u(b,a)))};var X=function(a){for(var b=a.length,c=0;b>c;c+=2){var d=a[c],e=a[c+1],f=a[(c+2)%b],g=a[(c+3)%b],h=a[(c+4)%b],i=a[(c+5)%b];if(y(f-d,g-e,h-f,i-g)>0)return!1}return!0},Y=a.PolyShape=function(a,b,c){d(b.length>=4,"Polygons require some verts"),d("number"==typeof b[0],"Polygon verticies should be specified in a flattened list"),d(X(b),"Polygon is concave or has a reversed winding."),this.setVerts(b,c),this.type="poly",R.call(this,a)};Y.prototype=Object.create(R.prototype);var Z=function(a,b){this.n=a,this.d=b};Y.prototype.setVerts=function(a,b){var c=a.length,d=c>>1;this.verts=new Array(c),this.tVerts=new Array(c),this.axes=new Array(d),this.tAxes=new Array(d);for(var e=0;c>e;e+=2){var f=a[e]+b.x,g=a[e+1]+b.y,h=a[(e+2)%c]+b.x,i=a[(e+3)%c]+b.y,j=F(z(new o(h-f,i-g)));this.verts[e]=f,this.verts[e+1]=g,this.axes[e>>1]=new Z(j,r(j.x,j.y,f,g)),this.tAxes[e>>1]=new Z(new o(0,0),0)}};var $=(a.BoxShape=function(a,b,c){var d=b/2,e=c/2;return $(a,new M(-d,-e,d,e))},a.BoxShape2=function(a,b){var c=[b.l,b.b,b.l,b.t,b.r,b.t,b.r,b.b];return new Y(a,c,p)});Y.prototype.transformVerts=function(a,d){for(var e=this.verts,f=this.tVerts,g=1/0,h=-1/0,i=1/0,j=-1/0,k=0;k<e.length;k+=2){var l=e[k],m=e[k+1],n=a.x+l*d.x-m*d.y,o=a.y+l*d.y+m*d.x;f[k]=n,f[k+1]=o,g=b(g,n),h=c(h,n),i=b(i,o),j=c(j,o)}this.bb_l=g,this.bb_b=i,this.bb_r=h,this.bb_t=j},Y.prototype.transformAxes=function(a,b){for(var c=this.axes,d=this.tAxes,e=0;e<c.length;e++){var f=B(c[e].n,b);d[e].n=f,d[e].d=q(a,f)+c[e].d}},Y.prototype.cacheData=function(a,b){this.transformAxes(a,b),this.transformVerts(a,b)},Y.prototype.pointQuery=function(a){if(O(this.bb_l,this.bb_b,this.bb_r,this.bb_t,a)){for(var b=new S(this),c=this.tAxes,d=0;d<c.length;d++){var e=c[d].n,f=c[d].d-q(e,a);if(0>f)return;f<b.d&&(b.d=f,b.n=e)}return b}},Y.prototype.segmentQuery=function(a,b){for(var c=this.tAxes,d=this.tVerts,e=c.length,f=2*e,g=0;e>g;g++){var h=c[g].n,i=q(a,h);if(!(c[g].d>i)){var j=q(b,h),k=(c[g].d-i)/(j-i);if(!(0>k||k>1)){var l=E(a,b,k),m=-x(h,l),n=-y(h.x,h.y,d[2*g],d[2*g+1]),o=-y(h.x,h.y,d[(2*g+2)%f],d[(2*g+3)%f]);if(m>=n&&o>=m)return new T(this,k,h)}}}},Y.prototype.getNumVerts=function(){return this.verts.length/2},Y.prototype.getVert=function(a){return new o(this.verts[2*a],this.verts[2*a+1])},Y.prototype.valueOnAxis=function(a,c){for(var d=this.tVerts,e=r(a.x,a.y,d[0],d[1]),f=2;f<d.length;f+=2)e=b(e,r(a.x,a.y,d[f],d[f+1]));return e-c},Y.prototype.containsVert=function(a,b){for(var c=this.tAxes,d=0;d<c.length;d++){var e=c[d].n,f=r(e.x,e.y,a,b)-c[d].d;if(f>0)return!1}return!0},Y.prototype.containsVertPartial=function(a,b,c){for(var d=this.tAxes,e=0;e<d.length;e++){var c=d[e].n;if(!(q(c,c)<0)){var f=r(c.x,c.y,a,b)-d[e].d;if(f>0)return!1}}return!0},Y.prototype.getNumVerts=function(){return this.verts.length/2},Y.prototype.getVert=function(a){return new o(this.verts[2*a],this.verts[2*a+1])};var _=a.Body=function(a,b){this.p=new o(0,0),this.vx=this.vy=0,this.f=new o(0,0),this.w=0,this.t=0,this.v_limit=1/0,this.w_limit=1/0,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(a),this.setMoment(b),this.rot=new o(0,0),this.setAngle(0)},ab=function(){return body=new _(1/0,1/0),body.nodeIdleTime=1/0,body};a.StaticBody=ab;var bb=function(a,b){d(a.x==a.x&&a.y==a.y,b)},cb=function(a,b){d(1/0!==Math.abs(a.x)&&1/0!==Math.abs(a.y),b)},db=function(a,b){bb(a,b),cb(a,b)};_.prototype.sanityCheck=function(){d(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid."),d(this.i===this.i&&this.i_inv===this.i_inv,"Body's moment is invalid."),db(this.p,"Body's position is invalid."),db(this.f,"Body's force is invalid."),d(this.vx===this.vx&&1/0!==Math.abs(this.vx),"Body's velocity is invalid."),d(this.vy===this.vy&&1/0!==Math.abs(this.vy),"Body's velocity is invalid."),d(this.a===this.a&&1/0!==Math.abs(this.a),"Body's angle is invalid."),d(this.w===this.w&&1/0!==Math.abs(this.w),"Body's angular velocity is invalid."),d(this.t===this.t&&1/0!==Math.abs(this.t),"Body's torque is invalid."),db(this.rot,"Internal error: Body's rotation vector is invalid."),d(this.v_limit===this.v_limit,"Body's velocity limit is invalid."),d(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")},_.prototype.getPos=function(){return this.p},_.prototype.getVel=function(){return new o(this.vx,this.vy)},_.prototype.getAngVel=function(){return this.w},_.prototype.isSleeping=function(){return null!==this.nodeRoot},_.prototype.isStatic=function(){return 1/0===this.nodeIdleTime},_.prototype.isRogue=function(){return null===this.space},_.prototype.setMass=function(a){d(a>0,"Mass must be positive and non-zero."),this.activate(),this.m=a,this.m_inv=1/a},_.prototype.setMoment=function(a){d(a>0,"Moment of Inertia must be positive and non-zero."),this.activate(),this.i=a,this.i_inv=1/a},_.prototype.addShape=function(a){this.shapeList.push(a)},_.prototype.removeShape=function(a){i(this.shapeList,a)};var eb=function(a,b,c){return a===c?a.next(b):(a.a===b?a.next_a=eb(a.next_a,b,c):a.next_b=eb(a.next_b,b,c),a)};_.prototype.removeConstraint=function(a){this.constraintList=eb(this.constraintList,this,a)},_.prototype.setPos=function(a){this.activate(),this.sanityCheck(),this.p=a},_.prototype.setVel=function(a){this.activate(),this.vx=a.x,this.vy=a.y},_.prototype.setAngVel=function(a){this.activate(),this.w=a},_.prototype.setAngleInternal=function(a){d(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN"),this.a=a,this.rot.x=Math.cos(a),this.rot.y=Math.sin(a)},_.prototype.setAngle=function(a){this.activate(),this.sanityCheck(),this.setAngleInternal(a)},_.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c,e=this.vy*b+(a.y+this.f.y*this.m_inv)*c,f=this.v_limit,g=d*d+e*e,h=g>f*f?f/Math.sqrt(g):1;this.vx=d*h,this.vy=e*h;var i=this.w_limit;this.w=l(this.w*b+this.t*this.i_inv*c,-i,i),this.sanityCheck()},_.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a,this.p.y+=(this.vy+this.v_biasy)*a,this.setAngleInternal(this.a+(this.w+this.w_bias)*a),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},_.prototype.resetForces=function(){this.activate(),this.f=new o(0,0),this.t=0},_.prototype.applyForce=function(a,b){this.activate(),this.f=t(this.f,a),this.t+=x(b,a)},_.prototype.applyImpulse=function(a,b){this.activate(),ic(this,a.x,a.y,b)},_.prototype.getVelAtPoint=function(a){return t(new o(this.vx,this.vy),w(z(a),this.w))},_.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(u(a,this.p))},_.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(B(a,this.rot))},_.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;c>b;b++)a(this.shapeList[b])},_.prototype.eachConstraint=function(a){for(var b=this.constraintList;b;){var c=b.next(this);a(b),b=c}},_.prototype.eachArbiter=function(a){for(var b=this.arbiterList;b;){var c=b.next(this);b.swappedColl=this===b.body_b,a(b),b=c}},_.prototype.local2World=function(a){return t(this.p,B(a,this.rot))},_.prototype.world2Local=function(a){return C(u(a,this.p),this.rot)},_.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var fb=a.SpatialIndex=function(a){this.staticIndex=a,a&&(d(!a.dynamicIndex,"This static index is already associated with a dynamic index."),a.dynamicIndex=this)};fb.prototype.collideStatic=function(a,b){if(a.count>0){var c=a.query;this.each(function(a){c(a,new M(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var gb=a.BBTree=function(a){fb.call(this,a),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.stamp=0};gb.prototype=Object.create(fb.prototype);var hb=0,ib=function(a,d,e){this.obj=null,this.bb_l=b(d.bb_l,e.bb_l),this.bb_b=b(d.bb_b,e.bb_b),this.bb_r=c(d.bb_r,e.bb_r),this.bb_t=c(d.bb_t,e.bb_t),this.parent=null,this.setA(d),this.setB(e),hb++},jb=0,kb=function(a,b){this.obj=b,a.getBB(b,this),this.parent=null,this.stamp=1,this.pairs=null,jb++};gb.prototype.getBB=function(a,d){var e=this.velocityFunc;if(e){var f=.1,g=(a.bb_r-a.bb_l)*f,h=(a.bb_t-a.bb_b)*f,i=w(e(a),.1);d.bb_l=a.bb_l+b(-g,i.x),d.bb_b=a.bb_b+b(-h,i.y),d.bb_r=a.bb_r+c(g,i.x),d.bb_t=a.bb_t+c(h,i.y)}else d.bb_l=a.bb_l,d.bb_b=a.bb_b,d.bb_r=a.bb_r,d.bb_t=a.bb_t},gb.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp},gb.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var lb=function(a,b){this.a=a,this.b=b},mb=function(a,b){this.prev=null,this.next=b,this.leaf=a};mb.prototype.unlink=function(){var a=this.next,b=this.prev;a&&(a.a.leaf==this.leaf?a.a.prev=b:a.b.prev=b),b?b.a.leaf==this.leaf?b.a.next=a:b.b.next=a:this.leaf.pairs=a},kb.prototype.clearPairs=function(){var a,b=this.pairs;for(this.pairs=null;b;)b.a.leaf==this?(a=b.a.next,b.b.unlink(),b=a):(a=b.b.next,b.a.unlink(),b=a)};var nb=function(a,b){var c=a.pairs,d=b.pairs,e=new lb(new mb(a,c),new mb(b,d));a.pairs=b.pairs=e,c&&(c.a.leaf==a?c.a.prev=e:c.b.prev=e),d&&(d.a.leaf==b?d.a.prev=e:d.b.prev=e)};ib.prototype.setA=function(a){this.A=a,a.parent=this},ib.prototype.setB=function(a){this.B=a,a.parent=this},kb.prototype.isLeaf=!0,ib.prototype.isLeaf=!1,ib.prototype.otherChild=function(a){return this.A==a?this.B:this.A},ib.prototype.replaceChild=function(a,d){e(a==this.A||a==this.B,"Node is not a child of parent."),this.A==a?this.setA(d):this.setB(d);for(var f=this;f;f=f.parent){var g=f.A,h=f.B;f.bb_l=b(g.bb_l,h.bb_l),f.bb_b=b(g.bb_b,h.bb_b),f.bb_r=c(g.bb_r,h.bb_r),f.bb_t=c(g.bb_t,h.bb_t)}},ib.prototype.bbArea=kb.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var ob=function(a,d){return(c(a.bb_r,d.bb_r)-b(a.bb_l,d.bb_l))*(c(a.bb_t,d.bb_t)-b(a.bb_b,d.bb_b))},pb=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+b.bb_t-b.bb_b-b.bb_t)},qb=function(a,d,e){if(null==a)return d;if(a.isLeaf)return new ib(e,d,a);var f=a.B.bbArea()+ob(a.A,d),g=a.A.bbArea()+ob(a.B,d);return f===g&&(f=pb(a.A,d),g=pb(a.B,d)),f>g?a.setB(qb(a.B,d,e)):a.setA(qb(a.A,d,e)),a.bb_l=b(a.bb_l,d.bb_l),a.bb_b=b(a.bb_b,d.bb_b),a.bb_r=c(a.bb_r,d.bb_r),a.bb_t=c(a.bb_t,d.bb_t),a};ib.prototype.intersectsBB=kb.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var rb=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(rb(a.A,b,c),rb(a.B,b,c)))},sb=function(a,d,e){var f=1/(e.x-d.x),g=a.bb_l==d.x?-1/0:(a.bb_l-d.x)*f,h=a.bb_r==d.x?1/0:(a.bb_r-d.x)*f,i=b(g,h),j=c(g,h),k=1/(e.y-d.y),l=a.bb_b==d.y?-1/0:(a.bb_b-d.y)*k,m=a.bb_t==d.y?1/0:(a.bb_t-d.y)*k,n=b(l,m),o=c(l,m);if(j>=n&&o>=i){var p=c(i,n),q=b(j,o);if(q>=0&&1>=p)return c(p,0)}return 1/0},tb=function(a,c,d,e,f){if(a.isLeaf)return f(a.obj);var g=sb(a.A,c,d),h=sb(a.B,c,d);return h>g?(e>g&&(e=b(e,tb(a.A,c,d,e,f))),e>h&&(e=b(e,tb(a.B,c,d,e,f)))):(e>h&&(e=b(e,tb(a.B,c,d,e,f))),e>g&&(e=b(e,tb(a.A,c,d,e,f)))),e},ub=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.otherChild(b);return e.parent=a.parent,e}return d.parent.replaceChild(d,d.otherChild(b),c),a},vb=function(a,b){return a.bb_l<=b.bb_r&&b.bb_l<=a.bb_r&&a.bb_b<=b.bb_t&&b.bb_b<=a.bb_t},wb=function(a,b,c,d,e){vb(b,a)&&(a.isLeaf?c?nb(b,a,d):(a.stamp<b.stamp&&nb(a,b,d),e&&e(b.obj,a.obj)):(wb(a.A,b,c,d,e),wb(a.B,b,c,d,e)))},xb=function(a,b,c,d){if(a.stamp==b.getStamp()){c&&wb(c,a,!1,b,d);for(var e=a;e.parent;e=e.parent)e==e.parent.A?wb(e.parent.B,a,!0,b,d):wb(e.parent.A,a,!1,b,d)}else for(var f=a.pairs;f;)a==f.b.leaf?(d&&d(f.a.leaf.obj,a.obj),f=f.b.next):f=f.a.next},yb=function(a,b,c,d){a.isLeaf?xb(a,b,c,d):(yb(a.A,b,c,d),yb(a.B,b,c,d))};kb.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t},kb.prototype.update=function(a){var b=a.root,c=this.obj;return this.containsObj(c)?!1:(a.getBB(this.obj,this),b=ub(b,this,a),a.root=qb(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0)},kb.prototype.addPairs=function(a){var b=a.dynamicIndex;if(b){var c=b.root;c&&wb(c,this,!0,b,null)}else{var d=a.staticIndex.root;xb(this,a,d,null)}},gb.prototype.insert=function(a,b){var c=new kb(this,a);this.leaves[b]=c,this.root=qb(this.root,c,this),this.count++,c.stamp=this.getStamp(),c.addPairs(this),this.incrementStamp()},gb.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b],this.root=ub(this.root,c,this),this.count--,c.clearPairs(this)},gb.prototype.contains=function(a,b){return null!=this.leaves[b]};var zb=function(){};gb.prototype.reindexQuery=function(a){if(this.root){var b,c=this.leaves;for(b in c)c[b].update(this);var d=this.staticIndex,e=d&&d.root;yb(this.root,this,e,a),d&&!e&&this.collideStatic(this,d,a),this.incrementStamp()}},gb.prototype.reindex=function(){this.reindexQuery(zb)},gb.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())},gb.prototype.pointQuery=function(a,b){this.root&&rb(this.root,new M(a.x,a.y,a.x,a.y),b)},gb.prototype.segmentQuery=function(a,b,c,d){this.root&&tb(this.root,a,b,c,d)},gb.prototype.query=function(a,b){this.root&&rb(this.root,a,b)},gb.prototype.count=function(){return this.count},gb.prototype.each=function(a){var b;for(b in this.leaves)a(this.leaves[b].obj)};var Ab=function(a,d,e,f,g){return(c(a.bb_r,f)-b(a.bb_l,d))*(c(a.bb_t,g)-b(a.bb_b,e))},Bb=function(a,d,e,f){if(1==f)return d[e];if(2==f)return new ib(a,d[e],d[e+1]);for(var g=d[e],h=g.bb_l,i=g.bb_b,j=g.bb_r,k=g.bb_t,l=e+f,m=e+1;l>m;m++)g=d[m],h=b(h,g.bb_l),i=b(i,g.bb_b),j=c(j,g.bb_r),k=c(k,g.bb_t);var n=j-h>k-i,o=new Array(2*f);if(n)for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_l,o[2*m+1]=d[m].bb_r;else for(var m=e;l>m;m++)o[2*m+0]=d[m].bb_b,o[2*m+1]=d[m].bb_t;o.sort(function(a,b){return a-b});var p=.5*(o[f-1]+o[f]),q=h,r=i,s=j,t=k,u=h,v=i,w=j,x=k;n?s=u=p:t=v=p;for(var y=l,z=e;y>z;){var g=d[z];Ab(g,u,v,w,x)<Ab(g,q,r,s,t)?(y--,d[z]=d[y],d[y]=g):z++}if(y==f){for(var g=null,m=e;l>m;m++)g=qb(g,d[m],a);return g}return NodeNew(a,Bb(a,d,e,y-e),Bb(a,d,y,l-y))};gb.prototype.optimize=function(){var a=new Array(this.count),b=0;for(var c in this.leaves)a[b++]=this.nodes[c];this.root=Bb(tree,a,a.length)};var Cb=function(a,b){!a.isLeaf&&10>=b&&(Cb(a.a,b+1),Cb(a.b,b+1));for(var c="",d=0;b>d;d++)c+=" "};gb.prototype.log=function(){this.root&&Cb(this.root,0)};var Db=a.CollisionHandler=function(){this.a=this.b=0};Db.prototype.begin=function(){return!0},Db.prototype.preSolve=function(){return!0},Db.prototype.postSolve=function(){},Db.prototype.separate=function(){};var Eb=function(a,b){this.e=0,this.u=0,this.surface_vr=p,this.a=a,this.body_a=a.body,this.b=b,this.body_b=b.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};Eb.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},Eb.prototype.totalImpulse=function(){for(var a=this.contacts,b=new o(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(w(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()},Eb.prototype.totalImpulseWithFriction=function(){for(var a=this.contacts,b=new o(0,0),c=0,d=a.length;d>c;c++){var e=a[c];b.add(new o(e.jnAcc,e.jtAcc).rotate(e.n))}return this.swappedColl?b:b.neg()},Eb.prototype.totalKE=function(){for(var a=(1-this.e)/(1+this.e),b=0,c=this.contacts,d=0,e=c.length;e>d;d++){var f=c[d],g=f.jnAcc,h=f.jtAcc;b+=a*g*g/f.nMass+h*h/f.tMass}return b},Eb.prototype.ignore=function(){this.state="ignore"},Eb.prototype.getA=function(){return this.swappedColl?this.b:this.a},Eb.prototype.getB=function(){return this.swappedColl?this.a:this.b},Eb.prototype.isFirstContact=function(){return"first coll"===this.state};var Fb=function(a,b,c){this.point=a,this.normal=b,this.dist=c};Eb.prototype.getContactPointSet=function(){var a,b=new Array(this.contacts.length);for(a=0;a<b.length;a++)b[a]=new Fb(this.contacts[a].p,this.contacts[a].n,this.contacts[a].dist);return b},Eb.prototype.getNormal=function(a){var b=this.contacts[a].n;return this.swappedColl?v(b):b},Eb.prototype.getPoint=function(a){return this.contacts[a].p},Eb.prototype.getDepth=function(a){return this.contacts[a].dist};var Gb=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d,d&&(d.body_a===b?d.thread_a_prev=c:d.thread_b_prev=c)};Eb.prototype.unthread=function(){Gb(this,this.body_a,this.thread_a_prev,this.thread_a_next),Gb(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},Eb.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++)for(var f=this.contacts[e],g=0;g<a.length;g++){var h=a[g];h.hash===f.hash&&(h.jnAcc=f.jnAcc,h.jtAcc=f.jtAcc)}this.contacts=a,this.handler=b,this.swappedColl=c.collision_type!==b.a,this.e=c.e*d.e,this.u=c.u*d.u,this.surface_vr=u(c.surface_v,d.surface_v),this.a=c,this.body_a=c.body,this.b=d,this.body_b=d.body,"cached"==this.state&&(this.state="first coll")},Eb.prototype.preStep=function(a,c,d){for(var e=this.body_a,f=this.body_b,g=0;g<this.contacts.length;g++){var h=this.contacts[g];h.r1=u(h.p,e.p),h.r2=u(h.p,f.p),h.nMass=1/mc(e,f,h.r1,h.r2,h.n),h.tMass=1/mc(e,f,h.r1,h.r2,z(h.n)),h.bias=-d*b(0,h.dist+c)/a,h.jBias=0,h.bounce=hc(e,f,h.r1,h.r2,h.n)*this.e}},Eb.prototype.applyCachedImpulse=function(a){if(!this.isFirstContact())for(var b=this.body_a,c=this.body_b,d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y,h=f*e.jnAcc-g*e.jtAcc,i=f*e.jtAcc+g*e.jnAcc;jc(b,c,e.r1,e.r2,h*a,i*a)}};var Hb=0,Ib=0;Eb.prototype.applyImpulse=function(){Hb++;for(var a=this.body_a,b=this.body_b,d=this.surface_vr,e=this.u,f=0;f<this.contacts.length;f++){Ib++;var g=this.contacts[f],h=g.nMass,i=g.n,j=g.r1,k=g.r2,m=b.vx-k.y*b.w-(a.vx-j.y*a.w),n=b.vy+k.x*b.w-(a.vy+j.x*a.w),o=i.x*(b.v_biasx-k.y*b.w_bias-a.v_biasx+j.y*a.w_bias)+i.y*(k.x*b.w_bias+b.v_biasy-j.x*a.w_bias-a.v_biasy),p=r(m,n,i.x,i.y),q=r(m+d.x,n+d.y,-i.y,i.x),s=(g.bias-o)*h,t=g.jBias;g.jBias=c(t+s,0);var u=-(g.bounce+p)*h,v=g.jnAcc;g.jnAcc=c(v+u,0);var w=e*g.jnAcc,x=-q*g.tMass,y=g.jtAcc;g.jtAcc=l(y+x,-w,w);var z=i.x*(g.jBias-t),A=i.y*(g.jBias-t);kc(a,-z,-A,j),kc(b,z,A,k);var B=g.jnAcc-v,C=g.jtAcc-y;jc(a,b,j,k,i.x*B-i.y*C,i.x*C+i.y*B)}},Eb.prototype.callSeparate=function(a){var b=a.lookupHandler(this.a.collision_type,this.b.collision_type);b.separate(this,a)},Eb.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var Jb=0,Kb=function(a,b,c,d){this.p=a,this.n=b,this.dist=c,this.r1=this.r2=p,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=d,Jb++},Lb=[],Mb=function(a,b,c,d){var e=c+d,f=u(b,a),g=D(f);if(!(g>=e*e)){var h=Math.sqrt(g);return new Kb(t(a,w(f,.5+(c-.5*e)/(h?h:1/0))),h?w(f,1/h):new o(1,0),h-e,0)}},Nb=function(a,b){var c=Mb(a.tc,b.tc,a.r,b.r);return c?[c]:Lb},Ob=function(a,b){var c=b.ta,d=b.tb,e=a.tc,f=u(d,c),g=m(q(f,u(e,c))/D(f)),h=t(c,w(f,g)),i=Mb(e,h,a.r,b.r);if(i){var j=i.n;return 0===g&&q(j,b.a_tangent)<0||1===g&&q(j,b.b_tangent)<0?Lb:[i]}return Lb},Pb=0,Qb=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,b[0].d);if(d>0)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(f>0)return-1;f>d&&(d=f,c=e)}return Pb=d,c},Rb=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVertPartial(i,j,v(c))&&e.push(new Kb(new o(i,j),c,d,h(a.hashid,g)))}for(var k=b.tVerts,g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVertPartial(i,j,c)&&e.push(new Kb(new o(i,j),c,d,h(b.hashid,g)))}return e},Sb=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;g<f.length;g+=2){var i=f[g],j=f[g+1];b.containsVert(i,j)&&e.push(new Kb(new o(i,j),c,d,h(a.hashid,g>>1)))}for(var k=b.tVerts,g=0;g<k.length;g+=2){var i=k[g],j=k[g+1];a.containsVert(i,j)&&e.push(new Kb(new o(i,j),c,d,h(b.hashid,g>>1)))}return e.length?e:Rb(a,b,c,d)},Tb=function(a,b){var c=Qb(b,a.tAxes);if(-1==c)return Lb;var d=Pb,e=Qb(a,b.tAxes);if(-1==e)return Lb;var f=Pb;return d>f?Sb(a,b,a.tAxes[c].n,d):Sb(a,b,v(b.tAxes[e].n),f)},Ub=function(a,c,d){var e=q(c,a.ta)-a.r,f=q(c,a.tb)-a.r;return b(e,f)-d},Vb=function(a,b,c,d,e){for(var f=x(b.tn,b.ta),g=x(b.tn,b.tb),i=w(b.tn,e),j=c.tVerts,k=0;k<j.length;k+=2){var l=j[k],m=j[k+1];if(r(l,m,i.x,i.y)<q(b.tn,b.ta)*e+b.r){var n=y(b.tn.x,b.tn.y,l,m);f>=n&&n>=g&&a.push(new Kb(new o(l,m),i,d,h(c.hashid,k)))}}},Wb=function(a,b){var c=[],d=b.tAxes,e=d.length,f=q(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,i=b.valueOnAxis(v(a.tn),-f)-a.r;if(i>0||g>0)return Lb;var j=0,k=Ub(a,d[0].n,d[0].d);if(k>0)return Lb;for(var l=0;e>l;l++){var m=Ub(a,d[l].n,d[l].d);if(m>0)return Lb;m>k&&(k=m,j=l)}var n=v(d[j].n),p=t(a.ta,w(n,a.r)),r=t(a.tb,w(n,a.r));if(b.containsVert(p.x,p.y)&&c.push(new Kb(p,n,k,h(a.hashid,0))),b.containsVert(r.x,r.y)&&c.push(new Kb(r,n,k,h(a.hashid,1))),(g>=k||i>=k)&&(g>i?Vb(c,a,b,g,1):Vb(c,a,b,i,-1)),0===c.length){var s,u=2*j,x=b.tVerts,y=new o(x[u],x[u+1]);if(s=Mb(a.ta,y,a.r,0,c))return[s];if(s=Mb(a.tb,y,a.r,0,c))return[s];var z=2*e,A=new o(x[(u+2)%z],x[(u+3)%z]);if(s=Mb(a.ta,A,a.r,0,c))return[s];if(s=Mb(a.tb,A,a.r,0,c))return[s]}return c},Xb=function(a,b){for(var c=b.tAxes,d=0,e=q(c[0].n,a.tc)-c[0].d-a.r,f=0;f<c.length;f++){var g=q(c[f].n,a.tc)-c[f].d-a.r;if(g>0)return Lb;g>e&&(e=g,d=f)}var h=c[d].n,i=b.tVerts,j=i.length,k=d<<1,l=i[k],m=i[k+1],n=i[(k+2)%j],p=i[(k+3)%j],r=y(h.x,h.y,l,m),s=y(h.x,h.y,n,p),t=x(h,a.tc);if(s>t){var z=Mb(a.tc,new o(n,p),a.r,0,z);return z?[z]:Lb}if(r>t)return[new Kb(u(a.tc,w(h,a.r+e/2)),v(h),e,0)];var z=Mb(a.tc,new o(l,m),a.r,0,z);return z?[z]:Lb};U.prototype.collisionCode=0,W.prototype.collisionCode=1,Y.prototype.collisionCode=2,U.prototype.collisionTable=[Nb,Ob,Xb],W.prototype.collisionTable=[null,function(){return Lb},Wb],Y.prototype.collisionTable=[null,null,Tb];var Yb=a.collideShapes=function(a,b){return d(a.collisionCode<=b.collisionCode,"Collided shapes must be sorted by type"),a.collisionTable[b.collisionCode](a,b)},Zb=new Db,$b=a.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new gb(null),this.activeShapes=new gb(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=Zb,this.postStepCallbacks=[],this.iterations=10,this.gravity=p,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=1/0,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new _(1/0,1/0),this.staticBody.nodeIdleTime=1/0,this.collideShapes=this.makeCollideShapes()};$b.prototype.getCurrentTimeStep=function(){return this.curr_dt},$b.prototype.isLocked=function(){return this.locked};var _b=function(a){d(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};$b.prototype.addCollisionHandler=function(a,b,c,d,e,f){_b(this),this.removeCollisionHandler(a,b);var g=new Db;g.a=a,g.b=b,c&&(g.begin=c),d&&(g.preSolve=d),e&&(g.postSolve=e),f&&(g.separate=f),this.collisionHandlers[h(a,b)]=g},$b.prototype.removeCollisionHandler=function(a,b){_b(this),delete this.collisionHandlers[h(a,b)]},$b.prototype.setDefaultCollisionHandler=function(a,b,c,d){_b(this);var e=new Db;a&&(e.begin=a),b&&(e.preSolve=b),c&&(e.postSolve=c),d&&(e.separate=d),this.defaultHandler=e},$b.prototype.lookupHandler=function(a,b){return this.collisionHandlers[h(a,b)]||this.defaultHandler},$b.prototype.addShape=function(a){var b=a.body;return b.isStatic()?this.addStaticShape(a):(d(!a.space,"This shape is already added to a space and cannot be added to another."),_b(this),b.activate(),b.addShape(a),a.update(b.p,b.rot),this.activeShapes.insert(a,a.hashid),a.space=this,a)},$b.prototype.addStaticShape=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),_b(this);var b=a.body;return b.addShape(a),a.update(b.p,b.rot),this.staticShapes.insert(a,a.hashid),a.space=this,a},$b.prototype.addBody=function(a){return d(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated."),d(!a.space,"This body is already added to a space and cannot be added to another."),_b(this),this.bodies.push(a),a.space=this,a
},$b.prototype.addConstraint=function(a){d(!a.space,"This shape is already added to a space and cannot be added to another."),_b(this);var b=a.a,c=a.b;return b.activate(),c.activate(),this.constraints.push(a),a.next_a=b.constraintList,b.constraintList=a,a.next_b=c.constraintList,c.constraintList=a,a.space=this,a},$b.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=this.cachedArbiters[c];(a===d.body_a&&(b===d.a||null===b)||a===d.body_b&&(b===d.b||null===b))&&(b&&"cached"!==d.state&&d.callSeparate(this),d.unthread(),i(this.arbiters,d),delete this.cachedArbiters[c])}},$b.prototype.removeShape=function(a){var b=a.body;b.isStatic()?this.removeStaticShape(a):(d(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),_b(this),b.activate(),b.removeShape(a),this.filterArbiters(b,a),this.activeShapes.remove(a,a.hashid),a.space=null)},$b.prototype.removeStaticShape=function(a){d(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),_b(this);var b=a.body;b.isStatic()&&b.activateStatic(a),b.removeShape(a),this.filterArbiters(b,a),this.staticShapes.remove(a,a.hashid),a.space=null},$b.prototype.removeBody=function(a){d(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),_b(this),a.activate(),i(this.bodies,a),a.space=null},$b.prototype.removeConstraint=function(a){d(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),_b(this),a.a.activate(),a.b.activate(),i(this.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},$b.prototype.containsShape=function(a){return a.space===this},$b.prototype.containsBody=function(a){return a.space==this},$b.prototype.containsConstraint=function(a){return a.space==this},$b.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[h(a.a.hashid,a.b.hashid)],i(this.arbiters,a)},$b.prototype.eachBody=function(a){this.lock();for(var b=this.bodies,c=0;c<b.length;c++)a(b[c]);for(var d=this.sleepingComponents,c=0;c<d.length;c++)for(var e=d[c],f=e;f;){var g=f.nodeNext;a(f),f=g}this.unlock(!0)},$b.prototype.eachShape=function(a){this.lock(),this.activeShapes.each(a),this.staticShapes.each(a),this.unlock(!0)},$b.prototype.eachConstraint=function(a){this.lock();for(var b=this.constraints,c=0;c<b.length;c++)a(b[c]);this.unlock(!0)},$b.prototype.reindexStatic=function(){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)}),this.staticShapes.reindex()},$b.prototype.reindexShape=function(a){d(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var b=a.body;a.update(b.p,b.rot),this.activeShapes.reindexObject(a,a.hashid),this.staticShapes.reindexObject(a,a.hashid)},$b.prototype.reindexShapesForBody=function(a){for(var b=a.shapeList;b;b=b.next)this.reindexShape(b)},$b.prototype.useSpatialHash=function(a,b){throw new Error("Spatial Hash not yet implemented!")},$b.prototype.activateBody=function(a){if(d(!a.isRogue(),"Internal error: Attempting to activate a rogue body."),this.locked)-1===this.rousedBodies.indexOf(a)&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var b=0;b<a.shapeList.length;b++){var c=a.shapeList[b];this.staticShapes.remove(c,c.hashid),this.activeShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;if(a===f||f.isStatic()){var g=e.a,i=e.b;this.cachedArbiters[h(g.hashid,i.hashid)]=e,e.stamp=this.stamp,e.handler=this.lookupHandler(g.collision_type,i.collision_type),this.arbiters.push(e)}}for(var j=a.constraintList;j;j=j.nodeNext){var f=j.a;(a===f||f.isStatic())&&this.constraints.push(j)}}},$b.prototype.deactivateBody=function(a){d(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body."),i(this.bodies,a);for(var b=0;b<a.shapeList.length;b++){var c=a.shapeList[b];this.activeShapes.remove(c,c.hashid),this.staticShapes.insert(c,c.hashid)}for(var e=a.arbiterList;e;e=e.next(a)){var f=e.body_a;(a===f||f.isStatic())&&this.uncacheArbiter(e)}for(var g=a.constraintList;g;g=g.nodeNext){var f=g.a;(a===f||f.isStatic())&&i(this.constraints,g)}};var ac=function(a){return a?a.nodeRoot:null},bc=function(a){if(a&&a.isSleeping(a)){d(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");for(var b=a.space,c=a;c;){var e=c.nodeNext;c.nodeIdleTime=0,c.nodeRoot=null,c.nodeNext=null,b.activateBody(c),c=e}i(b.sleepingComponents,a)}};_.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,bc(ac(this)))},_.prototype.activateStatic=function(a){d(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var b=this.arbiterList;b;b=b.next(this))a&&a!=b.a&&a!=b.b||(b.body_a==this?b.body_b:b.body_a).activate()},_.prototype.pushArbiter=function(a){e(null===(a.body_a===this?a.thread_a_next:a.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)"),e(null===(a.body_a===this?a.thread_a_prev:a.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;e(null===b||null===(b.body_a===this?b.thread_a_prev:b.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)"),a.body_a===this?a.thread_a_next=b:a.thread_b_next=b,b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a),this.arbiterList=a};var cc=function(a,b){b.nodeRoot=a,b!==a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},dc=function(a,b){if(!b.isRogue()){var c=ac(b);if(null==c){cc(a,b);for(var d=b.arbiterList;d;d=d.next(b))dc(a,b==d.body_a?d.body_b:d.body_a);for(var f=b.constraintList;f;f=f.next(b))dc(a,b==f.a?f.b:f.a)}else e(c===a,"Internal Error: Inconsistency detected in the contact graph.")}},ec=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};$b.prototype.processComponents=function(a){for(var b=1/0!==this.sleepTimeThreshold,c=this.bodies,d=0;d<c.length;d++){var f=c[d];e(null===f.nodeNext,"Internal Error: Dangling next pointer detected in contact graph."),e(null===f.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(b)for(var g=this.idleSpeedThreshold,h=g?g*g:D(this.gravity)*a*a,d=0;d<c.length;d++){var f=c[d],i=h?f.m*h:0;f.nodeIdleTime=f.kineticEnergy()>i?0:f.nodeIdleTime+a}for(var j=this.arbiters,d=0,k=j.length;k>d;d++){var l=j[d],m=l.body_a,n=l.body_b;b&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(b){for(var o=this.constraints,d=0;d<o.length;d++){var p=o[d],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var d=0;d<c.length;){var f=c[d];if(null!==ac(f)||(dc(f,f),ec(f,this.sleepTimeThreshold)))d++,f.nodeRoot=null,f.nodeNext=null;else{this.sleepingComponents.push(f);for(var q=f;q;q=q.nodeNext)this.deactivateBody(q)}}}},_.prototype.sleep=function(){this.sleepWithGroup(null)},_.prototype.sleepWithGroup=function(a){d(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var b=this.space;if(d(b,"Cannot put a rogue body to sleep."),d(!b.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),d(null===a||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),this.isSleeping())return void d(ac(this)===ac(a),"The body is already sleeping and it's group cannot be reassigned.");for(var c=0;c<body.shapeList.length;c++)body.shapeList.update(this.p,this.rot);if(b.deactivateBody(this),a){var e=ac(a);this.nodeRoot=e,this.nodeNext=e.nodeNext,this.nodeIdleTime=0,e.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,b.sleepingComponents.push(this);i(b.bodies,this)},$b.prototype.activateShapesTouchingShape=function(a){1/0!==this.sleepTimeThreshold&&this.shapeQuery(a,function(a){a.body.activate()})},$b.prototype.pointQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&e.pointQuery(a)&&d(e)};this.lock(),this.activeShapes.pointQuery(a,e),this.staticShapes.pointQuery(a,e),this.unlock(!0)},$b.prototype.pointQueryFirst=function(a,b,c){var d=null;return this.pointQuery(a,b,c,function(a){a.sensor||(d=a)}),d},$b.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&(g=f.segmentQuery(a,b))&&e(f,g.t,g.n),1};this.lock(),this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,1,f),this.unlock(!0)},$b.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var g;return(!f.group||d!==f.group)&&c&f.layers&&!f.sensor&&(g=f.segmentQuery(a,b))&&(null===e||g.t<e.t)&&(e=g),e?e.t:1};return this.staticShapes.segmentQuery(a,b,1,f),this.activeShapes.segmentQuery(a,b,e?e.t:1,f),e},$b.prototype.bbQuery=function(a,b,c,d){var e=function(e){(!e.group||c!==e.group)&&b&e.layers&&N(a,e.bb_l,e.bb_b,e.bb_r,e.bb_t)&&d(e)};this.lock(),this.activeShapes.query(a,e),this.staticShapes.query(a,e),this.unlock(!0)},$b.prototype.shapeQuery=function(a,b){var c=a.body;c&&a.update(c.p,c.rot);var d=new M(a.bb_l,a.bb_b,a.bb_r,a.bb_t),e=!1,f=function(c){var d=a;if((!d.group||d.group!==c.group)&&d.layers&c.layers&&d!==c){var f;if(d.collisionCode<=c.collisionCode)f=cpCollideShapes(d,c);else{f=cpCollideShapes(c,d);for(var g=0;g<f.length;g++)f[g].n=v(f[g].n)}if(f.length&&(e=!(d.sensor||c.sensor),b)){for(var h=new Array(f.length),g=0;g<f.length;g++)h[g]=new Fb(f[g].p,f[g].n,f[g].dist);b(c,h)}}};return this.lock(),this.activeShapes.query(d,f),this.staticShapes.query(d,f),this.unlock(!0),e},$b.prototype.addPostStepCallback=function(a){e(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query."),this.postStepCallbacks.push(a)},$b.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]},$b.prototype.lock=function(){this.locked++},$b.prototype.unlock=function(a){if(this.locked--,d(this.locked>=0,"Internal Error: Space lock underflow."),!this.locked&&a){for(var b=this.rousedBodies,c=0;c<b.length;c++)this.activateBody(b[c]);b.length=0,this.runPostStepCallbacks()}},$b.prototype.makeCollideShapes=function(){var a=this;return function(b,c){var d=a;if(b.bb_l<=c.bb_r&&c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t&&b.body!==c.body&&(!b.group||b.group!==c.group)&&b.layers&c.layers){var e=d.lookupHandler(b.collision_type,c.collision_type),f=b.sensor||c.sensor;if(!f||e!==Zb){if(b.collisionCode>c.collisionCode){var g=b;b=c,c=g}var i=Yb(b,c);if(0!==i.length){var j=h(b.hashid,c.hashid),k=d.cachedArbiters[j];k||(k=d.cachedArbiters[j]=new Eb(b,c)),k.update(i,e,b,c),"first coll"!=k.state||e.begin(k,d)||k.ignore(),"ignore"!==k.state&&e.preSolve(k,d)&&!f?d.arbiters.push(k):(k.contacts=null,"ignore"!==k.state&&(k.state="normal")),k.stamp=d.stamp}}}}},$b.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;return(c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping())?!0:(b>=1&&"cached"!=a.state&&(a.callSeparate(this),a.state="cached"),b>=this.collisionPersistence?(a.contacts=null,!1):!0)};var fc=function(a){var b=a.body;a.update(b.p,b.rot)};$b.prototype.step=function(a){if(0!==a){d(0===p.x&&0===p.y,"vzero is invalid"),this.stamp++;var b=this.curr_dt;this.curr_dt=a;for(var c=this.bodies,e=this.constraints,f=this.arbiters,g=0;g<f.length;g++){var h=f[g];h.state="normal",h.body_a.isSleeping()||h.body_b.isSleeping()||h.unthread()}f.length=0,this.lock();for(var g=0;g<c.length;g++){var i=c[g];i.position_func(a)}this.activeShapes.each(fc),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(a),this.lock();for(var j in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[j])||delete this.cachedArbiters[j];for(var k=this.collisionSlop,l=1-Math.pow(this.collisionBias,a),g=0;g<f.length;g++)f[g].preStep(a,k,l);for(var g=0;g<e.length;g++){var m=e[g];m.preSolve(this),m.preStep(a)}for(var n=Math.pow(this.damping,a),o=this.gravity,g=0;g<c.length;g++){var i=c[g];i.velocity_func(o,n,a)}for(var q=0===b?0:a/b,g=0;g<f.length;g++)f[g].applyCachedImpulse(q);for(var g=0;g<e.length;g++){var m=e[g];m.applyCachedImpulse(q)}for(var g=0;g<this.iterations;g++){for(var r=0;r<f.length;r++)f[r].applyImpulse();for(var r=0;r<e.length;r++)e[r].applyImpulse()}for(var g=0;g<e.length;g++)e[g].postSolve(this);for(var g=0;g<f.length;g++){var h=f[g];h.handler.postSolve(h,this)}this.unlock(!0)}};var gc=function(a,b,c,d){var e=a.vx+-c.y*a.w,f=a.vy+c.x*a.w,g=b.vx+-d.y*b.w,h=b.vy+d.x*b.w;return new o(g-e,h-f)},hc=function(a,b,c,d,e){var f=a.vx+-c.y*a.w,g=a.vy+c.x*a.w,h=b.vx+-d.y*b.w,i=b.vy+d.x*b.w;return r(h-f,i-g,e.x,e.y)},ic=function(a,b,c,d){a.vx+=b*a.m_inv,a.vy+=c*a.m_inv,a.w+=a.i_inv*(d.x*c-d.y*b)},jc=function(a,b,c,d,e,f){ic(a,-e,-f,c),ic(b,e,f,d)},kc=function(a,b,c,d){a.v_biasx+=b*a.m_inv,a.v_biasy+=c*a.m_inv,a.w_bias+=a.i_inv*y(d.x,d.y,b,c)},lc=function(a,b,c){var d=x(b,c);return a.m_inv+a.i_inv*d*d},mc=function(a,b,c,d,f){var g=lc(a,c,f)+lc(b,d,f);return e(0!==g,"Unsolvable collision or constraint."),g},nc=function(a,b,c,d,f,g){var h,i,j,k,l=a.m_inv+b.m_inv;h=l,i=0,j=0,k=l;var m=a.i_inv,n=c.x*c.x*m,o=c.y*c.y*m,p=-c.x*c.y*m;h+=o,i+=p,j+=p,k+=n;var q=b.i_inv,r=d.x*d.x*q,s=d.y*d.y*q,t=-d.x*d.y*q;h+=s,i+=t,j+=t,k+=r;var u=h*k-i*j;e(0!==u,"Unsolvable constraint.");var v=1/u;f.x=k*v,f.y=-i*v,g.x=-j*v,g.y=h*v},oc=function(a,b,c){return new o(q(a,b),q(a,c))},pc=function(a,b){return 1-Math.pow(a,b)},qc=a.Constraint=function(a,b){this.a=a,this.b=b,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=1/0,this.errorBias=Math.pow(.9,60),this.maxBias=1/0};qc.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},qc.prototype.preStep=function(){},qc.prototype.applyCachedImpulse=function(){},qc.prototype.applyImpulse=function(){},qc.prototype.getImpulse=function(){return 0},qc.prototype.preSolve=function(){},qc.prototype.postSolve=function(){},qc.prototype.next=function(a){return this.a===a?this.next_a:this.next_b};var rc=a.PinJoint=function(a,b,c,d){qc.call(this,a,b),this.anchr1=c,this.anchr2=d;var f=a?t(a.p,B(c,a.rot)):c,g=b?t(b.p,B(d,b.rot)):d;this.dist=s(u(g,f)),e(this.dist>0,"You created a 0 length pin joint. A pivot joint will be much more stable."),this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};rc.prototype=Object.create(qc.prototype),rc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=B(this.anchr1,b.rot),this.r2=B(this.anchr2,c.rot);var d=u(t(c.p,this.r2),t(b.p,this.r1)),e=s(d);this.n=w(d,1/(e?e:1/0)),this.nMass=1/mc(b,c,this.r1,this.r2,this.n);var f=this.maxBias;this.bias=l(-pc(this.errorBias,a)*(e-this.dist)/a,-f,f),this.jnMax=this.maxForce*a},rc.prototype.applyCachedImpulse=function(a){var b=w(this.n,this.jnAcc*a);jc(this.a,this.b,this.r1,this.r2,b.x,b.y)},rc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=hc(a,b,this.r1,this.r2,c),e=(this.bias-d)*this.nMass,f=this.jnAcc;this.jnAcc=l(f+e,-this.jnMax,this.jnMax),e=this.jnAcc-f,jc(a,b,this.r1,this.r2,c.x*e,c.y*e)},rc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var sc=a.SlideJoint=function(a,b,c,d,e,f){qc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.min=e,this.max=f,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};sc.prototype=Object.create(qc.prototype),sc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=B(this.anchr1,b.rot),this.r2=B(this.anchr2,c.rot);var d=u(t(c.p,this.r2),t(b.p,this.r1)),e=s(d),f=0;e>this.max?(f=e-this.max,this.n=G(d)):e<this.min?(f=this.min-e,this.n=v(G(d))):(this.n=p,this.jnAcc=0),this.nMass=1/mc(b,c,this.r1,this.r2,this.n);var g=this.maxBias;this.bias=l(-pc(this.errorBias,a)*f/a,-g,g),this.jnMax=this.maxForce*a},sc.prototype.applyCachedImpulse=function(a){var b=this.jnAcc*a;jc(this.a,this.b,this.r1,this.r2,this.n.x*b,this.n.y*b)},sc.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=gc(a,b,d,e),g=q(f,c),h=(this.bias-g)*this.nMass,i=this.jnAcc;this.jnAcc=l(i+h,-this.jnMax,0),h=this.jnAcc-i,jc(a,b,this.r1,this.r2,c.x*h,c.y*h)}},sc.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var tc=a.PivotJoint=function(a,b,c,d){if(qc.call(this,a,b),"undefined"==typeof d){var e=c;c=a?a.world2Local(e):e,d=b?b.world2Local(e):e}this.anchr1=c,this.anchr2=d,this.r1=this.r2=p,this.k1=new o(0,0),this.k2=new o(0,0),this.jAcc=p,this.jMaxLen=0,this.bias=p};tc.prototype=Object.create(qc.prototype),tc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=B(this.anchr1,b.rot),this.r2=B(this.anchr2,c.rot),nc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var d=u(t(c.p,this.r2),t(b.p,this.r1));this.bias=H(w(d,-pc(this.errorBias,a)/a),this.maxBias)},tc.prototype.applyCachedImpulse=function(a){jc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},tc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=gc(a,b,c,d),f=oc(u(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=H(t(this.jAcc,f),this.jMaxLen),jc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},tc.prototype.getImpulse=function(){return s(this.jAcc)};var uc=a.GrooveJoint=function(a,b,c,d,e){qc.call(this,a,b),this.grv_a=c,this.grv_b=d,this.grv_n=z(F(u(d,c))),this.anchr2=e,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new o(0,0),this.k2=new o(0,0),this.jAcc=p,this.jMaxLen=0,this.bias=null};uc.prototype=Object.create(qc.prototype),uc.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=B(this.grv_n,b.rot),g=q(d,f);this.grv_tn=f,this.r2=B(this.anchr2,c.rot);var h=x(t(c.p,this.r2),f);h<=x(d,f)?(this.clamp=1,this.r1=u(d,b.p)):h>=x(e,f)?(this.clamp=-1,this.r1=u(e,b.p)):(this.clamp=0,this.r1=u(t(w(z(f),-h),w(f,g)),b.p)),nc(b,c,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*a;var i=u(t(c.p,this.r2),t(b.p,this.r1));this.bias=H(w(i,-pc(this.errorBias,a)/a),this.maxBias)},uc.prototype.applyCachedImpulse=function(a){jc(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)},uc.prototype.grooveConstrain=function(a){var b=this.grv_tn,c=this.clamp*x(a,b)>0?a:A(a,b);return H(c,this.jMaxLen)},uc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.r1,d=this.r2,e=gc(a,b,c,d),f=oc(u(this.bias,e),this.k1,this.k2),g=this.jAcc;this.jAcc=this.grooveConstrain(t(g,f)),jc(a,b,this.r1,this.r2,this.jAcc.x-g.x,this.jAcc.y-g.y)},uc.prototype.getImpulse=function(){return s(this.jAcc)},uc.prototype.setGrooveA=function(a){this.grv_a=a,this.grv_n=z(F(u(this.grv_b,a))),this.activateBodies()},uc.prototype.setGrooveB=function(a){this.grv_b=a,this.grv_n=z(F(u(a,this.grv_a))),this.activateBodies()};var vc=function(a,b){return(a.restLength-b)*a.stiffness},wc=a.DampedSpring=function(a,b,c,d,e,f,g){qc.call(this,a,b),this.anchr1=c,this.anchr2=d,this.restLength=e,this.stiffness=f,this.damping=g,this.springForceFunc=vc,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};wc.prototype=Object.create(qc.prototype),wc.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=B(this.anchr1,b.rot),this.r2=B(this.anchr2,c.rot);var d=u(t(c.p,this.r2),t(b.p,this.r1)),f=s(d);this.n=w(d,1/(f?f:1/0));var g=mc(b,c,this.r1,this.r2,this.n);e(0!==g,"Unsolvable this."),this.nMass=1/g,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*a*g);var h=this.springForceFunc(this,f);jc(b,c,this.r1,this.r2,this.n.x*h*a,this.n.y*h*a)},wc.prototype.applyCachedImpulse=function(){},wc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=this.r1,e=this.r2,f=hc(a,b,d,e,c),g=(this.target_vrn-f)*this.v_coef;this.target_vrn=f+g,g*=this.nMass,jc(a,b,this.r1,this.r2,this.n.x*g,this.n.y*g)},wc.prototype.getImpulse=function(){return 0};var xc=function(a,b){return(b-a.restAngle)*a.stiffness},yc=a.DampedRotarySpring=function(a,b,c,d,e){qc.call(this,a,b),this.restAngle=c,this.stiffness=d,this.damping=e,this.springTorqueFunc=xc,this.target_wrn=0,this.w_coef=0,this.iSum=0};yc.prototype=Object.create(qc.prototype),yc.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.i_inv+c.i_inv;e(0!==d,"Unsolvable spring."),this.iSum=1/d,this.w_coef=1-Math.exp(-this.damping*a*d),this.target_wrn=0;var f=this.springTorqueFunc(this,b.a-c.a)*a;b.w-=f*b.i_inv,c.w+=f*c.i_inv},yc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;var e=d*this.iSum;a.w+=e*a.i_inv,b.w-=e*b.i_inv};var zc=a.RotaryLimitJoint=function(a,b,c,d){qc.call(this,a,b),this.min=c,this.max=d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};zc.prototype=Object.create(qc.prototype),zc.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:d<this.min&&(e=this.min-d),this.iSum=1/(1/b.i+1/c.i);var f=this.maxBias;this.bias=l(-pc(this.errorBias,a)*e/a,-f,f),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},zc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},zc.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=-(this.bias+c)*this.iSum,e=this.jAcc;this.jAcc=this.bias<0?l(e+d,0,this.jMax):l(e+d,-this.jMax,0),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv}},zc.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var Ac=a.RatchetJoint=function(a,b,c,d){qc.call(this,a,b),this.angle=0,this.phase=c,this.ratchet=d,this.angle=(b?b.a:0)-(a?a.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};Ac.prototype=Object.create(qc.prototype),Ac.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.angle,e=this.phase,f=this.ratchet,g=c.a-b.a,h=d-g,i=0;h*f>0?i=h:this.angle=Math.floor((g-e)/f)*f+e,this.iSum=1/(b.i_inv+c.i_inv);var j=this.maxBias;this.bias=l(-pc(this.errorBias,a)*i/a,-j,j),this.jMax=this.maxForce*a,this.bias||(this.jAcc=0)},Ac.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Ac.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=b.w-a.w,d=this.ratchet,e=-(this.bias+c)*this.iSum,f=this.jAcc;this.jAcc=l((f+e)*d,0,this.jMax*Math.abs(d))/d,e=this.jAcc-f,a.w-=e*a.i_inv,b.w+=e*b.i_inv}},Ac.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var Bc=a.GearJoint=function(a,b,c,d){qc.call(this,a,b),this.phase=c,this.ratio=d,this.ratio_inv=1/d,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Bc.prototype=Object.create(qc.prototype),Bc.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=l(-pc(this.errorBias,a)*(c.a*this.ratio-b.a-this.phase)/a,-d,d),this.jMax=this.maxForce*a},Bc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv*this.ratio_inv,c.w+=d*c.i_inv},Bc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w*this.ratio-a.w,d=(this.bias-c)*this.iSum,e=this.jAcc;this.jAcc=l(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv*this.ratio_inv,b.w+=d*b.i_inv},Bc.prototype.getImpulse=function(){return Math.abs(this.jAcc)},Bc.prototype.setRatio=function(a){this.ratio=a,this.ratio_inv=1/a,this.activateBodies()};var Cc=a.SimpleMotor=function(a,b,c){qc.call(this,a,b),this.rate=c,this.jAcc=0,this.iSum=this.jMax=0};Cc.prototype=Object.create(qc.prototype),Cc.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*a},Cc.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b,d=this.jAcc*a;b.w-=d*b.i_inv,c.w+=d*c.i_inv},Cc.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=b.w-a.w+this.rate,d=-c*this.iSum,e=this.jAcc;this.jAcc=l(e+d,-this.jMax,this.jMax),d=this.jAcc-e,a.w-=d*a.i_inv,b.w+=d*b.i_inv},Cc.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}();