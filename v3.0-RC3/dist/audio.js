if(cc.sys._supportWebAudio){var _ctx=cc.webAudioContext=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);cc.WebAudio=cc.Class.extend({_events:null,_buffer:null,_sourceNode:null,_volumeNode:null,src:null,preload:null,autoplay:null,controls:null,mediagroup:null,currentTime:0,startTime:0,duration:0,_loop:null,_volume:1,_pauseTime:0,_paused:!1,_stopped:!0,_loadState:-1,ctor:function(a){var b=this;b._events={},b.src=a,b._volumeNode=_ctx.createGain?_ctx.createGain():_ctx.createGainNode(),b._onSuccess1=b._onSuccess.bind(this),b._onError1=b._onError.bind(this)},_play:function(a){var b=this,c=b._sourceNode=_ctx.createBufferSource(),d=b._volumeNode;if(a=a||0,c.buffer=b._buffer,d.gain.value=b._volume,c.connect(d),d.connect(_ctx.destination),c.loop=b._loop,c._stopped=!1,c.playbackState||(c.onended=function(){this._stopped=!0}),b._paused=!1,b._stopped=!1,c.start)c.start(0,a);else if(c.noteGrainOn){var e=c.buffer.duration;b.loop?c.noteGrainOn(0,a,e):c.noteGrainOn(0,a,e-a)}else c.noteOn(0);b._pauseTime=0},_stop:function(){var a=this,b=a._sourceNode;a._stopped||(b.stop?b.stop(0):b.noteOff(0),a._stopped=!0)},play:function(){var a=this;if(-1==a._loadState)return void(a._loadState=0);if(1==a._loadState){var b=a._sourceNode;(a._stopped||!b||2!=b.playbackState&&b._stopped)&&(a.startTime=_ctx.currentTime,this._play(0))}},pause:function(){this._pauseTime=_ctx.currentTime,this._paused=!0,this._stop()},resume:function(){var a=this;if(a._paused){var b=a._buffer?(a._pauseTime-a.startTime)%a._buffer.duration:0;this._play(b)}},stop:function(){this._pauseTime=0,this._paused=!1,this._stop()},load:function(){var a=this;if(1!=a._loadState){a._loadState=-1,a.played=!1,a.ended=!0;var b=new XMLHttpRequest;b.open("GET",a.src,!0),b.responseType="arraybuffer",b.onload=function(){_ctx.decodeAudioData(b.response,a._onSuccess1,a._onError1)},b.send()}},addEventListener:function(a,b){this._events[a]=b.bind(this)},removeEventListener:function(a){delete this._events[a]},canplay:function(){return cc.sys._supportWebAudio},_onSuccess:function(a){var b=this;b._buffer=a;var c=b._events.success,d=b._events.canplaythrough;c&&c(),d&&d(),(0==b._loadState||"autoplay"==b.autoplay||1==b.autoplay)&&b._play(),b._loadState=1},_onError:function(){var a=this._events.error;a&&a(),this._loadState=-2},cloneNode:function(){var a=this,b=new cc.WebAudio(a.src);return b.volume=a.volume,b._loadState=a._loadState,b._buffer=a._buffer,(0==b._loadState||-1==b._loadState)&&b.load(),b}});var _p=cc.WebAudio.prototype;_p.loop,cc.defineGetterSetter(_p,"loop",function(){return this._loop},function(a){this._loop=a,this._sourceNode&&(this._sourceNode.loop=a)}),_p.volume,cc.defineGetterSetter(_p,"volume",function(){return this._volume},function(a){this._volume=a,this._volumeNode.gain.value=a}),_p.paused,cc.defineGetterSetter(_p,"paused",function(){return this._paused}),_p.ended,cc.defineGetterSetter(_p,"ended",function(){var a=this._sourceNode;return this._paused?!1:this._stopped&&!a?!0:null==a.playbackState?a._stopped:3==a.playbackState}),_p.played,cc.defineGetterSetter(_p,"played",function(){var a=this._sourceNode;return a&&(2==a.playbackState||!a._stopped)})}cc.AudioEngine=cc.Class.extend({_soundSupported:!1,_currMusic:null,_currMusicPath:null,_musicPlayState:0,_audioID:0,_effects:{},_audioPool:{},_effectsVolume:1,_maxAudioInstance:5,_effectPauseCb:null,_playings:[],ctor:function(){var a=this;a._soundSupported=cc._audioLoader._supportedAudioTypes.length>0,a._effectPauseCb&&(a._effectPauseCb=a._effectPauseCb.bind(a))},willPlayMusic:function(){return!1},getEffectsVolume:function(){return this._effectsVolume},playMusic:function(a,b){var c=this;if(c._soundSupported){var d=c._currMusic;d&&this._stopAudio(d),cc.sys.isMobile&&cc.sys.os==cc.sys.OS_IOS?(d=c._getAudioByUrl(a),c._currMusic=d.cloneNode(),c._currMusicPath=a):a!=c._currMusicPath&&(d=c._getAudioByUrl(a),c._currMusic=d,c._currMusicPath=a),c._currMusic&&(c._currMusic.loop=b||!1,c._playMusic(c._currMusic))}},_getAudioByUrl:function(a){var b=cc.loader,c=b.getRes(a);return c||(b.load(a),c=b.getRes(a)),c},_playMusic:function(a){a.ended||(a.stop?a.stop():(a.pause(),a.readyState>2&&(a.currentTime=0))),this._musicPlayState=2,a.play()},stopMusic:function(a){if(this._musicPlayState>0){var b=this._currMusic;if(!b)return;if(!this._stopAudio(b))return;a&&cc.loader.release(this._currMusicPath),this._currMusic=null,this._currMusicPath=null,this._musicPlayState=0}},_stopAudio:function(a){return a&&!a.ended?(a.stop?a.stop():(a.pause(),a.readyState>2&&a.duration&&1/0!=a.duration&&(a.currentTime=a.duration)),!0):!1},pauseMusic:function(){2==this._musicPlayState&&(this._currMusic.pause(),this._musicPlayState=1)},resumeMusic:function(){if(1==this._musicPlayState){var a=this._currMusic;this._resumeAudio(a),this._musicPlayState=2}},_resumeAudio:function(a){a&&!a.ended&&(a.resume?a.resume():a.play())},rewindMusic:function(){this._currMusic&&this._playMusic(this._currMusic)},getMusicVolume:function(){return 0==this._musicPlayState?0:this._currMusic.volume},setMusicVolume:function(a){this._musicPlayState>0&&(this._currMusic.volume=Math.min(Math.max(a,0),1))},isMusicPlaying:function(){return 2==this._musicPlayState&&this._currMusic&&!this._currMusic.ended},_getEffectList:function(a){var b=this._audioPool[a];return b||(b=this._audioPool[a]=[]),b},_getEffect:function(a){var b,c=this;if(!c._soundSupported)return null;var d=this._getEffectList(a);if(cc.sys.isMobile&&cc.sys.os==cc.sys.OS_IOS)b=this._getEffectAudio(d,a);else{for(var e=0,f=d.length;f>e;e++){var g=d[e];if(g.ended){b=g,b.readyState>2&&(b.currentTime=0),window.chrome&&b.load();break}}b||(b=this._getEffectAudio(d,a),b&&d.push(b))}return b},_getEffectAudio:function(a,b){var c;return a.length>=this._maxAudioInstance?(cc.log("Error: "+b+" greater than "+this._maxAudioInstance),null):(c=this._getAudioByUrl(b))?(c=c.cloneNode(!0),this._effectPauseCb&&cc._addEventListener(c,"pause",this._effectPauseCb),c.volume=this._effectsVolume,c):null},playEffect:function(a,b){var c=this._getEffect(a);if(!c)return null;c.loop=b||!1,c.play();var d=this._audioID++;return this._effects[d]=c,d},setEffectsVolume:function(a){a=this._effectsVolume=Math.min(Math.max(a,0),1);var b=this._effects;for(var c in b)b[c].volume=a},pauseEffect:function(a){var b=this._effects[a];b&&!b.ended&&b.pause()},pauseAllEffects:function(){var a=this._effects;for(var b in a){var c=a[b];c.ended||c.pause()}},resumeEffect:function(a){this._resumeAudio(this._effects[a])},resumeAllEffects:function(){var a=this._effects;for(var b in a)this._resumeAudio(a[b])},stopEffect:function(a){this._stopAudio(this._effects[a]),delete this._effects[a]},stopAllEffects:function(){var a=this._effects;for(var b in a)this._stopAudio(a[b]),delete a[b]},unloadEffect:function(a){var b=cc.loader,c=this._effects,d=this._getEffectList(a);if(b.release(a),0!=d.length){var e=d[0].src;delete this._audioPool[a];for(var f in c)c[f].src==e&&(this._stopAudio(c[f]),delete c[f])}},end:function(){this.stopMusic(),this.stopAllEffects()},_pausePlaying:function(){var a,b=this,c=b._effects;for(var d in c)a=c[d],!a||a.ended||a.paused||(b._playings.push(a),a.pause());b.isMusicPlaying()&&(b._playings.push(b._currMusic),b._currMusic.pause())},_resumePlaying:function(){for(var a=this,b=this._playings,c=0,d=b.length;d>c;c++)a._resumeAudio(b[c]);b.length=0}}),!cc.sys._supportWebAudio&&cc.sys._supportMultipleAudio<0&&(cc.AudioEngineForSingle=cc.AudioEngine.extend({_waitingEffIds:[],_pausedEffIds:[],_currEffect:null,_maxAudioInstance:2,_effectCache4Single:{},_needToResumeMusic:!1,_expendTime4Music:0,_isHiddenMode:!1,_playMusic:function(a){this._stopAllEffects(),this._super(a)},resumeMusic:function(){var a=this;1==a._musicPlayState&&(a._stopAllEffects(),a._needToResumeMusic=!1,a._expendTime4Music=0,a._super())},playEffect:function(a,b){var c=this,d=c._currEffect,e=b?c._getEffect(a):c._getSingleEffect(a);if(!e)return null;e.loop=b||!1;var f=c._audioID++;return c._effects[f]=e,c.isMusicPlaying()&&(c.pauseMusic(),c._needToResumeMusic=!0),d?(d!=e&&c._waitingEffIds.push(c._currEffectId),c._waitingEffIds.push(f),d.pause()):(c._currEffect=e,c._currEffectId=f,e.play()),f},pauseEffect:function(){cc.log("pauseEffect not supported in single audio mode!")},pauseAllEffects:function(){var a=this,b=a._waitingEffIds,c=a._pausedEffIds,d=a._currEffect;if(d){for(var e=0,f=b.length;f>e;e++)c.push(b[e]);b.length=0,c.push(a._currEffectId),d.pause()}},resumeEffect:function(){cc.log("resumeEffect not supported in single audio mode!")},resumeAllEffects:function(){var a=this,b=a._waitingEffIds,c=a._pausedEffIds;a.isMusicPlaying()&&(a.pauseMusic(),a._needToResumeMusic=!0);for(var d=0,e=c.length;e>d;d++)b.push(c[d]);if(c.length=0,!a._currEffect&&b.length>=0){var f=b.pop(),g=a._effects[f];g&&(a._currEffectId=f,a._currEffect=g,a._resumeAudio(g))}},stopEffect:function(a){var b=this,c=b._currEffect,d=b._waitingEffIds,e=b._pausedEffIds;if(c&&this._currEffectId==a)this._stopAudio(c);else{var f=d.indexOf(a);f>=0?d.splice(f,1):(f=e.indexOf(a),f>=0&&e.splice(f,1))}},stopAllEffects:function(){var a=this;a._stopAllEffects(),!a._currEffect&&a._needToResumeMusic&&(a._resumeAudio(a._currMusic),a._musicPlayState=2,a._needToResumeMusic=!1,a._expendTime4Music=0)},unloadEffect:function(a){var b=this,c=cc.loader,d=b._effects,e=b._effectCache4Single,f=b._getEffectList(a),g=b._currEffect;if(c.release(a),0!=f.length||e[a]){var h=f.length>0?f[0].src:e[a].src;delete b._audioPool[a],delete e[a];for(var i in d)d[i].src==h&&delete d[i];g&&g.src==h&&b._stopAudio(g)}},_getSingleEffect:function(a){var b=this,c=b._effectCache4Single[a],d=(cc.loader,b._waitingEffIds),e=b._pausedEffIds,f=b._effects;if(c)c.readyState>2&&(c.currentTime=0);else{if(c=b._getAudioByUrl(a),!c)return null;c=c.cloneNode(!0),b._effectPauseCb&&cc._addEventListener(c,"pause",b._effectPauseCb),c.volume=b._effectsVolume,b._effectCache4Single[a]=c}for(var g=0,h=d.length;h>g;)f[d[g]]==c?d.splice(g,1):g++;for(var g=0,h=e.length;h>g;)f[e[g]]==c?e.splice(g,1):g++;return c._isToPlay=!0,c},_stopAllEffects:function(){var a=this,b=a._currEffect,c=a._audioPool,d=a._effectCache4Single,e=a._waitingEffIds,f=a._pausedEffIds;if(b||0!=e.length||0!=f.length){for(var g in d){var h=d[g];h.readyState>2&&h.duration&&1/0!=h.duration&&(h.currentTime=h.duration)}e.length=0,f.length=0;for(var g in c)for(var i=c[g],j=0,k=i.length;k>j;j++){var h=i[j];h.loop=!1,h.readyState>2&&h.duration&&1/0!=h.duration&&(h.currentTime=h.duration)}b&&a._stopAudio(b)}},_effectPauseCb:function(){var a=this;if(!a._isHiddenMode){var b=a._getWaitingEffToPlay();if(b)b._isToPlay?(delete b._isToPlay,b.play()):a._resumeAudio(b);else if(a._needToResumeMusic){var c=a._currMusic;if(c.readyState>2&&c.duration&&1/0!=c.duration){var d=c.currentTime+a._expendTime4Music;d-=c.duration*(d/c.duration|0),c.currentTime=d}a._expendTime4Music=0,a._resumeAudio(c),a._musicPlayState=2,a._needToResumeMusic=!1}}},_getWaitingEffToPlay:function(){var a=this,b=a._waitingEffIds,c=a._effects,d=a._currEffect,e=d?d.currentTime-(d.startTime||0):0;for(a._expendTime4Music+=e;;){if(0==b.length)break;var f=b.pop(),g=c[f];if(g){if(g._isToPlay||g.loop||g.duration&&g.currentTime+e<g.duration){if(a._currEffectId=f,a._currEffect=g,!g._isToPlay&&g.readyState>2&&g.duration&&1/0!=g.duration){var h=g.currentTime+e;h-=g.duration*(h/g.duration|0),g.currentTime=h}return g._isToPlay=!1,g}g.readyState>2&&g.duration&&1/0!=g.duration&&(g.currentTime=g.duration)}}return a._currEffectId=null,a._currEffect=null,null},_pausePlaying:function(){var a=this,b=a._currEffect;a._isHiddenMode=!0;var c=2==a._musicPlayState?a._currMusic:b;c&&(a._playings.push(c),c.pause())},_resumePlaying:function(){var a=this,b=a._playings;a._isHiddenMode=!1,b.length>0&&(a._resumeAudio(b[0]),b.length=0)}})),cc._audioLoader={_supportedAudioTypes:null,getBasePath:function(){return cc.loader.audioPath},_load:function(a,b,c,d,e,f,g){var h=this,i=cc.loader,j=cc.path,k=this._supportedAudioTypes,l="";if(0==k.length)return g("can not support audio!");if(-1==d)l=(j.extname(a)||"").toLowerCase(),h.audioTypeSupported(l)||(l=k[0],d=0);else{if(!(d<k.length))return g("can not found the resource of audio! Last match url is : "+a);l=k[d]}if(e.indexOf(l)>=0)return h._load(a,b,c,d+1,e,f,g);a=j.changeExtname(a,l),e.push(l);var m=d==k.length-1;f=h._loadAudio(a,f,function(i){return i?h._load(a,b,c,d+1,e,f,g):void g(null,f)},m),i.cache[b]=f},audioTypeSupported:function(a){return a?this._supportedAudioTypes.indexOf(a.toLowerCase())>=0:!1},_loadAudio:function(a,b,c,d){var e;e="object"!=typeof window.cc&&"firefox"==cc.sys.browserType?Audio:"file://"==location.origin?Audio:cc.WebAudio||Audio,2==arguments.length?(c=b,b=new e):arguments.length>3&&!b&&(b=new e),b.src=a,b.preload="auto";var f=navigator.userAgent;if(/Mobile/.test(f)&&(/iPhone OS/.test(f)||/iPad/.test(f)||/Firefox/.test(f))||/MSIE/.test(f))b.load(),c(null,b);else{var g="canplaythrough",h="error";cc._addEventListener(b,g,function(){c(null,b),this.removeEventListener(g,arguments.callee,!1),this.removeEventListener(h,arguments.callee,!1)},!1),cc._addEventListener(b,h,function(){c("load "+a+" failed"),d&&(this.removeEventListener(g,arguments.callee,!1),this.removeEventListener(h,arguments.callee,!1))},!1),b.load()}return b},load:function(a,b,c,d){var e=[];this._load(a,b,c,-1,e,null,d)}},cc._audioLoader._supportedAudioTypes=function(){var a=cc.newElement("audio"),b=[];if(a.canPlayType){var c=function(b){var c=a.canPlayType(b);return"no"!=c&&""!=c};c('audio/ogg; codecs="vorbis"')&&b.push(".ogg"),c("audio/mpeg")&&b.push(".mp3"),c('audio/wav; codecs="1"')&&b.push(".wav"),c("audio/mp4")&&b.push(".mp4"),(c("audio/x-m4a")||c("audio/aac"))&&b.push(".m4a")}return b}(),cc.loader.register(["mp3","ogg","wav","mp4","m4a"],cc._audioLoader),cc.audioEngine=cc.AudioEngineForSingle?new cc.AudioEngineForSingle:new cc.AudioEngine,cc.eventManager.addCustomListener(cc.game.EVENT_HIDE,function(){cc.audioEngine._pausePlaying()}),cc.eventManager.addCustomListener(cc.game.EVENT_SHOW,function(){cc.audioEngine._resumePlaying()});