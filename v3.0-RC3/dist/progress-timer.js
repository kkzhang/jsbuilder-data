cc.ProgressTimer=cc.Node.extend({_type:null,_percentage:0,_sprite:null,_midPoint:null,_barChangeRate:null,_reverseDirection:!1,_className:"ProgressTimer",getMidpoint:function(){return cc.p(this._midPoint.x,this._midPoint.y)},setMidpoint:function(a){this._midPoint=cc.pClamp(a,cc.p(0,0),cc.p(1,1))},getBarChangeRate:function(){return cc.p(this._barChangeRate.x,this._barChangeRate.y)},setBarChangeRate:function(a){this._barChangeRate=cc.pClamp(a,cc.p(0,0),cc.p(1,1))},getType:function(){return this._type},getPercentage:function(){return this._percentage},getSprite:function(){return this._sprite},setPercentage:function(a){this._percentage!=a&&(this._percentage=cc.clampf(a,0,100),this._updateProgress())},setOpacityModifyRGB:function(){},isOpacityModifyRGB:function(){return!1},isReverseDirection:function(){return this._reverseDirection},_boundaryTexCoord:function(a){if(a<cc.ProgressTimer.TEXTURE_COORDS_COUNT){var b=cc.ProgressTimer.TEXTURE_COORDS;return this._reverseDirection?cc.p(b>>7-(a<<1)&1,b>>7-((a<<1)+1)&1):cc.p(b>>(a<<1)+1&1,b>>(a<<1)&1)}return cc.p(0,0)},_origin:null,_startAngle:270,_endAngle:270,_radius:0,_counterClockWise:!1,_barRect:null,_vertexDataCount:0,_vertexData:null,_vertexArrayBuffer:null,_vertexWebGLBuffer:null,_vertexDataDirty:!1,ctor:null,_ctorForCanvas:function(a){cc.Node.prototype.ctor.call(this),this._type=cc.ProgressTimer.TYPE_RADIAL,this._percentage=0,this._midPoint=cc.p(0,0),this._barChangeRate=cc.p(0,0),this._reverseDirection=!1,this._sprite=null,this._origin=cc.p(0,0),this._startAngle=270,this._endAngle=270,this._radius=0,this._counterClockWise=!1,this._barRect=cc.rect(0,0,0,0),a&&this._initWithSpriteForCanvas(a)},_ctorForWebGL:function(a){cc.Node.prototype.ctor.call(this),this._type=cc.ProgressTimer.TYPE_RADIAL,this._percentage=0,this._midPoint=cc.p(0,0),this._barChangeRate=cc.p(0,0),this._reverseDirection=!1,this._sprite=null,this._vertexWebGLBuffer=cc._renderContext.createBuffer(),this._vertexDataCount=0,this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataDirty=!1,a&&this._initWithSpriteForWebGL(a)},setColor:function(a){this._sprite.color=a,this._updateColor()},setOpacity:function(a){this._sprite.opacity=a,this._updateColor()},getColor:function(){return this._sprite.color},getOpacity:function(){return this._sprite.opacity},setReverseProgress:null,_setReverseProgressForCanvas:function(a){this._reverseDirection!==a&&(this._reverseDirection=a)},_setReverseProgressForWebGL:function(a){this._reverseDirection!==a&&(this._reverseDirection=a,this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0)},setSprite:null,_setSpriteForCanvas:function(a){this._sprite!=a&&(this._sprite=a,this.width=this._sprite.width,this.height=this._sprite.height)},_setSpriteForWebGL:function(a){a&&this._sprite!=a&&(this._sprite=a,this.width=a.width,this.height=a.height,this._vertexData&&(this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0))},setType:null,_setTypeForCanvas:function(a){a!==this._type&&(this._type=a)},_setTypeForWebGL:function(a){a!==this._type&&(this._vertexData&&(this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0),this._type=a)},setReverseDirection:null,_setReverseDirectionForCanvas:function(a){this._reverseDirection!==a&&(this._reverseDirection=a)},_setReverseDirectionForWebGL:function(a){this._reverseDirection!==a&&(this._reverseDirection=a,this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0)},_textureCoordFromAlphaPoint:function(a){var b=this._sprite;if(!b)return{u:0,v:0};var c=b.quad,d=cc.p(c.bl.texCoords.u,c.bl.texCoords.v),e=cc.p(c.tr.texCoords.u,c.tr.texCoords.v);if(b.textureRectRotated){var f=a.x;a.x=a.y,a.y=f}return{u:d.x*(1-a.x)+e.x*a.x,v:d.y*(1-a.y)+e.y*a.y}},_vertexFromAlphaPoint:function(a){if(!this._sprite)return{x:0,y:0};var b=this._sprite.quad,c=cc.p(b.bl.vertices.x,b.bl.vertices.y),d=cc.p(b.tr.vertices.x,b.tr.vertices.y);return{x:c.x*(1-a.x)+d.x*a.x,y:c.y*(1-a.y)+d.y*a.y}},initWithSprite:null,_initWithSpriteForCanvas:function(a){return this.percentage=0,this.anchorX=.5,this.anchorY=.5,this._type=cc.ProgressTimer.TYPE_RADIAL,this._reverseDirection=!1,this.midPoint=cc.p(.5,.5),this.barChangeRate=cc.p(1,1),this.sprite=a,!0},_initWithSpriteForWebGL:function(a){return this.percentage=0,this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0,this.anchorX=.5,this.anchorY=.5,this._type=cc.ProgressTimer.TYPE_RADIAL,this._reverseDirection=!1,this.midPoint=cc.p(.5,.5),this.barChangeRate=cc.p(1,1),this.sprite=a,this.shaderProgram=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR),!0},draw:null,_drawForCanvas:function(a){var b=a||cc._renderContext,c=this._sprite;"source"!=c._blendFuncStr&&(b.globalCompositeOperation=c._blendFuncStr);var d=cc.view.getScaleX(),e=cc.view.getScaleY();b.globalAlpha=c._displayedOpacity/255;var f=c._rect,g=c._contentSize,h=c._offsetPosition,i=c._drawSize_Canvas,j=0|h.x,k=-h.y-f.height,l=c._textureRect_Canvas;if(i.width=f.width*d,i.height=f.height*e,b.save(),c._flippedX&&(j=-h.x-f.width,b.scale(-1,1)),c._flippedY&&(k=h.y,b.scale(1,-1)),j*=d,k*=e,this._type==cc.ProgressTimer.TYPE_BAR){var m=this._barRect;b.beginPath(),b.rect(m.x*d,m.y*e,m.width*d,m.height*e),b.clip(),b.closePath()}else if(this._type==cc.ProgressTimer.TYPE_RADIAL){var n=this._origin.x*d,o=this._origin.y*e;b.beginPath(),b.arc(n,o,this._radius*e,Math.PI/180*this._startAngle,Math.PI/180*this._endAngle,this._counterClockWise),b.lineTo(n,o),b.clip(),b.closePath()}if(c._texture&&l.validRect){var p=c._texture.getHtmlElementObj();c._colorized?b.drawImage(p,0,0,l.width,l.height,j,k,i.width,i.height):b.drawImage(p,l.x,l.y,l.width,l.height,j,k,i.width,i.height)}else if(0!==g.width){var q=this.color;b.fillStyle="rgba("+q.r+","+q.g+","+q.b+",1)",b.fillRect(j,k,g.width*d,g.height*e)}b.restore(),cc.incrementGLDraws(1)},_drawForWebGL:function(a){var b=a||cc._renderContext;if(this._vertexData&&this._sprite){cc.nodeDrawSetup(this);var c=this._sprite.getBlendFunc();cc.glBlendFunc(c.src,c.dst),cc.glEnableVertexAttribs(cc.VERTEX_ATTRIB_FLAG_POS_COLOR_TEX),cc.glBindTexture2D(this._sprite.texture),b.bindBuffer(b.ARRAY_BUFFER,this._vertexWebGLBuffer),this._vertexDataDirty&&(b.bufferData(b.ARRAY_BUFFER,this._vertexArrayBuffer,b.DYNAMIC_DRAW),this._vertexDataDirty=!1);var d=cc.V2F_C4B_T2F.BYTES_PER_ELEMENT;b.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION,2,b.FLOAT,!1,d,0),b.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR,4,b.UNSIGNED_BYTE,!0,d,8),b.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS,2,b.FLOAT,!1,d,12),this._type===cc.ProgressTimer.TYPE_RADIAL?b.drawArrays(b.TRIANGLE_FAN,0,this._vertexDataCount):this._type==cc.ProgressTimer.TYPE_BAR&&(this._reverseDirection?(b.drawArrays(b.TRIANGLE_STRIP,0,this._vertexDataCount/2),b.drawArrays(b.TRIANGLE_STRIP,4,this._vertexDataCount/2),cc.g_NumberOfDraws++):b.drawArrays(b.TRIANGLE_STRIP,0,this._vertexDataCount)),cc.g_NumberOfDraws++}},_updateRadial:function(){if(this._sprite){var a,b,c=this._midPoint,d=this._percentage/100,e=2*cc.PI*(this._reverseDirection?d:1-d),f=cc.p(c.x,1),g=cc.pRotateByAngle(f,c,e),h=0;if(0==d)b=f,h=0;else if(1==d)b=f,h=4;else{var i=cc.FLT_MAX,j=cc.ProgressTimer.TEXTURE_COORDS_COUNT;for(a=0;j>=a;++a){var k=(a+(j-1))%j,l=this._boundaryTexCoord(a%j),m=this._boundaryTexCoord(k);0==a?m=cc.pLerp(l,m,1-c.x):4==a&&(l=cc.pLerp(l,m,1-c.x));var n=cc.p(0,0);if(cc.pLineIntersect(l,m,c,g,n)){if(!(0!=a&&4!=a||0<=n.x&&n.x<=1))continue;n.y>=0&&n.y<i&&(i=n.y,h=a)}}b=cc.pAdd(c,cc.pMult(cc.pSub(g,c),i))}var o=!0;if(this._vertexDataCount!=h+3&&(o=!1,this._vertexData=null,this._vertexArrayBuffer=null,this._vertexDataCount=0),!this._vertexData){this._vertexDataCount=h+3;var p=this._vertexDataCount,q=cc.V2F_C4B_T2F.BYTES_PER_ELEMENT;this._vertexArrayBuffer=new ArrayBuffer(p*q);var r=[];for(a=0;p>a;a++)r[a]=new cc.V2F_C4B_T2F(null,null,null,this._vertexArrayBuffer,a*q);if(this._vertexData=r,!this._vertexData)return void cc.log("cc.ProgressTimer._updateRadial() : Not enough memory")}this._updateColor();var s=this._vertexData;if(!o)for(s[0].texCoords=this._textureCoordFromAlphaPoint(c),s[0].vertices=this._vertexFromAlphaPoint(c),s[1].texCoords=this._textureCoordFromAlphaPoint(f),s[1].vertices=this._vertexFromAlphaPoint(f),a=0;h>a;a++){var t=this._boundaryTexCoord(a);s[a+2].texCoords=this._textureCoordFromAlphaPoint(t),s[a+2].vertices=this._vertexFromAlphaPoint(t)}s[this._vertexDataCount-1].texCoords=this._textureCoordFromAlphaPoint(b),s[this._vertexDataCount-1].vertices=this._vertexFromAlphaPoint(b)}},_updateBar:function(){if(this._sprite){var a,b=this._percentage/100,c=this._barChangeRate,d=cc.pMult(cc.p(1-c.x+b*c.x,1-c.y+b*c.y),.5),e=cc.pSub(this._midPoint,d),f=cc.pAdd(this._midPoint,d);e.x<0&&(f.x+=-e.x,e.x=0),f.x>1&&(e.x-=f.x-1,f.x=1),e.y<0&&(f.y+=-e.y,e.y=0),f.y>1&&(e.y-=f.y-1,f.y=1);var g;if(this._reverseDirection){if(!this._vertexData){this._vertexDataCount=8;var h=cc.V2F_C4B_T2F.BYTES_PER_ELEMENT,i=8;this._vertexArrayBuffer=new ArrayBuffer(i*h);var j=[];for(a=0;i>a;a++)j[a]=new cc.V2F_C4B_T2F(null,null,null,this._vertexArrayBuffer,a*h);j[0].texCoords=this._textureCoordFromAlphaPoint(cc.p(0,1)),j[0].vertices=this._vertexFromAlphaPoint(cc.p(0,1)),j[1].texCoords=this._textureCoordFromAlphaPoint(cc.p(0,0)),j[1].vertices=this._vertexFromAlphaPoint(cc.p(0,0)),j[6].texCoords=this._textureCoordFromAlphaPoint(cc.p(1,1)),j[6].vertices=this._vertexFromAlphaPoint(cc.p(1,1)),j[7].texCoords=this._textureCoordFromAlphaPoint(cc.p(1,0)),j[7].vertices=this._vertexFromAlphaPoint(cc.p(1,0)),this._vertexData=j}g=this._vertexData,g[2].texCoords=this._textureCoordFromAlphaPoint(cc.p(e.x,f.y)),g[2].vertices=this._vertexFromAlphaPoint(cc.p(e.x,f.y)),g[3].texCoords=this._textureCoordFromAlphaPoint(cc.p(e.x,e.y)),g[3].vertices=this._vertexFromAlphaPoint(cc.p(e.x,e.y)),g[4].texCoords=this._textureCoordFromAlphaPoint(cc.p(f.x,f.y)),g[4].vertices=this._vertexFromAlphaPoint(cc.p(f.x,f.y)),g[5].texCoords=this._textureCoordFromAlphaPoint(cc.p(f.x,e.y)),g[5].vertices=this._vertexFromAlphaPoint(cc.p(f.x,e.y))}else{if(!this._vertexData){this._vertexDataCount=4;var k=cc.V2F_C4B_T2F.BYTES_PER_ELEMENT,l=4;for(this._vertexArrayBuffer=new ArrayBuffer(l*k),this._vertexData=[],a=0;l>a;a++)this._vertexData[a]=new cc.V2F_C4B_T2F(null,null,null,this._vertexArrayBuffer,a*k)}g=this._vertexData,g[0].texCoords=this._textureCoordFromAlphaPoint(cc.p(e.x,f.y)),g[0].vertices=this._vertexFromAlphaPoint(cc.p(e.x,f.y)),g[1].texCoords=this._textureCoordFromAlphaPoint(cc.p(e.x,e.y)),g[1].vertices=this._vertexFromAlphaPoint(cc.p(e.x,e.y)),g[2].texCoords=this._textureCoordFromAlphaPoint(cc.p(f.x,f.y)),g[2].vertices=this._vertexFromAlphaPoint(cc.p(f.x,f.y)),g[3].texCoords=this._textureCoordFromAlphaPoint(cc.p(f.x,e.y)),g[3].vertices=this._vertexFromAlphaPoint(cc.p(f.x,e.y))}this._updateColor()}},_updateColor:function(){if(this._sprite&&this._vertexData){for(var a=this._sprite.quad.tl.colors,b=this._vertexData,c=0,d=this._vertexDataCount;d>c;++c)b[c].colors=a;this._vertexDataDirty=!0}},_updateProgress:null,_updateProgressForCanvas:function(){var a=this._sprite,b=a.width,c=a.height,d=this._midPoint;if(this._type==cc.ProgressTimer.TYPE_RADIAL){this._radius=Math.round(Math.sqrt(b*b+c*c));var e,f,g=!1,h=this._origin;h.x=b*d.x,h.y=-c*d.y,this._reverseDirection?(f=270,e=270-3.6*this._percentage):(e=-90,f=-90+3.6*this._percentage),a._flippedX&&(h.x-=2*b*this._midPoint.x,e=-e,f=-f,e-=180,f-=180,g=!g),a._flippedY&&(h.y+=2*c*this._midPoint.y,g=!g,e=-e,f=-f),this._startAngle=e,this._endAngle=f,this._counterClockWise=g}else{var i=this._barChangeRate,j=this._percentage/100,k=this._barRect,l=cc.size(b*(1-i.x),c*(1-i.y)),m=cc.size((b-l.width)*j,(c-l.height)*j),n=cc.size(l.width+m.width,l.height+m.height),o=cc.p(b*d.x,c*d.y),p=o.x-n.width/2;d.x>.5&&n.width/2>=b-o.x&&(p=b-n.width);var q=o.y-n.height/2;d.y>.5&&n.height/2>=c-o.y&&(q=c-n.height),k.x=0;var r=1;a._flippedX&&(k.x-=n.width,r=-1),p>0&&(k.x+=p*r),k.y=0;var s=1;a._flippedY&&(k.y+=n.height,s=-1),q>0&&(k.y-=q*s),k.width=n.width,k.height=-n.height}},_updateProgressForWebGL:function(){var a=this._type;a===cc.ProgressTimer.TYPE_RADIAL?this._updateRadial():a===cc.ProgressTimer.TYPE_BAR&&this._updateBar(),this._vertexDataDirty=!0}});var _p=cc.ProgressTimer.prototype;cc._renderType==cc._RENDER_TYPE_WEBGL?(_p.ctor=_p._ctorForWebGL,_p.setReverseProgress=_p._setReverseProgressForWebGL,_p.setSprite=_p._setSpriteForWebGL,_p.setType=_p._setTypeForWebGL,_p.setReverseDirection=_p._setReverseDirectionForWebGL,_p.initWithSprite=_p._initWithSpriteForWebGL,_p.draw=_p._drawForWebGL,_p._updateProgress=_p._updateProgressForWebGL):(_p.ctor=_p._ctorForCanvas,_p.setReverseProgress=_p._setReverseProgressForCanvas,_p.setSprite=_p._setSpriteForCanvas,_p.setType=_p._setTypeForCanvas,_p.setReverseDirection=_p._setReverseDirectionForCanvas,_p.initWithSprite=_p._initWithSpriteForCanvas,_p.draw=_p._drawForCanvas,_p._updateProgress=cc.ProgressTimer.prototype._updateProgressForCanvas),_p.midPoint,cc.defineGetterSetter(_p,"midPoint",_p.getMidpoint,_p.setMidpoint),_p.barChangeRate,cc.defineGetterSetter(_p,"barChangeRate",_p.getBarChangeRate,_p.setBarChangeRate),_p.type,cc.defineGetterSetter(_p,"type",_p.getType,_p.setType),_p.percentage,cc.defineGetterSetter(_p,"percentage",_p.getPercentage,_p.setPercentage),_p.sprite,cc.defineGetterSetter(_p,"sprite",_p.getSprite,_p.setSprite),_p.reverseDir,cc.defineGetterSetter(_p,"reverseDir",_p.isReverseDirection,_p.setReverseDirection),cc.ProgressTimer.create=function(a){return new cc.ProgressTimer(a)},cc.ProgressTimer.TEXTURE_COORDS_COUNT=4,cc.ProgressTimer.TEXTURE_COORDS=75,cc.ProgressTimer.TYPE_RADIAL=0,cc.ProgressTimer.TYPE_BAR=1,cc.ProgressTo=cc.ActionInterval.extend({_to:0,_from:0,ctor:function(a,b){cc.ActionInterval.prototype.ctor.call(this),this._to=0,this._from=0,void 0!==b&&this.initWithDuration(a,b)},initWithDuration:function(a,b){return cc.ActionInterval.prototype.initWithDuration.call(this,a)?(this._to=b,!0):!1},clone:function(){var a=new cc.ProgressTo;return a.initWithDuration(this._duration,this._to),a},reverse:function(){return cc.log("cc.ProgressTo.reverse(): reverse hasn't been supported."),null},startWithTarget:function(a){cc.ActionInterval.prototype.startWithTarget.call(this,a),this._from=a.percentage,100==this._from&&(this._from=0)},update:function(a){this.target instanceof cc.ProgressTimer&&(this.target.percentage=this._from+(this._to-this._from)*a)}}),cc.progressTo=function(a,b){return new cc.ProgressTo(a,b)},cc.ProgressTo.create=cc.progressTo,cc.ProgressFromTo=cc.ActionInterval.extend({_to:0,_from:0,ctor:function(a,b,c){cc.ActionInterval.prototype.ctor.call(this),this._to=0,this._from=0,void 0!==c&&this.initWithDuration(a,b,c)},initWithDuration:function(a,b,c){return cc.ActionInterval.prototype.initWithDuration.call(this,a)?(this._to=c,this._from=b,!0):!1},clone:function(){var a=new cc.ProgressFromTo;return a.initWithDuration(this._duration,this._from,this._to),a},reverse:function(){return cc.progressFromTo(this._duration,this._to,this._from)},startWithTarget:function(a){cc.ActionInterval.prototype.startWithTarget.call(this,a)},update:function(a){this.target instanceof cc.ProgressTimer&&(this.target.percentage=this._from+(this._to-this._from)*a)}}),cc.progressFromTo=function(a,b,c){return new cc.ProgressFromTo(a,b,c)},cc.ProgressFromTo.create=cc.progressFromTo;