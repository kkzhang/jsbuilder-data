var gaf=gaf||{};gaf.COMPRESSION_NONE=4669766,gaf.COMPRESSION_ZIP=4669763,gaf.IDNONE=4294967295,gaf.FIRST_FRAME_INDEX=0,gaf.EFFECT_DROP_SHADOW=0,gaf.EFFECT_BLUR=1,gaf.EFFECT_GLOW=2,gaf.EFFECT_COLOR_MATRIX=6,gaf.ACTION_STOP=0,gaf.ACTION_PLAY=1,gaf.ACTION_GO_TO_AND_STOP=2,gaf.ACTION_GO_TO_AND_PLAY=3,gaf.ACTION_DISPATCH_EVENT=4,gaf.PI_FRAME=0,gaf.PI_EVENT_TYPE=0,gaf.TYPE_TEXTURE=0,gaf.TYPE_TEXT_FIELD=1,gaf.TYPE_TIME_LINE=2,gaf.UNIFORM_BLUR_TEXEL_OFFSET="u_step",gaf.UNIFORM_GLOW_TEXEL_OFFSET="u_step",gaf.UNIFORM_GLOW_COLOR="u_glowColor",gaf.UNIFORM_ALPHA_TINT_MULT="colorTransformMult",gaf.UNIFORM_ALPHA_TINT_OFFSET="colorTransformOffsets",gaf.UNIFORM_ALPHA_COLOR_MATRIX_BODY="colorMatrix",gaf.UNIFORM_ALPHA_COLOR_MATRIX_APPENDIX="colorMatrix2";var gaf=gaf||{};gaf._tmp=gaf._tmp||{},gaf._initialized=!1,gaf.CCGAFLoader=function(){this.load=function(a,b,c,d){gaf._initialized||gaf._setup();var e=new gaf.Loader;e.LoadFile(a,function(a){d(null,a)})}},gaf._setup=function(){gaf._setupShaders(),gaf._initialized=!0},cc.loader.register(".gaf",new gaf.CCGAFLoader),gaf.CGAffineTransformCocosFormatFromFlashFormat=function(a){var b={};return b.a=a.a,b.b=-a.b,b.c=-a.c,b.d=a.d,b.tx=a.tx,b.ty=-a.ty,b},gaf._AssetPreload=function(){this[0]=this.End,this[1]=this.Atlases,this[2]=this.AnimationMasks,this[3]=this.AnimationObjects,this[4]=this.AnimationFrames,this[5]=this.NamedParts,this[6]=this.Sequences,this[7]=this.TextFields,this[8]=this.Atlases,this[9]=this.Stage,this[10]=this.AnimationObjects,this[11]=this.AnimationMasks,this[12]=this.AnimationFrames,this[13]=this.TimeLine},gaf._AssetPreload.prototype.End=function(a,b,c){c&&(c.getFps=function(){return a.getSceneFps()})},gaf._AssetPreload.prototype.Tag=function(a,b,c){this[b.tagId].call(this,a,b.content,c)},gaf._AssetPreload.prototype.Tags=function(a,b,c){var d=this;b.forEach(function(b){d.Tag(a,b,c)})},gaf._AssetPreload.prototype.AtlasCreateFrames=function(a,b,c){a.forEach(function(a){var d=b._atlases[a.atlasId],e=cc.rect(a.origin.x,a.origin.y,a.size.x,a.size.y),f=new cc.SpriteFrame(d,e);f._gafAnchor={x:0-(0-a.pivot.x/a.size.x),y:0+(1-a.pivot.y/a.size.y)},c[a.elementAtlasId]=f})},gaf._AssetPreload.prototype.Atlases=function(a,b,c){var d=a._atlasScales[b.scale]=a._atlasScales[b.scale]||[],e=cc.Director._getInstance().getContentScaleFactor();b.atlases.forEach(function(c){var f=c.id,g=function(){gaf._AssetPreload.AtlasCreateFrames(b.elements,a,d)},h="";c.sources.forEach(function(a){a.csf===e&&(h=a.source)}),cc.assert(h,"GAF Error. Texture for current CSF not found. Reconvert animation with correct parameters."),a._textureLoadDelegate&&(h=a._textureLoadDelegate(h));for(var i=!1,j=a._getSearchPaths(h),k=0,l=j.length;l>k;++k){var m=j[k],n=cc.textureCache.getTextureForKey(m);if(n&&n.isLoaded()){n.handleLoadedTexture(!0),i=!0,a._atlases[f]=n,g();break}}if(!i){var o=function(b){b.handleLoadedTexture(!0),a._onAtlasLoaded(f,b)},p=function(){cc.log("GAF Error. Couldn't find `"+h+"` required by `"+a.getGAFFileName()+"`")};a._atlasesToLoad.hasOwnProperty(f)||(gaf._AtlasLoader.loadArray(j,o,p),a._atlasesToLoad[f]={}),a._onLoadTasks.push(g)}})},gaf._AssetPreload.prototype.AnimationObjects=function(a,b,c){b.forEach(function(b){b.type=void 0===b.type?gaf.TYPE_TEXTURE:b.type,c._objects.push(b.objectId),a._objects[b.objectId]=b})},gaf._AssetPreload.prototype.convertTint=function(a,b){return a?{mult:{r:255*a.redMultiplier,g:255*a.greenMultiplier,b:255*a.blueMultiplier,a:255*b},offset:{r:255*a.redOffset,g:255*a.greenOffset,b:255*a.blueOffset,a:255*a.alphaOffset}}:null},gaf._AssetPreload.prototype.convertState=function(a){return{hasColorTransform:a.hasColorTransform,hasMask:a.hasMask,hasEffect:a.hasEffect,objectIdRef:a.objectIdRef,depth:a.depth,alpha:255*a.alpha,matrix:gaf.CGAffineTransformCocosFormatFromFlashFormat(a.matrix),colorTransform:this.convertTint(a.colorTransform,a.alpha),effect:a.effect,maskObjectIdRef:a.maskObjectIdRef}},gaf._AssetPreload.prototype.AnimationFrames=function(a,b,c){var d=this;cc.assert(c,"Error. Time Line should not be null.");for(var e={},f=[],g={},h=0,i=b.length;i>h;++h){var j=b[h];j.state&&j.state.forEach(function(a){0!==a.alpha?e[a.objectIdRef]=d.convertState(a):e[a.objectIdRef]=null});var k=[];for(var l in e)e.hasOwnProperty(l)&&e[l]&&k.push(e[l]);g=j,f[j.frame-1]={states:k,actions:j.actions||null}}c.getFrames=function(){return f}},gaf._AssetPreload.prototype.NamedParts=function(a,b,c){var d={};b.forEach(function(a){d[a.name]=a.objectId}),c.getNamedParts=function(){return d}},gaf._AssetPreload.prototype.Sequences=function(a,b,c){var d={};b.forEach(function(a){d[a.id]={start:a.start-1,end:a.end}}),c.getSequences=function(){return d}},gaf._AssetPreload.prototype.TextFields=function(a,b,c){},gaf._AssetPreload.prototype.Stage=function(a,b,c){a._sceneFps=b.fps,a._sceneColor=b.color,a._sceneWidth=b.width,a._sceneHeight=b.height},gaf._AssetPreload.prototype.AnimationMasks=function(a,b,c){b.forEach(function(b){b.type=void 0===b.type?gaf.TYPE_TEXTURE:b.type,c._objects.push(b.objectId),a._masks[b.objectId]=b})},gaf._AssetPreload.prototype.TimeLine=function(a,b,c){var d=new gaf._TimeLineProto(a,b.animationFrameCount,b.boundingBox,b.pivotPoint,b.id,b.linkageName);a._pushTimeLine(d),this.Tags(a,b.tags,d)},gaf._AssetPreload=new gaf._AssetPreload;var gaf=gaf||{};gaf.Asset=cc.Class.extend({_className:"GAFAsset",_header:null,_timeLines:null,_textFields:null,_protos:null,_objects:null,_masks:null,_rootTimeLine:null,_textureLoadDelegate:null,_sceneFps:60,_sceneWidth:0,_sceneHeight:0,_sceneColor:0,_gafData:null,_desiredAtlasScale:1,_usedAtlasScale:0,_atlases:null,_onLoadTasks:null,_atlasScales:null,_textureLoaded:!1,_atlasesToLoad:null,_gafName:null,initWithGAFFile:function(a,b){var c=this;this._textureLoadDelegate=b,this._gafName=a;var d=cc.loader.getRes(a);return d?this._init(d):(cc.loader.load(a,function(a,b){a||c._init(b[0])}),!1)},initWithGAFBundle:function(a,b,c){return cc.assert(!1,"initWithGAFBundle is not yet implemented"),!1},setRootTimelineWithName:function(a){for(var b=0,c=this._timeLines.length;c>b;++b){var d=this._timeLines[b];if(d&&d.getLinkageName()===a)return void this._setRootTimeline(d)}},isAssetVersionPlayable:function(){return!0},desiredAtlasScale:function(){return this._desiredAtlasScale},setDesiredAtlasScale:function(a){this._desiredAtlasScale=a;for(var b in this._atlasScales)this._atlasScales.hasOwnProperty(b)&&(0===this._usedAtlasScale||Math.abs(this._usedAtlasScale-a)>Math.abs(b-a))&&(this._usedAtlasScale=b)},createObject:function(){return this._instantiateGaf(this._gafData)},createObjectAndRun:function(a){cc.assert(1===arguments.length,"GAFAsset::createObjectAndRun should have one param");var b=this._instantiateGaf(this._gafData);return b.setLooped(a,!0),b.start(),b},setTextureLoadDelegate:function(a){},getSceneFps:function(){return this._sceneFps},getSceneWidth:function(){},getSceneHeight:function(){},getSceneColor:function(){},setSceneFps:function(a){this._sceneFps=a},setSceneWidth:function(a){},setSceneHeight:function(a){},setSceneColor:function(a){},getHeader:function(){return this._header},getGAFFileName:function(){return this._gafName},ctor:function(){this._header={},this._timeLines=[],this._textFields=[],this._objects=[],this._masks=[],this._protos=[],this._atlases={},this._onLoadTasks=[],this._atlasScales={},this._atlasesToLoad={},arguments.length>0&&this.initWithGAFFile.apply(this,arguments)},_getProtos:function(){return this._protos},_setRootTimeline:function(a){this._rootTimeLine=a,this._header.pivot=a.getPivot(),this._header.frameSize=a.getRect()},_setHeader:function(a){for(var b in a)a.hasOwnProperty(b)&&(this._header[b]=a[b])},_getMajorVerison:function(){return this._header.versionMajor},_init:function(a){var b=this;this._gafData=a,this._setHeader(a.header),this._timeLinesToLink=[],this._getMajorVerison()<4&&this._pushTimeLine(new gaf._TimeLineProto(this,this._header.framesCount,this._header.frameSize,this._header.pivot)),gaf._AssetPreload.Tags(this,a.tags,this._rootTimeLine),this._objects.forEach(function(a){switch(a.type){case gaf.TYPE_TEXTURE:b._protos[a.objectId]||(b._protos[a.objectId]=new gaf._SpriteProto(b,b._atlasScales,a.elementAtlasIdRef));break;case gaf.TYPE_TIME_LINE:b._protos[a.objectId]=b._timeLines[a.elementAtlasIdRef];break;case gaf.TYPE_TEXT_FIELD:b._protos[a.objectId]=b._textFields[a.elementAtlasIdRef];break;default:cc.log("Unknown object type: "+a.type)}}),this._masks.forEach(function(a){if(!b._protos[a.objectId]){var c=null;switch(a.type){case gaf.TYPE_TEXTURE:c=new gaf._SpriteProto(b,b._atlasScales,a.elementAtlasIdRef);break;case gaf.TYPE_TIME_LINE:c=b._timeLines[a.elementAtlasIdRef];break;case gaf.TYPE_TEXT_FIELD:c=b._textFields[a.elementAtlasIdRef]}b._protos[a.objectId]=new gaf._MaskProto(b,c,a.elementAtlasIdRef)}}),this.setDesiredAtlasScale(this._desiredAtlasScale),0===Object.keys(this._atlasesToLoad).length&&(this._textureLoaded=!0,this.dispatchEvent("load"))},_pushTimeLine:function(a){this._timeLines[a.getId()]=a,0===a.getId()&&this._setRootTimeline(a)},_instantiateGaf:function(){var a=null;return a=this._rootTimeLine._gafConstruct()},_onAtlasLoaded:function(a,b){this._atlases[a]=b,delete this._atlasesToLoad[a],0===Object.keys(this._atlasesToLoad).length&&(this._onLoadTasks.forEach(function(a){a()}),this._onLoadTasks.length=0,this._textureLoaded=!0,this.dispatchEvent("load"))},isLoaded:function(){return this._textureLoaded},_getSearchPaths:function(a){var b=this.getGAFFileName().split("/");b[b.length-1]=a;var c=b.join("/");return[a,c]}}),gaf.Asset.create=function(a,b){return new gaf.Asset(a,b)},gaf.Asset.createWithBundle=function(a,b,c){var d=new gaf.Asset;return d.initWithGAFBundle(a,b,c),d},cc.EventHelper.prototype.apply(gaf.Asset.prototype);var gaf=gaf||{};gaf._stateHasCtx=function(a){if(a.hasColorTransform&&(a.colorTransform.offset.r>0||a.colorTransform.offset.g>0||a.colorTransform.offset.b>0||a.colorTransform.offset.a>0))return!0;if(a.hasEffect)for(var b=0,c=a.effect.length;c>b;++b)if(a.effect[b].type===gaf.EFFECT_COLOR_MATRIX)return!0;return!1},gaf.Object=cc.Node.extend({_asset:null,_className:"GAFObject",_id:gaf.IDNONE,_gafproto:null,_parentTimeLine:null,_lastVisibleInFrame:0,_filterStack:null,_cascadeColorMult:null,_cascadeColorOffset:null,_needsCtx:!1,_usedAtlasScale:1,ctor:function(a){1==arguments.length&&(this._usedAtlasScale=a),this._super(),this._cascadeColorMult=cc.color(255,255,255,255),this._cascadeColorOffset=cc.color(0,0,0,0),this._filterStack=[]},setAnimationStartedNextLoopDelegate:function(a){},setAnimationFinishedPlayDelegate:function(a){},setLooped:function(a){},getBoundingBoxForCurrentFrame:function(){return null},setFps:function(a){},getObjectByName:function(a){return null},clearSequence:function(){},getIsAnimationRunning:function(){return!1},getSequences:function(){return[]},gotoAndStop:function(a){},getStartFrame:function(a){return gaf.IDNONE},setFramePlayedDelegate:function(a){},getCurrentFrameIndex:function(){return gaf.IDNONE},getTotalFrameCount:function(){return 0},start:function(){},stop:function(){},isVisibleInCurrentFrame:function(){return!(this._parentTimeLine&&this._parentTimeLine.getCurrentFrameIndex()+1!=this._lastVisibleInFrame)},isDone:function(){return!0},playSequence:function(a,b,c){return!1},isReversed:function(){return!1},setSequenceDelegate:function(a){},setFrame:function(a){return!1},setControlDelegate:function(a){},getEndFrame:function(a){return gaf.IDNONE},pauseAnimation:function(){},gotoAndPlay:function(a){},isLooped:function(){return!1},resumeAnimation:function(){},setReversed:function(a){},hasSequences:function(){return!1},getFps:function(){return 60},setLocator:function(a){},setExternalTransform:function(a){cc.affineTransformEqualToTransform(this._additionalTransform,a)||this.setAdditionalTransform(a)},getExternalTransform:function(){return this._additionalTransform},setAnimationRunning:function(){},_enableTick:function(a){},_resetState:function(){},_updateVisibility:function(a,b){var c=a.hasColorTransform?a.colorTransform.offset.a:0;this.setOpacity(a.alpha+c)},isVisible:function(){return this.getOpacity()>0},visit:function(a){this.isVisibleInCurrentFrame()&&this._super(a)},_getFilters:function(){return null},_processAnimation:function(){},_applyState:function(a,b){this._applyStateSuper(a,b)},_applyStateSuper:function(a,b){if(this._needsCtx=b._needsCtx,this._filterStack.length=0,this._parentTimeLine=b,1!=this._usedAtlasScale){var c=cc.clone(a.matrix);c.tx*=this._usedAtlasScale,c.ty*=this._usedAtlasScale,this.setExternalTransform(c)}else this.setExternalTransform(a.matrix);a.hasEffect&&(this._filterStack=this._filterStack.concat(a.effect),this._needsCtx=!0),b._filterStack&&b._filterStack.length>0&&(this._filterStack=this._filterStack.concat(b._filterStack)),this._filterStack.length>0&&this._filterStack[0].type===gaf.EFFECT_COLOR_MATRIX&&(this._needsCtx=!0),a.hasColorTransform?(this._cascadeColorMult.r=a.colorTransform.mult.r*b._cascadeColorMult.r/255,this._cascadeColorMult.g=a.colorTransform.mult.g*b._cascadeColorMult.g/255,this._cascadeColorMult.b=a.colorTransform.mult.b*b._cascadeColorMult.b/255,this._cascadeColorMult.a=a.colorTransform.mult.a*b._cascadeColorMult.a/255,this._cascadeColorOffset.r=a.colorTransform.offset.r+b._cascadeColorOffset.r,this._cascadeColorOffset.g=a.colorTransform.offset.g+b._cascadeColorOffset.g,this._cascadeColorOffset.b=a.colorTransform.offset.b+b._cascadeColorOffset.b,this._cascadeColorOffset.a=a.colorTransform.offset.a+b._cascadeColorOffset.a):(this._cascadeColorMult.r=b._cascadeColorMult.r,this._cascadeColorMult.g=b._cascadeColorMult.g,this._cascadeColorMult.b=b._cascadeColorMult.b,this._cascadeColorMult.a=a.alpha*(b._cascadeColorMult.a/255),this._cascadeColorOffset.r=b._cascadeColorOffset.r,this._cascadeColorOffset.g=b._cascadeColorOffset.g,this._cascadeColorOffset.b=b._cascadeColorOffset.b,this._cascadeColorOffset.a=b._cascadeColorOffset.a),(this._cascadeColorOffset.r>0||this._cascadeColorOffset.g>0||this._cascadeColorOffset.b>0||this._cascadeColorOffset.a>0)&&(this._needsCtx=!0)},_initRendererCmd:function(){this._renderCmd=cc.renderer.getRenderCmd(this),this._renderCmd._visit=this._renderCmd.visit;var a=this;this._renderCmd.visit=function(b){a.isVisibleInCurrentFrame()&&this._visit(b)}},_getNode:function(){return this},setAnchorPoint:function(a,b){void 0===b?this._super(a.x,a.y-1):this._super(a,b-1)}}),gaf.Object._createNullObject=function(){var a=new gaf.Object;return a.isVisible=function(){return!0},a},gaf.TimeLine=gaf.Object.extend({_className:"GAFTimeLine",_objects:null,_container:null,_animationStartedNextLoopDelegate:null,_animationFinishedPlayDelegate:null,_framePlayedDelegate:null,_sequenceDelegate:null,_fps:60,_frameTime:1/60,_currentSequenceStart:gaf.FIRST_FRAME_INDEX,_currentSequenceEnd:gaf.FIRST_FRAME_INDEX,_totalFrameCount:0,_isRunning:!1,_isLooped:!1,_isReversed:!1,_timeDelta:0,_animationsSelectorScheduled:!1,_currentFrame:gaf.FIRST_FRAME_INDEX,setAnimationStartedNextLoopDelegate:function(a){this._animationStartedNextLoopDelegate=a},setAnimationFinishedPlayDelegate:function(a){this._animationFinishedPlayDelegate=a},setLooped:function(a,b){this._isLooped=a,b&&this._objects.forEach(function(c){c.setLooped(a,b)})},getBoundingBoxForCurrentFrame:function(){var a=null,b=!0;return this._objects.forEach(function(c){if(c.isVisibleInCurrentFrame()&&c.isVisible()){var d=c.getBoundingBoxForCurrentFrame();d||(d=c.getBoundingBox()),b?(b=!1,a=d):a=cc.rectUnion(a,d)}}),cc._rectApplyAffineTransformIn(a,this._container.getNodeToParentTransform())},setFps:function(a){cc.assert(0!==a,"Error! Fps is set to zero."),this._fps=a,this._frameTime=1/a},getObjectByName:function(a){var b=a.split("."),c=null,d=-1,e=this,f={};try{b.forEach(function(a){var b=e._gafproto.getNamedParts();if(!b.hasOwnProperty(a))throw f.lastElement=a,f;d=b[a],c=e._objects[d],e=c})}catch(g){if(g!==f)throw g;return cc.log("Sequence incorrect: `"+a+"` At: `"+f.lastElement+"`"),null}return c},clearSequence:function(){this._currentSequenceStart=gaf.FIRST_FRAME_INDEX,this._currentSequenceEnd=this._gafproto.getTotalFrames()},getIsAnimationRunning:function(){return this._isRunning},gotoAndStop:function(a){var b=0;return b="string"==typeof a?this.getStartFrame(a):a,this.setFrame(b)?(this.setAnimationRunning(!1,!1),!0):!1},gotoAndPlay:function(a){var b=0;return b="string"==typeof a?this.getStartFrame(a):a,this.setFrame(b)?(this.setAnimationRunning(!0,!1),!0):!1},getStartFrame:function(a){var b=this._gafproto.getSequences()[a];return b?b.start:gaf.IDNONE},getEndFrame:function(a){var b=this._gafproto.getSequences()[a];return b?b.end:gaf.IDNONE},setFramePlayedDelegate:function(a){this._framePlayedDelegate=a},getCurrentFrameIndex:function(){return this._showingFrame},getTotalFrameCount:function(){return this._gafproto.getTotalFrames()},start:function(){this._enableTick(!0),this._isRunning||(this._currentFrame=gaf.FIRST_FRAME_INDEX,this.setAnimationRunning(!0,!0))},stop:function(){this._enableTick(!1),this._isRunning&&(this._currentFrame=gaf.FIRST_FRAME_INDEX,this.setAnimationRunning(!1,!0))},isDone:function(){return this._isLooped?!1:this._isReversed?this._currentFrame<gaf.FIRST_FRAME_INDEX-1:this._currentFrame>this._totalFrameCount},getSequences:function(){return this._gafproto.getSequences()},playSequence:function(a,b){var c=this.getStartFrame(a),d=this.getEndFrame(a);return gaf.IDNONE===c||gaf.IDNONE===d?!1:(this._currentSequenceStart=c,this._currentSequenceEnd=d,this._currentFrame<this._currentSequenceStart||this._currentFrame>this._currentSequenceEnd?this._currentFrame=this._currentSequenceStart:this._currentFrame=this._currentSequenceStart,this.setLooped(b,!1),this.resumeAnimation(),!0)},isReversed:function(){return this._isReversed},setSequenceDelegate:function(a){this._sequenceDelegate=a},setFrame:function(a){return a>=gaf.FIRST_FRAME_INDEX&&a<this._totalFrameCount?(this._showingFrame=a,this._currentFrame=a,this._processAnimation(),!0):!1},pauseAnimation:function(){this._isRunning&&this.setAnimationRunning(!1,!1)},isLooped:function(){return this._isLooped},resumeAnimation:function(){this._isRunning||this.setAnimationRunning(!0,!1)},setReversed:function(a){this._isReversed=a},hasSequences:function(){return this._gafproto.getSequences().length>0},getFps:function(){return this._fps},ctor:function(a,b){this._super(b),this._objects=[],cc.assert(a,"Error! Missing mandatory parameter."),this._gafproto=a},setExternalTransform:function(a){cc.affineTransformEqualToTransform(this._container._additionalTransform,a)||this._container.setAdditionalTransform(a)},_init:function(){this.setContentSize(this._gafproto.getBoundingBox()),this._currentSequenceEnd=this._gafproto.getTotalFrames(),this._totalFrameCount=this._currentSequenceEnd,this.setFps(this._gafproto.getFps()),this._container=new cc.Node,this.addChild(this._container);var a=this,b=this._gafproto.getAsset();this._gafproto.getObjects().forEach(function(c){var d=b._getProtos()[c];cc.assert(d,"Error. GAF proto for type: "+c.type+" and reference id: "+c+" not found."),a._objects[c]=d._gafConstruct()})},_enableTick:function(a){!this._animationsSelectorScheduled&&a?(this.schedule(this._processAnimations),this._animationsSelectorScheduled=!0):this._animationsSelectorScheduled&&!a&&(this.unschedule(this._processAnimations),this._animationsSelectorScheduled=!1)},_processAnimations:function(a){for(this._timeDelta+=a;this._timeDelta>=this._frameTime;)this._timeDelta-=this._frameTime,this._step()},_step:function(){if(this._showingFrame=this._currentFrame,!this.getIsAnimationRunning())return void this._processAnimation();if(this._sequenceDelegate){var a;a=this._isReversed?this._getSequenceByFirstFrame(this._currentFrame+1):this._getSequenceByLastFrame(this._currentFrame),a&&this._sequenceDelegate(this,a)}this._isCurrentFrameLastInSequence()&&(this._isLooped?this._animationStartedNextLoopDelegate&&this._animationStartedNextLoopDelegate(this):(this.setAnimationRunning(!1,!1),this._animationFinishedPlayDelegate&&this._animationFinishedPlayDelegate(this))),this._processAnimation(),this._currentFrame=this._nextFrame()},_isCurrentFrameLastInSequence:function(){return this._isReversed?this._currentFrame==this._currentSequenceStart:this._currentFrame==this._currentSequenceEnd-1},_nextFrame:function(){return this._isCurrentFrameLastInSequence()?this._isLooped?this._isReversed?this._currentSequenceEnd-1:this._currentSequenceStart:this._currentFrame:this._currentFrame+(this._isReversed?-1:1)},_processAnimation:function(){this._realizeFrame(this._container,this._currentFrame),this._framePlayedDelegate&&this._framePlayedDelegate(this,this._currentFrame)},_realizeFrame:function(a,b){var c=this,d=c._objects,e=c._gafproto.getFrames();if(!(b>e.length)){var f=e[b];if(f)for(var g=f.states,h=0,i=g.length;i>h;++h){var j=g[h],k=d[j.objectIdRef];if(!k)return;if(j.alpha<0&&k._resetState(),k._updateVisibility(j,c),k.isVisible()){k._applyState(j,c);var l=a;j.hasMask&&(l=d[j.maskObjectIdRef]._getNode(),cc.assert(l,"Error! Mask not found.")),k._lastVisibleInFrame=1+b,gaf.TimeLine.rearrangeSubobject(l,k,j.depth),k._step&&k._step()}}}},setAnimationRunning:function(a,b){this._isRunning=a,b&&this._objects.forEach(function(c){c&&c.setAnimationRunning&&c.setAnimationRunning(a,b)})},_getSequenceByLastFrame:function(){var a=this._gafproto.getSequences();for(var b in a)if(a.hasOwnProperty(b)&&a[b].end===frame+1)return b;return""},_resetState:function(){this._super(),this._currentFrame=this._currentSequenceStart},_getSequenceByFirstFrame:function(){var a=this._gafproto.getSequences();for(var b in a)if(a.hasOwnProperty(b)&&a[b].start===frame)return b;return""}}),gaf.TimeLine.rearrangeSubobject=function(a,b,c){var d=b.getParent();d!==a?(b.removeFromParent(!1),a.addChild(b,c)):b.setLocalZOrder(c)},gaf.TextField=gaf.Object.extend({_className:"GAFTextField"}),gaf.Sprite=gaf.Object.extend({_className:"GAFSprite",_hasCtx:!1,_hasFilter:!1,ctor:function(a,b){this._super(b),cc.assert(a,"Error! Missing mandatory parameter."),this._gafproto=a},_init:function(){var a=this._gafproto.getFrame();cc.assert(a instanceof cc.SpriteFrame,"Error. Wrong object type."),this._sprite=new cc.Sprite,this._sprite._renderCmd=this._gafCreateRenderCmd(this._sprite),this._sprite.initWithSpriteFrame(a),this._sprite.setAnchorPoint(this._gafproto.getAnchor()),this.addChild(this._sprite),this._sprite.setOpacityModifyRGB(!0),cc._renderType===cc.game.RENDER_TYPE_WEBGL&&this._sprite.setBlendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA)},_applyState:function(a,b){this._applyStateSuper(a,b),this._needsCtx?(this._hasCtx||(this._enableCtx(),this._hasCtx=!0),this._applyCtxState(a)):(this._hasCtx&&(this._disableCtx(),this._hasCtx=!1),cc.colorEqual(this._sprite._realColor,this._cascadeColorMult)||this._sprite.setColor(this._cascadeColorMult),this._sprite.getOpacity()!=this._cascadeColorMult.a&&this._sprite.setOpacity(this._cascadeColorMult.a))},_enableCtx:function(){this._sprite._renderCmd._enableCtx()},_disableCtx:function(){this._sprite._renderCmd._disableCtx()},_applyCtxState:function(a){this._sprite._renderCmd._applyCtxState(this)},getBoundingBoxForCurrentFrame:function(){var a=this._sprite.getBoundingBox();return cc._rectApplyAffineTransformIn(a,this.getNodeToParentTransform())},_gafCreateRenderCmd:function(a){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new gaf.Sprite.CanvasRenderCmd(a):new gaf.Sprite.WebGLRenderCmd(a)}}),gaf.Mask=gaf.Object.extend({_className:"GAFMask",_clippingNode:null,ctor:function(a){this._super(),cc.assert(a,"Error! Missing mandatory parameter."),this._gafproto=a},_init:function(){var a=this._gafproto.getMaskNodeProto();cc.assert(a,"Error. Mask node for id ref "+this._gafproto.getIdRef()+" not found."),this._maskNode=a._gafConstruct(),this._clippingNode=cc.ClippingNode.create(this._maskNode),this._clippingNode.setAlphaThreshold(.5),this.addChild(this._clippingNode)},setExternalTransform:function(a){cc.affineTransformEqualToTransform(this._maskNode._additionalTransform,a)||this._maskNode.setAdditionalTransform(a)},_getNode:function(){return this._clippingNode}}),function(){gaf.Sprite.CanvasRenderCmd=function(a){cc.Sprite.CanvasRenderCmd.call(this,a),this._hasTintMult=!1,this._hasTintOffset=!1,this._hasCtx=!1,this._tintMult=cc.color(255,255,255,255),this._tintOffset=cc.color(0,0,0,0),this._textureDirty=!1};var a=gaf.Sprite.CanvasRenderCmd.prototype=Object.create(cc.Sprite.CanvasRenderCmd.prototype);a.constructor=gaf.Sprite.CanvasRenderCmd,a._disableCtx=function(){this._hasTintOffset=!1,this._hasCtx=!1,this._textureDirty=!0,this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty),this._tintMult=cc.color(255,255,255,255),this._tintOffset=cc.color(0,0,0,0)},a._enableCtx=function(){},a._applyCtxState=function(a){var b=a._cascadeColorMult,c=a._cascadeColorOffset,d=b.a;this._node.getOpacity()!=d&&this._node.setOpacity(d);var e=!cc.colorEqual(this._tintMult,b);e&&(this._node.setColor(b),this._tintMult=b,this._hasTintMult=255!==b.r||255!==b.g||255!==b.b);var f=this._tintOffset.r!=c.r||this._tintOffset.g!=c.g||this._tintOffset.b!=c.b||this._tintOffset.a!=c.a;f&&(this._tintOffset=c,this._hasTintOffset=0!==c.r||0!==c.g||0!==c.b||0!==c.a),this._textureDirty=e||f,this._textureDirty&&this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty),this._hasCtx=a._filterStack.length>0&&a._filterStack[0].type===gaf.EFFECT_COLOR_MATRIX},a.rendering=function(a,b,c){var d=this._node,e=this._textureCoord,f=this._displayedOpacity/255;if((!d._texture||0!==e.width&&0!==e.height&&d._texture._textureLoaded)&&0!==f){var g,h=a||cc._renderContext,i=h.getContext(),j=d._offsetPosition.x,k=d._rect.height,l=d._rect.width,m=-d._offsetPosition.y-k;h.setTransform(this._worldTransform,b,c),h.setCompositeOperation(this._blendFuncStr),h.setGlobalAlpha(f),(d._flippedX||d._flippedY)&&h.save(),d._flippedX&&(j=-j-l,i.scale(-1,1)),d._flippedY&&(m=d._offsetPosition.y,i.scale(1,-1)),g=d._texture._htmlElementObj,this._colorized?i.drawImage(g,0,0,e.width,e.height,j*b,m*c,l*b,k*c):i.drawImage(g,e.renderX,e.renderY,e.width,e.height,j*b,m*c,l*b,k*c),(d._flippedX||d._flippedY)&&h.restore(),cc.g_NumberOfDraws++}},cc.sys._supportCanvasNewBlendModes&&(a._updateColor=function(){var a=this._displayedColor,b=this._node;if(this._hasTintMult|=255!==a.r||255!==a.g||255!==a.b,this._textureDirty){this._textureDirty=!1,this._colorized&&(this._colorized=!1,b.texture=this._originalTexture);var c,d=b._texture,e=this._textureCoord;if(this._hasTintMult&&d&&e.validRect&&this._originalTexture){if(c=d.getHtmlElementObj(),!c)return;this._colorized=!0,(this._hasTintOffset||this._hasCtx)&&(a=this._tintMult),c=cc.Sprite.CanvasRenderCmd._generateTintImageWithMultiply(this._originalTexture._htmlElementObj,a,e),d=new cc.Texture2D,d.initWithElement(c),d.handleLoadedTexture(),b.texture=d}if(d=b._texture,this._hasTintOffset){var f=cc.textureCache.getTextureColors(this._originalTexture.getHtmlElementObj());if(d&&e.validRect&&this._originalTexture){if(c=d.getHtmlElementObj(),!c)return;if(this._colorized)var g=cc.rect(0,0,e.width,e.height);else g=e;c=this._gafGenerateTintImage(b.texture._htmlElementObj,g,f,this._tintOffset,e),d=new cc.Texture2D,d.initWithElement(c),d.handleLoadedTexture(),b.texture=d,this._colorized=!0}}}},a._gafGenerateTintImage=function(a,b,c,d,e,f){e||(e=cc.rect(0,0,a.width,a.height));var g,h=Math.min(e.width,c[0].width),i=Math.min(e.height,c[0].height),j=f;return j?(g=j.getContext("2d"),g.clearRect(0,0,h,i)):(j=document.createElement("canvas"),j.width=h,j.height=i,g=j.getContext("2d")),g.save(),g.globalCompositeOperation="source-over",g.drawImage(c[2],e.x,e.y,h,i,0,0,h,i),g.globalCompositeOperation="source-in",g.fillStyle="rgba("+Math.round(d.r)+","+Math.round(d.g)+","+Math.round(d.b)+",1)",g.fillRect(0,0,h,i),g.globalCompositeOperation="lighter",g.drawImage(a,b.x,b.y,h,i,0,0,h,i),g.restore(),j})}(),gaf._TimeLineProto=function(a,b,c,d,e,f){e="undefined"!=typeof e?e:0,f=f||"",this._objects=[],this.getTotalFrames=function(){return b},this.getBoundingBox=function(){return c},this.getId=function(){return e},this.getLinkageName=function(){return f},this.getPivot=function(){return d},this.getRect=function(){return c},this.getNamedParts=function(){return{}},this.getSequences=function(){return{}},this.getFrames=function(){return[]},this.getFps=function(){return 60},this.getObjects=function(){return this._objects},this.getAsset=function(){return a},this._gafConstruct=function(){var a=this.getAsset()._usedAtlasScale,b=new gaf.TimeLine(this,a);return b._init(),b}},gaf._SpriteProto=function(a,b,c){this.getFrames=function(){return b},this.getIdRef=function(){return c},this.getAsset=function(){return a},this._gafConstruct=function(){var a=this.getAsset()._usedAtlasScale,b=new gaf.Sprite(this,a);return b._init(),b}},gaf._SpriteProto.prototype.getFrame=function(){var a=this.getAsset()._usedAtlasScale;cc.assert(a,"Error. Atlas scale zero.");var b=this.getFrames()[a];return cc.assert(b,"Error. No frames found for used scale `"+a+"`"),b[this.getIdRef()]},gaf._SpriteProto.prototype.getAnchor=function(){return this.getFrame()._gafAnchor},gaf._MaskProto=function(a,b,c){this.getIdRef=function(){return c},this.getMaskNodeProto=function(){return b},this._gafConstruct=function(){var a=new gaf.Mask(this);return a._init(),a}},gaf.ReadSingleTag=function(a){var b=a.Ushort(),c=gaf.Tags[b],d={};return"undefined"==typeof c?(console.log("GAF. Non implemented tag detected."),gaf.Tags.Default.parse(a,b)):d=c.parse(a,b),d},gaf.ReadTags=function(a){var b=[];try{do{var c=gaf.ReadSingleTag(a);b.push(c)}while(0!=c.tagId)}catch(d){if(!(d instanceof Error&&"GAF format error"==d.message))throw console.log(d.stack),d;console.log("GAF format error:\n"+d.stack)}return b},gaf.Tag=function(){this.Default=Object.create(gaf.Tag.base),this[0]=Object.create(gaf.Tag.End),this[1]=Object.create(gaf.Tag.DefineAtlas),this[2]=Object.create(gaf.Tag.DefineAnimationMasks),this[3]=Object.create(gaf.Tag.DefineAnimationObjects),this[4]=Object.create(gaf.Tag.DefineAnimationFrames),this[5]=Object.create(gaf.Tag.DefineNamedParts),this[6]=Object.create(gaf.Tag.DefineSequences),this[7]=Object.create(gaf.Tag.DefineTextFields),this[8]=Object.create(gaf.Tag.DefineAtlas2),this[9]=Object.create(gaf.Tag.DefineStage),this[10]=Object.create(gaf.Tag.DefineAnimationObjects2),this[11]=Object.create(gaf.Tag.DefineAnimationMasks2),this[12]=Object.create(gaf.Tag.DefineAnimationFrames2),this[13]=Object.create(gaf.Tag.DefineTimeline)},gaf.Tag.base=function(){},gaf.Tag.base.parse=function(a,b){var c=a.Uint();a.startNestedBuffer(c);var d=this.doParse(a);return a.endNestedBuffer(),d.tagName=this.tagName,d.tagId=b,d},gaf.Tag.base.doParse=function(a){return{}},gaf.Tag.End=Object.create(gaf.Tag.base),gaf.Tag.End.tagName="TagEnd",gaf.Tag.DefineAtlas=Object.create(gaf.Tag.base),gaf.Tag.DefineAtlas.tagName="TagDefineAtlas",gaf.Tag.DefineAtlas.doParse=function(a){var b=a.fields("scale","Float","atlases",a.array("Ubyte",a.fields("id","Uint","sources",a.array("Ubyte",a.fields("source","String","csf","Float")))),"elements",a.array("Uint",a.fields("pivot","Point","origin","Point","scale","Float","size","Point","atlasId","Uint","elementAtlasId","Uint")));return{content:b()}},gaf.Tag.DefineAnimationMasks=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationMasks.tagName="TagDefineAnimationMasks",gaf.Tag.DefineAnimationMasks.doParse=function(a){var b=a.array("Uint",a.fields("objectId","Uint","elementAtlasIdRef","Uint")),c={content:b()};return c},gaf.Tag.DefineAnimationObjects=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationObjects.tagName="TagDefineAnimationObjects",gaf.Tag.DefineAnimationObjects.doParse=function(a){var b=a.array("Uint",a.fields("objectId","Uint","elementAtlasIdRef","Uint"));return{content:b()}},gaf.Tag.DefineAnimationFrames=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationFrames.tagName="TagDefineAnimationFrames",gaf.Tag.DefineAnimationFrames.doParse=function(a){var b=a.array("Uint",a.fields("frame","Uint","state",a.array("Uint",a.fields("hasColorTransform","Ubyte","hasMask","Ubyte","hasEffect","Ubyte","objectIdRef","Uint","depth","Int","alpha","Float","matrix","Matrix","colorTransform",a.condition("hasColorTransform",1,a.fields("alphaOffset","Float","redMultiplier","Float","redOffset","Float","greenMultiplier","Float","greenOffset","Float","blueMultiplier","Float","blueOffset","Float")),"effect",a.condition("hasEffect",1,a.array("Ubyte",gaf.Tag._readFilter(a))),"maskObjectIdRef",a.condition("hasMask",1,a.fields("maskObjectIdRef","Uint"))))));
return{content:b()}},gaf.Tag.DefineNamedParts=Object.create(gaf.Tag.base),gaf.Tag.DefineNamedParts.tagName="TagDefineNamedParts",gaf.Tag.DefineNamedParts.doParse=function(a){var b=a.array("Uint",a.fields("objectId","Uint","name","String"));return{content:b()}},gaf.Tag.DefineSequences=Object.create(gaf.Tag.base),gaf.Tag.DefineSequences.tagName="TagDefineSequences",gaf.Tag.DefineSequences.doParse=function(a){var b=a.array("Uint",a.fields("id","String","start","Ushort","end","Ushort"));return{content:b()}},gaf.Tag.DefineTextFields=Object.create(gaf.Tag.base),gaf.Tag.DefineTextFields.tagName="TagDefineTextFields",gaf.Tag.DefineTextFields.doParse=function(a){var b=a.array("Uint",a.fields("id","Uint","pivot","Point","end","Ushort","width","Float","height","Float","text","String","embedFonts","Boolean","multiline","Boolean","wordWrap","Boolean","hasRestrict","Boolean","restrict",a.condition("hasRestrict",1,function(){return a.String}),"editable","Boolean","selectable","Boolean","displayAsPassword","Boolean","maxChars","Uint","align","Uint","blockIndent","Uint","bold","Boolean","bullet","Boolean","color","color","font","String","indent","Uint","italic","Boolean","kerning","Boolean","leading","Uint","leftMargin","Uint","letterSpacing","Float","rightMargin","Uint","size","Uint","tabStops",a.array("Uint",a.fields("value","Uint")),"target","string","underline","Boolean","url","String"));return{content:b()}},gaf.Tag.DefineAtlas2=Object.create(gaf.Tag.base),gaf.Tag.DefineAtlas2.tagName="TagDefineAtlas2",gaf.Tag.DefineAtlas2.doParse=function(a){var b=a.fields("scale","Float","atlases",a.array("Ubyte",a.fields("id","Uint","sources",a.array("Ubyte",a.fields("source","String","csf","Float")))),"elements",a.array("Uint",a.fields("pivot","Point","origin","Point","scale","Float","size","Point","atlasId","Uint","elementAtlasId","Uint","hasScale9Grid","Boolean","scale9GridRect",a.condition("hasScale9Grid",1,function(){return a.Rect()}))));return{content:b()}},gaf.Tag.DefineStage=Object.create(gaf.Tag.base),gaf.Tag.DefineStage.tagName="TagDefineStage",gaf.Tag.DefineStage.doParse=function(a){var b=a.fields("fps","Ubyte","color","color","width","Ushort","height","Ushort");return{content:b()}},gaf.Tag.DefineAnimationObjects2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationObjects2.tagName="TagDefineAnimationObjects2",gaf.Tag.DefineAnimationObjects2.doParse=function(a){var b=a.array("Uint",a.fields("objectId","Uint","elementAtlasIdRef","Uint","type","Ushort"));return{content:b()}},gaf.Tag.DefineAnimationMasks2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationMasks2.tagName="TagDefineAnimationMasks2",gaf.Tag.DefineAnimationMasks2.doParse=function(a){var b=a.array("Uint",a.fields("objectId","Uint","elementAtlasIdRef","Uint","type","Ushort"));return{content:b()}},gaf.Tag.DefineAnimationFrames2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationFrames2.tagName="TagDefineAnimationFrames2",gaf.Tag.DefineAnimationFrames2.doParse=function(a){var b=a.array("Uint",a.fields("frame","Uint","hasChangesInDisplayList","Boolean","hasActions","Boolean","state",a.condition("hasChangesInDisplayList",1,a.array("Uint",a.fields("hasColorTransform","Boolean","hasMask","Boolean","hasEffect","Boolean","objectIdRef","Uint","depth","Int","alpha","Float","matrix","Matrix","colorTransform",a.condition("hasColorTransform",1,a.fields("alphaOffset","Float","redMultiplier","Float","redOffset","Float","greenMultiplier","Float","greenOffset","Float","blueMultiplier","Float","blueOffset","Float")),"effect",a.condition("hasEffect",1,a.array("Ubyte",gaf.Tag._readFilter(a))),"maskObjectIdRef",a.condition("hasMask",1,function(){return a.Uint()})))),"actions",a.condition("hasActions",1,a.array("Uint",a.fields("type","Uint","scope","String","params",gaf.Tag._readActionArguments(a))))));return{content:b()}},gaf.Tag.DefineTimeline=Object.create(gaf.Tag.base),gaf.Tag.DefineTimeline.tagName="TagDefineTimeline",gaf.Tag.DefineTimeline.doParse=function(a){var b=a.fields("id","Uint","animationFrameCount","Uint","boundingBox","Rect","pivotPoint","Point","hasLinkage","Boolean","linkageName",a.condition("hasLinkage",1,function(){return a.String()})),c={content:b()};return c.content.tags=gaf.ReadTags(a),c},gaf.Tag._readActionArguments=function(a){return function(){var b=a.Uint(),c=[];for(a.startNestedBuffer(b);a.maxOffset()<a.tell();)c.push(a.String());return a.endNestedBuffer(),c}},gaf.Tag._readFilter=function(a){return a.fields("type","Uint","dropShadow",a.condition("type",gaf.EFFECT_DROP_SHADOW,a.fields("color","color","blurX","Float","blurY","Float","angle","Float","distance","Float","strength","Float","inner","Boolean","knockout","Boolean")),"blur",a.condition("type",gaf.EFFECT_BLUR,a.fields("blurX","Float","blurY","Float")),"glow",a.condition("type",gaf.EFFECT_GLOW,a.fields("color","color","blurX","Float","blurY","Float","strength","Float","inner","Boolean","knockout","Boolean")),"colorMatrix",a.condition("type",gaf.EFFECT_COLOR_MATRIX,a.fields("rr","Float","gr","Float","br","Float","ar","Float","r","Float","rg","Float","gg","Float","bg","Float","ag","Float","g","Float","rb","Float","gb","Float","bb","Float","ab","Float","b","Float","ra","Float","ga","Float","ba","Float","aa","Float","a","Float")))},gaf.Tags=new gaf.Tag;var gaf=gaf||{};gaf.Loader=function(){var a=function(a,b){b.compression=a.Uint(),b.versionMajor=a.Ubyte(),b.versionMinor=a.Ubyte(),b.fileLength=a.Uint()},b=function(a,b){b.framesCount=a.Ushort(),b.frameSize=a.Rect(),b.pivot=a.Point()},c=function(a,b){var c=a.Uint();b.scaleValues=[];for(var d=0;c>d;++d)b.scaleValues.push(a.Float());var e=a.Uint();b.csfValues=[];for(var d=0;e>d;++d)b.csfValues.push(a.Float())};this.LoadFile=function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0);var d=this;c.responseType="arraybuffer",c.onload=function(a){var e=new gaf.DataReader(c.response),f=d.LoadStream(e);b&&b(f)},c.send()},this.LoadStream=function(d){var e={};if(a(d,e),e.compression==gaf.COMPRESSION_NONE);else{if(e.compression!=gaf.COMPRESSION_ZIP)throw new Error("GAF syntax error.");var f=d.dataRaw.slice(d.tell()),g=new window.Zlib.Inflate(new Uint8Array(f)),h=g.decompress();d=new gaf.DataReader(h.buffer)}e.versionMajor<4?b(d,e):c(d,e);var i=gaf.ReadTags(d);return{header:e,tags:i}}},gaf.DataReader=function(a){this.dataRaw=a,this.buf=new DataView(a),this.offset=[0]},gaf.DataReader.prototype.constructor=gaf.DataReader,gaf.DataReader.prototype.newOffset=function(a){if(this.offset[this.offset.length-1]+=a,this.getOffset()>this.maxOffset())throw new Error("GAF format error");return this.offset[this.offset.length-1]-a},gaf.DataReader.prototype.maxOffset=function(){return 1==this.offset.length?this.buf.byteLength:this.offset[this.offset.length-2]},gaf.DataReader.prototype.getOffset=function(a){return this.offset[this.offset.length-1]},gaf.DataReader.prototype.Ubyte=function(){return this.buf.getUint8(this.newOffset(1))},gaf.DataReader.prototype.Boolean=function(){var a=this.buf.getUint8(this.newOffset(1));if(a>1)throw new Error("GAF format error");return a},gaf.DataReader.prototype.Uint=function(){return this.buf.getUint32(this.newOffset(4),!0)},gaf.DataReader.prototype.Int=function(){return this.buf.getInt32(this.newOffset(4),!0)},gaf.DataReader.prototype.color=function(){return{b:this.Ubyte(),g:this.Ubyte(),r:this.Ubyte(),a:this.Ubyte()}},gaf.DataReader.prototype.Ushort=function(){return this.buf.getUint16(this.newOffset(2),!0)},gaf.DataReader.prototype.Float=function(){return this.buf.getFloat32(this.newOffset(4),!0)},gaf.DataReader.prototype.String=function(){var a=this.Ushort(),b=this.newOffset(a),c=this.getOffset();try{var d=this.dataRaw.slice(b,c)}catch(e){if("Object doesn't support property or method 'slice'"!=e.message)throw e;d=[];for(var f=b;c>f;++f)d.push(this.buf.getUint8(f))}return decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(d))))},gaf.DataReader.prototype.startNestedBuffer=function(a){this.offset.push(this.offset[this.offset.length-1]),this.offset[this.offset.length-2]+=a},gaf.DataReader.prototype.endNestedBuffer=function(){if(1==this.offset.length)throw new Error("No nested buffer available");this.offset.pop()},gaf.DataReader.prototype.Point=function(){return{x:this.Float(),y:this.Float()}},gaf.DataReader.prototype.Rect=function(){return{x:this.Float(),y:this.Float(),width:this.Float(),height:this.Float()}},gaf.DataReader.prototype.Matrix=function(){return{a:this.Float(),b:this.Float(),c:this.Float(),d:this.Float(),tx:this.Float(),ty:this.Float()}},gaf.DataReader.prototype.seek=function(a){this.offset[this.offset.length-1]=a},gaf.DataReader.prototype.tell=function(){return this.offset[this.offset.length-1]},gaf.DataReader.prototype.fields=function(){var a=this,b=arguments;return function(){arguments.callee.result={};var c=0;if(b.length%2)throw new Error("Number of arguments is not even");for(;c<b.length;){var d=b[c++],e=b[c++];if("function"==typeof e)arguments.callee.result[d]=e();else{if(!(e in a&&"function"==typeof a[e]))throw new Error("Object DataReader has no function `"+e+"`");arguments.callee.result[d]=a[e].call(a)}}return arguments.callee.result}},gaf.DataReader.prototype.condition=function(a,b,c){var d=arguments;return function(){if(3!=d.length)throw new Error("Condition function");var a=arguments.callee.caller;if(!("result"in a))throw new Error("Condition function caller has no key `result`");var b=a.result,c=d[0],e=d[1],f=d[2],g=null;return g="function"==typeof e?function(){return e(b[c])}:function(){return e==b[c]},g()?f():null}},gaf.DataReader.prototype.array=function(){var a=this,b=arguments;return function(){arguments.callee.result=[];for(var c=a[b[0]].call(a),d=0;c>d;++d){var e=b[1].call();arguments.callee.result.push(e)}return arguments.callee.result}},gaf.SHADER_GAUSSIAN_BLUR_FRAG="varying mediump vec2 v_texCoord;\nuniform mediump vec2 u_step;\nvoid main()\n{ \n    mediump vec4 sum = vec4(0.0);                                      \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 4.0) * 0.05;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 0.0) * 0.18;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 4.0) * 0.05;   \n    gl_FragColor = sum;                                                \n} \n",gaf.SHADER_GLOW_FRAG="varying mediump vec2 v_texCoord;\nuniform mediump vec2 u_step;\nuniform mediump vec4 u_glowColor;\nvoid main()\n{ \n    mediump vec4 sum = vec4(0.0);                                      \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 4.0) * 0.05;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 0.0) * 0.18;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 4.0) * 0.05;   \n    gl_FragColor = sum * u_glowColor;                                  \n} \n",gaf.SHADER_COLOR_MATRIX_FRAG="varying mediump vec2 v_texCoord;\nvarying mediump vec4 v_fragmentColor;\nuniform mediump vec4 colorTransformMult;\nuniform mediump vec4 colorTransformOffsets;\nuniform mediump mat4 colorMatrix;\nuniform mediump vec4 colorMatrix2;\nvoid main()\n{ \n    vec4 texColor = texture2D(CC_Texture0, v_texCoord);                          \n    const float kMinimalAlphaAllowed = 1.0e-8;                                   \n    if (texColor.a > kMinimalAlphaAllowed)                                       \n    {                                                                            \n        texColor = vec4(texColor.rgb / texColor.a, texColor.a);                  \n        vec4 ctxColor = texColor * colorTransformMult + colorTransformOffsets;   \n        vec4 adjustColor = colorMatrix * ctxColor + colorMatrix2;                \n        adjustColor *= v_fragmentColor;                                          \n        texColor = vec4(adjustColor.rgb * adjustColor.a, adjustColor.a);         \n    }                                                                            \n    gl_FragColor = texColor;                                                     \n}\n",gaf._glShaderInit=function(){gaf._Uniforms={ColorTransformMult:-1,ColorTransformOffset:-1,ColorMatrixBody:-1,ColorMatrixAppendix:-1,BlurTexelOffset:-1,GlowTexelOffset:-1,GlowColor:-1},gaf._shaderCreate=function(a,b){var c=new cc.GLProgram,d=c.initWithVertexShaderByteArray(b,a);return cc.assert(d,"Shader init error"),c.addAttribute(cc.ATTRIBUTE_NAME_POSITION,cc.VERTEX_ATTRIB_POSITION),c.addAttribute(cc.ATTRIBUTE_NAME_COLOR,cc.VERTEX_ATTRIB_COLOR),c.addAttribute(cc.ATTRIBUTE_NAME_TEX_COORD,cc.VERTEX_ATTRIB_TEX_COORDS),d=c.link(),cc.assert(d,"Shader linking error"),c.updateUniforms(),c},gaf._shaderCreateAlpha=function(){var a=gaf._shaderCreate(gaf.SHADER_COLOR_MATRIX_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.ColorTransformMult=a.getUniformLocationForName(gaf.UNIFORM_ALPHA_TINT_MULT),gaf._Uniforms.ColorTransformOffset=a.getUniformLocationForName(gaf.UNIFORM_ALPHA_TINT_OFFSET),gaf._Uniforms.ColorMatrixBody=a.getUniformLocationForName(gaf.UNIFORM_ALPHA_COLOR_MATRIX_BODY),gaf._Uniforms.ColorMatrixAppendix=a.getUniformLocationForName(gaf.UNIFORM_ALPHA_COLOR_MATRIX_APPENDIX),a},gaf._shaderCreateBlur=function(){var a=gaf._shaderCreate(gaf.SHADER_GAUSSIAN_BLUR_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.BlurTexelOffset=a._glContext.getUniformLocation(a._programObj,gaf.UNIFORM_BLUR_TEXEL_OFFSET),a},gaf._shaderCreateGlow=function(){var a=gaf._shaderCreate(gaf.SHADER_GLOW_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.GlowTexelOffset=a._glContext.getUniformLocation(a._programObj,gaf.UNIFORM_GLOW_TEXEL_OFFSET),gaf._Uniforms.GlowColor=a._glContext.getUniformLocation(a._programObj,gaf.UNIFORM_GLOW_COLOR),a},gaf._Shaders={Alpha:gaf._shaderCreateAlpha(),Blur:gaf._shaderCreateBlur(),Glow:gaf._shaderCreateGlow()}},gaf._setupShaders=function(){cc._renderType===cc.game.RENDER_TYPE_WEBGL?gaf._glShaderInit():delete gaf._glShaderInit},gaf._AtlasLoader={},gaf._AtlasLoader.execute=function(a,b,c){a()?b():c()},gaf._AtlasLoader.checkAtlas=function(a){return function(){return a&&"string"!=typeof a&&a.isLoaded()}},gaf._AtlasLoader.load=function(a,b,c){cc.textureCache.addImage(a,function(a){gaf._AtlasLoader.execute(gaf._AtlasLoader.checkAtlas(a),function(){b(a)},c)})},gaf._AtlasLoader.loadFront=function(a,b,c){return function(){a.length>0?gaf._AtlasLoader.load(a[0],b,gaf._AtlasLoader.loadFront(a.slice(1),b,c)):c()}},gaf._AtlasLoader.loadArray=function(a,b,c){gaf._AtlasLoader.loadFront(a,b,c)()};