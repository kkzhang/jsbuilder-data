!function(){var a=!1,b=cc.sys,c=b.browserVersion,d=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),e={ONLY_ONE:!1,WEB_AUDIO:d,DELAY_CREATE_CTX:!1,ONE_SOURCE:!1};b.browserType===b.BROWSER_TYPE_FIREFOX&&(e.DELAY_CREATE_CTX=!0,e.USE_LOADER_EVENT="canplay"),b.os===b.OS_ANDROID&&b.browserType===b.BROWSER_TYPE_UC&&(e.ONE_SOURCE=!0),window.__audioSupport=e,a&&setTimeout(function(){cc.log("browse type: "+b.browserType),cc.log("browse version: "+c),cc.log("MULTI_CHANNEL: "+window.__audioSupport.MULTI_CHANNEL),cc.log("WEB_AUDIO: "+window.__audioSupport.WEB_AUDIO),cc.log("AUTOPLAY: "+window.__audioSupport.AUTOPLAY)},0)}(),cc.Audio=cc.Class.extend({src:null,_element:null,_AUDIO_TYPE:"AUDIO",ctor:function(a){this.src=a},setBuffer:function(a){this._AUDIO_TYPE="WEBAUDIO",this._element=new cc.Audio.WebAudio(a)},setElement:function(a){this._AUDIO_TYPE="AUDIO",this._element=a,a.addEventListener("ended",function(){a.loop||(a.paused=!0)})},play:function(a,b){this._element&&(this._element.loop=b,this._element.play(),"AUDIO"===this._AUDIO_TYPE&&this._element.paused&&(this.stop(),cc.Audio.touchPlayList.push({loop:b,offset:a,audio:this._element})),cc.Audio.bindTouch===!1&&(cc.Audio.bindTouch=!0,cc.game.canvas.addEventListener("touchstart",cc.Audio.touchStart)))},getPlaying:function(){return this._element?!this._element.paused:!0},stop:function(){if(this._element){this._element.pause();try{this._element.currentTime=0}catch(a){}}},pause:function(){this._element&&this._element.pause()},resume:function(){this._element&&this._element.play()},setVolume:function(a){this._element&&(this._element.volume=a)},getVolume:function(){return this._element?this._element.volume:void 0},cloneNode:function(){var a=new cc.Audio(this.src);if("AUDIO"===this._AUDIO_TYPE){for(var b=document.createElement("audio"),c=b.getElementsByTagName("source"),d=0;d<c.length;d++)b.appendChild(c[d]);b.src=this.src,a.setElement(b)}else a.setBuffer(this._element.buffer);return a}}),cc.Audio.touchPlayList=[],cc.Audio.bindTouch=!1,cc.Audio.touchStart=function(){for(var a=cc.Audio.touchPlayList,b=null;b=a.pop();)b.audio.loop=!!b.loop,b.audio.play(b.offset)},cc.Audio.WebAudio=function(a){this.buffer=a,this.context=cc.Audio._context;var b=this.context.createGain();b.gain.value=1,b.connect(this.context.destination),this._volume=b,this._loop=!1,this._startTime=-1,this._currentSource=null,this.playedLength=0,this._currextTimer=null},cc.Audio.WebAudio.prototype={constructor:cc.Audio.WebAudio,get paused(){return this._currentSource&&this._currentSource.loop?!1:-1===this._startTime?!0:this.context.currentTime-this._startTime>this.buffer.duration},set paused(a){},get loop(){return this._loop},set loop(a){return this._loop=a},get volume(){return this._volume.gain.value},set volume(a){return this._volume.gain.value=a},get currentTime(){return this.playedLength},set currentTime(a){return this.playedLength=a},play:function(a){this._currentSource&&!this.paused&&(this._currentSource.stop(0),this.playedLength=0);var b=this.context.createBufferSource();b.buffer=this.buffer,b.connect(this._volume),b.loop=this._loop,this._startTime=this.context.currentTime,a=a||this.playedLength;var c=this.buffer.duration;if(this._loop?b.start?b.start(0):b.notoGrainOn?b.noteGrainOn(0):b.noteOn(0):b.start?b.start(0,a,c-a):b.notoGrainOn?b.noteGrainOn(0,a,c-a):b.noteOn(0,a,c-a),this._currentSource=b,0===this.context.currentTime){var d=this;clearTimeout(this._currextTimer),this._currextTimer=setTimeout(function(){0===d.context.currentTime&&cc.Audio.touchPlayList.push({offset:a,audio:d})},10)}},pause:function(){this.playedLength=this.context.currentTime-this._startTime,this.playedLength%=this.buffer.duration;var a=this._currentSource;this._currentSource=null,this._startTime=-1,a&&a.stop(0)}},function(a){var b=a.WEB_AUDIO,c=a.ONLY_ONE,d=[];!function(){var a=document.createElement("audio");if(a.canPlayType){var b=a.canPlayType('audio/ogg; codecs="vorbis"');b&&""!==b&&d.push(".ogg");var c=a.canPlayType("audio/mpeg");c&&""!==c&&d.push(".mp3");var e=a.canPlayType('audio/wav; codecs="1"');e&&""!==e&&d.push(".wav");var f=a.canPlayType("audio/mp4");f&&""!==f&&d.push(".mp4");var g=a.canPlayType("audio/x-m4a");g&&""!==g&&d.push(".m4a")}}();try{if(b){var e=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);cc.Audio._context=e,a.DELAY_CREATE_CTX&&setTimeout(function(){e=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),cc.Audio._context=e},0)}}catch(f){b=!1,cc.log("browser don't support web audio")}var g={cache:{},useWebAudio:!1,loadBuffer:function(a,c){if(b){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="arraybuffer",d.onload=function(){e.decodeAudioData(d.response,function(a){c(null,a)},function(){c("decode error - "+a)})},d.onerror=function(){c("request error - "+a)},d.send()}},load:function(a,b,c,e){if(0===d.length)return e("can not support audio!");var f=cc.loader.getRes(b);if(f)return e(null,f);var g;cc.loader.audioPath&&(a=cc.path.join(cc.loader.audioPath,a));var h=cc.path.extname(a),i=[h];for(g=0;g<d.length;g++)h!==d[g]&&i.push(d[g]);return f=new cc.Audio(a),cc.loader.cache[b]=f,this.loadAudioFromExtList(a,i,f,e),f},loadAudioFromExtList:function(c,e,f,g){if(0===e.length){var h="can not found the resource of audio! Last match url is : ";return h+=c.replace(/\.(.*)?$/,"("),d.forEach(function(a){h+=a+"|"}),h=h.replace(/\|$/,")"),g({status:520,errorMessage:h},null)}if(b&&this.useWebAudio)return void this.loadBuffer(c,function(a,b){a&&cc.log(a),b&&f.setBuffer(b),g(null,f)});for(var i=a.ONE_SOURCE?1:e.length,j=document.createElement("audio"),k=0;i>k;k++){var l=document.createElement("source");l.src=cc.path.changeExtname(c,e[k]),j.appendChild(l)}f.setElement(j);var m=setTimeout(function(){0===j.readyState?o():n()},8e3),n=function(){j.removeEventListener("canplaythrough",n,!1),j.removeEventListener("error",o,!1),j.removeEventListener("emptied",n,!1),a.USE_LOADER_EVENT&&j.removeEventListener(a.USE_LOADER_EVENT,n,!1),clearTimeout(m),g(null,f)},o=function(){cc.log("load audio failure - "+c),n()};j.addEventListener("canplaythrough",n,!1),j.addEventListener("error",o,!1),a.USE_LOADER_EVENT&&j.addEventListener(a.USE_LOADER_EVENT,n,!1)}};cc.loader.register(["mp3","ogg","wav","mp4","m4a"],g),cc.audioEngine={_currMusic:null,_musicVolume:1,features:a,willPlayMusic:function(){return!1},playMusic:function(a,b){var c=this._currMusic;c&&c.getPlaying()&&c.stop();var d=cc.loader.getRes(a);d||(cc.loader.load(a),d=cc.loader.getRes(a)),d.setVolume(this._musicVolume),d.play(0,b||!1),this._currMusic=d},stopMusic:function(a){var b=this._currMusic;b&&(b.stop(),a&&cc.loader.release(b.src))},pauseMusic:function(){var a=this._currMusic;a&&a.pause()},resumeMusic:function(){var a=this._currMusic;a&&a.resume()},rewindMusic:function(){var a=this._currMusic;a&&(a.stop(),a.play())},getMusicVolume:function(){return this._musicVolume},setMusicVolume:function(a){a-=0,isNaN(a)&&(a=1),a>1&&(a=1),0>a&&(a=0),this._musicVolume=a;var b=this._currMusic;b&&b.setVolume(a)},isMusicPlaying:function(){var a=this._currMusic;return a?a.getPlaying():!1},_audioPool:{},_maxAudioInstance:10,_effectVolume:1,playEffect:function(a,d){if(c&&this._currMusic&&this._currMusic.getPlaying())return cc.log("Browser is only allowed to play one audio"),null;var e=this._audioPool[a];e||(e=this._audioPool[a]=[]);var f;for(f=0;f<e.length&&e[f].getPlaying();f++);if(!b&&f>this._maxAudioInstance){var h=e.shift();h.stop(),e.push(h),f=e.length-1}var i;if(e[f])return i=e[f],i.setVolume(this._effectVolume),i.play(0,d||!1),i;if(i=cc.loader.getRes(a),i&&b&&"AUDIO"===i._AUDIO_TYPE&&(cc.loader.release(a),i=null),i){if(!b||"AUDIO"!==i._AUDIO_TYPE)return i=i.cloneNode(),i.setVolume(this._effectVolume),i.play(0,d||!1),e.push(i),i;g.loadBuffer(a,function(a,b){i.setBuffer(b),i.setVolume(cc.audioEngine._effectVolume),i.getPlaying()||i.play(0,d||!1)})}return g.useWebAudio=!0,cc.loader.load(a,function(b){b=cc.loader.getRes(a),b=b.cloneNode(),b.setVolume(cc.audioEngine._effectVolume),b.play(0,d||!1),e.push(b)}),g.useWebAudio=!1,i},setEffectsVolume:function(a){a-=0,isNaN(a)&&(a=1),a>1&&(a=1),0>a&&(a=0),this._effectVolume=a;var b=this._audioPool;for(var c in b){var d=b[c];if(Array.isArray(d))for(var e=0;e<d.length;e++)d[e].setVolume(a)}},getEffectsVolume:function(){return this._effectVolume},pauseEffect:function(a){a&&a.pause()},pauseAllEffects:function(){var a=this._audioPool;for(var b in a)for(var c=a[b],d=0;d<a[b].length;d++)c[d].getPlaying()&&c[d].pause()},resumeEffect:function(a){a&&a.resume()},resumeAllEffects:function(){var a=this._audioPool;for(var b in a)for(var c=a[b],d=0;d<a[b].length;d++)c[d].resume()},stopEffect:function(a){a&&a.stop()},stopAllEffects:function(){var a=this._audioPool;for(var b in a)for(var c=a[b],d=0;d<a[b].length;d++)c[d].stop()},unloadEffect:function(a){if(a){cc.loader.release(a);var b=this._audioPool[a];b&&(b.length=0),delete this._audioPool[a]}},end:function(){this.stopMusic(),this.stopAllEffects()},_pauseCache:[],_pausePlaying:function(){var a=this._currMusic;a&&a.getPlaying()&&(a.pause(),this._pauseCache.push(a));var b=this._audioPool;for(var c in b)for(var d=b[c],e=0;e<b[c].length;e++)d[e].getPlaying()&&(d[e].pause(),this._pauseCache.push(d[e]))},_resumePlaying:function(){for(var a=this._pauseCache,b=0;b<a.length;b++)a[b].resume();a.length=0}}}(window.__audioSupport);