cc.stencilBits=-1;cc.setProgram=function(b,a){b.shaderProgram=a;var c=b.children;if(c)for(var d=0;d<c.length;d++)cc.setProgram(c[d],a)};
cc.ClippingNode=cc.Node.extend({alphaThreshold:0,inverted:!1,_stencil:null,_godhelpme:!1,ctor:function(b){cc.Node.prototype.ctor.call(this);this._stencil=null;this.alphaThreshold=0;this.inverted=!1;cc.ClippingNode.prototype.init.call(this,b||null)},init:null,_className:"ClippingNode",_initForWebGL:function(b){this._stencil=b;this.alphaThreshold=1;this.inverted=!1;cc.ClippingNode._init_once=!0;cc.ClippingNode._init_once&&(cc.stencilBits=cc._renderContext.getParameter(cc._renderContext.STENCIL_BITS),
0>=cc.stencilBits&&cc.log("Stencil buffer is not enabled."),cc.ClippingNode._init_once=!1);return!0},_initForCanvas:function(b){this._stencil=b;this.alphaThreshold=1;this.inverted=!1},onEnter:function(){cc.Node.prototype.onEnter.call(this);this._stencil.onEnter()},onEnterTransitionDidFinish:function(){cc.Node.prototype.onEnterTransitionDidFinish.call(this);this._stencil.onEnterTransitionDidFinish()},onExitTransitionDidStart:function(){this._stencil.onExitTransitionDidStart();cc.Node.prototype.onExitTransitionDidStart.call(this)},
onExit:function(){this._stencil.onExit();cc.Node.prototype.onExit.call(this)},visit:null,_visitForWebGL:function(b){var a=b||cc._renderContext;if(1>cc.stencilBits)cc.Node.prototype.visit.call(this,b);else if(!this._stencil||!this._stencil.visible)this.inverted&&cc.Node.prototype.visit.call(this,b);else if(cc.ClippingNode._layer=-1,cc.ClippingNode._layer+1==cc.stencilBits)cc.ClippingNode._visit_once=!0,cc.ClippingNode._visit_once&&(cc.log("Nesting more than "+cc.stencilBits+"stencils is not supported. Everything will be drawn without stencil for this node and its childs."),
cc.ClippingNode._visit_once=!1),cc.Node.prototype.visit.call(this,b);else{cc.ClippingNode._layer++;var c=1<<cc.ClippingNode._layer,d=c|c-1,e=a.isEnabled(a.STENCIL_TEST),g=a.getParameter(a.STENCIL_WRITEMASK),f=a.getParameter(a.STENCIL_FUNC),h=a.getParameter(a.STENCIL_REF),k=a.getParameter(a.STENCIL_VALUE_MASK),l=a.getParameter(a.STENCIL_FAIL),m=a.getParameter(a.STENCIL_PASS_DEPTH_FAIL),n=a.getParameter(a.STENCIL_PASS_DEPTH_PASS);a.enable(a.STENCIL_TEST);a.stencilMask(c);var p=a.getParameter(a.DEPTH_WRITEMASK);
a.depthMask(!1);a.stencilFunc(a.NEVER,c,c);a.stencilOp(!this.inverted?a.ZERO:a.REPLACE,a.KEEP,a.KEEP);cc._drawingUtil.drawSolidRect(cc.p(0,0),cc.pFromSize(cc.director.getWinSize()),cc.color(255,255,255,255));a.stencilFunc(a.NEVER,c,c);a.stencilOp(!this.inverted?a.REPLACE:a.ZERO,a.KEEP,a.KEEP);if(1>this.alphaThreshold){var c=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLORALPHATEST),q=a.getUniformLocation(c.getProgram(),cc.UNIFORM_ALPHA_TEST_VALUE_S);cc.glUseProgram(c.getProgram());c.setUniformLocationWith1f(q,
this.alphaThreshold);cc.setProgram(this._stencil,c)}cc.kmGLPushMatrix();this.transform();this._stencil.visit();cc.kmGLPopMatrix();a.depthMask(p);a.stencilFunc(a.EQUAL,d,d);a.stencilOp(a.KEEP,a.KEEP,a.KEEP);cc.Node.prototype.visit.call(this,b);a.stencilFunc(f,h,k);a.stencilOp(l,m,n);a.stencilMask(g);e||a.disable(a.STENCIL_TEST);cc.ClippingNode._layer--}},_visitForCanvas:function(b){if(!this._stencil||!this._stencil.visible)this.inverted&&cc.Node.prototype.visit.call(this,b);else{b=b||cc._renderContext;
if(this._cangodhelpme()||this._stencil instanceof cc.Sprite){var a=b.canvas,c=cc.ClippingNode._getSharedCache();c.width=a.width;c.height=a.height;c.getContext("2d").drawImage(a,0,0);b.save();cc.Node.prototype.visit.call(this,b);b.globalCompositeOperation=this.inverted?"destination-out":"destination-in";this.transform(b);this._stencil.visit();b.restore();b.save();b.setTransform(1,0,0,1,0,0);b.globalCompositeOperation="destination-over";b.drawImage(c,0,0)}else{var c=this._children,d;b.save();this.transform(b);
this._stencil.visit(b);b.clip();this._cangodhelpme(!0);var e=c.length;if(0<e){this.sortAllChildren();for(a=0;a<e;a++)if(d=c[a],0>d._localZOrder)d.visit(b);else break;for(this.draw(b);a<e;a++)c[a].visit(b)}else this.draw(b);this._cangodhelpme(!1)}b.restore()}},getStencil:function(){return this._stencil},setStencil:null,_setStencilForWebGL:function(b){this._stencil=b},_setStencilForCanvas:function(b){this._stencil=b;var a=cc._renderContext;!(b instanceof cc.Sprite)&&b instanceof cc.DrawNode&&(b.draw=
function(){for(var c=cc.view.getScaleX(),d=cc.view.getScaleY(),e=0;e<b._buffer.length;e++){var g=b._buffer[e].verts,f=g[0];a.beginPath();a.moveTo(f.x*c,-f.y*d);for(var f=1,h=g.length;f<h;f++)a.lineTo(g[f].x*c,-g[f].y*d)}})},getAlphaThreshold:function(){return this.alphaThreshold},setAlphaThreshold:function(b){this.alphaThreshold=b},isInverted:function(){return this.inverted},setInverted:function(b){this.inverted=b},_cangodhelpme:function(b){if(!0===b||!1===b)cc.ClippingNode.prototype._godhelpme=b;
return cc.ClippingNode.prototype._godhelpme}});var _p=cc.ClippingNode.prototype;cc._renderType===cc._RENDER_TYPE_WEBGL?(_p.init=_p._initForWebGL,_p.visit=_p._visitForWebGL,_p.setStencil=_p._setStencilForWebGL):(_p.init=_p._initForCanvas,_p.visit=_p._visitForCanvas,_p.setStencil=_p._setStencilForCanvas);cc.defineGetterSetter(_p,"stencil",_p.getStencil,_p.setStencil);cc.ClippingNode._init_once=null;cc.ClippingNode._visit_once=null;cc.ClippingNode._layer=null;cc.ClippingNode._sharedCache=null;
cc.ClippingNode._getSharedCache=function(){return cc.ClippingNode._sharedCache||(cc.ClippingNode._sharedCache=document.createElement("canvas"))};cc.ClippingNode.create=function(b){return new cc.ClippingNode(b)};