cc.TGA_OK=0;cc.TGA_ERROR_FILE_OPEN=1;cc.TGA_ERROR_READING_FILE=2;cc.TGA_ERROR_INDEXED_COLOR=3;cc.TGA_ERROR_MEMORY=4;cc.TGA_ERROR_COMPRESSED_FILE=5;cc.ImageTGA=function(a,c,b,d,e,g,f){this.status=a||0;this.type=c||0;this.pixelDepth=b||0;this.width=d||0;this.height=e||0;this.imageData=g||[];this.flipped=f||0};
cc.tgaLoadHeader=function(a,c,b){var d=2;if(d+1>c)return!1;a=new cc.BinaryStreamReader(a);a.setOffset(d);b.type=a.readByte();d+=10;if(d+4+1>c)return!1;a.setOffset(d);b.width=a.readUnsignedShort();b.height=a.readUnsignedInteger();b.pixelDepth=a.readByte();if(d+5+1>c)return!1;c=a.readByte();b.flipped=0;c&32&&(b.flipped=1);return!0};
cc.tgaLoadImageData=function(a,c,b){var d,e;d=0|b.pixelDepth/2;e=b.height*b.width*d;if(18+e>c)return!1;b.imageData=cc.__getSubArray(a,18,18+e);if(3<=d)for(a=0;a<e;a+=d)c=b.imageData[a],b.imageData[a]=b.imageData[a+2],b.imageData[a+2]=c;return!0};
cc.tgaRGBtogreyscale=function(a){var c,b;if(8!==a.pixelDepth){var d=a.pixelDepth/8,e=new Uint8Array(a.height*a.width);if(null!==e){for(b=c=0;b<a.width*a.height;c+=d,b++)e[b]=0.3*a.imageData[c]+0.59*a.imageData[c+1]+0.11*a.imageData[c+2];a.pixelDepth=8;a.type=3;a.imageData=e}}};cc.tgaDestroy=function(a){a&&(a.imageData=null)};
cc.tgaLoadRLEImageData=function(a,c,b){var d,e,g,f=0,h=0,k=0,l=[],m=0,n=18;d=b.pixelDepth/8;e=b.height*b.width;for(g=0;g<e;g++){if(0!=m)m--,h=0!=k;else{if(n+1>c)break;m=a[n];n+=1;(k=m&128)&&(m-=128);h=0}if(!h){if(n+d>c)break;l=cc.__getSubArray(a,n,n+d);n+=d;3<=d&&(h=l[0],l[0]=l[2],l[2]=h)}for(h=0;h<d;h++)b.imageData[f+h]=l[h];f+=d}return!0};
cc.tgaFlipImage=function(a){for(var c=a.width*(a.pixelDepth/8),b=0;b<a.height/2;b++){var d=cc.__getSubArray(a.imageData,b*c,b*c+c);cc.__setDataToArray(cc.__getSubArray(a.imageData,(a.height-(b+1))*c,c),a.imageData,b*c);cc.__setDataToArray(d,a.imageData,(a.height-(b+1))*c)}a.flipped=0};cc.__getSubArray=function(a,c,b){return a instanceof Array?a.slice(c,b):a.subarray(c,b)};cc.__setDataToArray=function(a,c,b){for(var d=0;d<a.length;d++)c[b+d]=a[d]};
cc.BinaryStreamReader=cc.Class.extend({_binaryData:null,_offset:0,ctor:function(a){this._binaryData=a},setBinaryData:function(a){this._binaryData=a;this._offset=0},getBinaryData:function(){return this._binaryData},_checkSize:function(a){if(!(this._offset+Math.ceil(a/8)<this._data.length))throw Error("Index out of bound");},_decodeFloat:function(a,c){var b=a+c+1,d=b>>3;this._checkSize(b);var b=Math.pow(2,c-1)-1,e=this._readBits(a+c,1,d),g=this._readBits(a,c,d),f=0,h=2,k=0;do for(var l=this._readByte(++k,
d),m=a%8||8,n=1<<m;n>>=1;)l&n&&(f+=1/h),h*=2;while(a-=m);this._offset+=d;return g==(b<<1)+1?f?NaN:e?-Infinity:Infinity:(1+-2*e)*(g||f?!g?Math.pow(2,-b+1)*f:Math.pow(2,g-b)*(1+f):0)},_readByte:function(a,c){return this._data[this._offset+c-a-1]},_decodeInt:function(a,c){var b=this._readBits(0,a,a/8),d=Math.pow(2,a);this._offset+=a/8;return c&&b>=d/2?b-d:b},_shl:function(a,c){for(++c;--c;a=1073741824==((a%=2147483648)&1073741824)?2*a:2*(a-1073741824)+2147483648);return a},_readBits:function(a,c,b){var d=
(a+c)%8,e=a%8,g=b-(a>>3)-1;a=b+(-(a+c)>>3);var f=g-a;c=this._readByte(g,b)>>e&(1<<(f?8-e:c))-1;for(f&&d&&(c+=(this._readByte(a++,b)&(1<<d)-1)<<(f--<<3)-e);f;)c+=this._shl(this._readByte(a++,b),(f--<<3)-e);return c},readInteger:function(){return this._decodeInt(32,!0)},readUnsignedInteger:function(){return this._decodeInt(32,!1)},readSingle:function(){return this._decodeFloat(23,8)},readShort:function(){return this._decodeInt(16,!0)},readUnsignedShort:function(){return this._decodeInt(16,!1)},readByte:function(){var a=
this._data[this._offset];this._offset+=1;return a},readData:function(a,c){return this._binaryData instanceof Array?this._binaryData.slice(a,c):this._binaryData.subarray(a,c)},setOffset:function(a){this._offset=a},getOffset:function(){return this._offset}});cc.TMX_ORIENTATION_ORTHO=0;cc.TMX_ORIENTATION_HEX=1;cc.TMX_ORIENTATION_ISO=2;
cc.TMXTiledMap=cc.Node.extend({properties:null,mapOrientation:null,objectGroups:null,_mapSize:null,_tileSize:null,_tileProperties:null,_className:"TMXTiledMap",ctor:function(a,c){cc.Node.prototype.ctor.call(this);this._mapSize=cc.size(0,0);this._tileSize=cc.size(0,0);void 0!==c?this.initWithXML(a,c):void 0!==a&&this.initWithTMXFile(a)},getMapSize:function(){return cc.size(this._mapSize.width,this._mapSize.height)},setMapSize:function(a){this._mapSize.width=a.width;this._mapSize.height=a.height},_getMapWidth:function(){return this._mapSize.width},
_setMapWidth:function(a){this._mapSize.width=a},_getMapHeight:function(){return this._mapSize.height},_setMapHeight:function(a){this._mapSize.height=a},getTileSize:function(){return cc.size(this._tileSize.width,this._tileSize.height)},setTileSize:function(a){this._tileSize.width=a.width;this._tileSize.height=a.height},_getTileWidth:function(){return this._tileSize.width},_setTileWidth:function(a){this._tileSize.width=a},_getTileHeight:function(){return this._tileSize.height},_setTileHeight:function(a){this._tileSize.height=
a},getMapOrientation:function(){return this.mapOrientation},setMapOrientation:function(a){this.mapOrientation=a},getObjectGroups:function(){return this.objectGroups},setObjectGroups:function(a){this.objectGroups=a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},initWithTMXFile:function(a){if(!a||0==a.length)throw"cc.TMXTiledMap.initWithTMXFile(): tmxFile should be non-null or non-empty string.";this.height=this.width=0;a=cc.TMXMapInfo.create(a);if(!a)return!1;
var c=a.getTilesets();(!c||0===c.length)&&cc.log("cc.TMXTiledMap.initWithTMXFile(): Map not found. Please check the filename.");this._buildWithMapInfo(a);return!0},initWithXML:function(a,c){this.height=this.width=0;var b=cc.TMXMapInfo.create(a,c),d=b.getTilesets();(!d||0===d.length)&&cc.log("cc.TMXTiledMap.initWithXML(): Map not found. Please check the filename.");this._buildWithMapInfo(b);return!0},_buildWithMapInfo:function(a){this._mapSize=a.getMapSize();this._tileSize=a.getTileSize();this.mapOrientation=
a.orientation;this.objectGroups=a.getObjectGroups();this.properties=a.properties;this._tileProperties=a.getTileProperties();var c=0,b=a.getLayers();if(b)for(var d=null,e=0,g=b.length;e<g;e++)if((d=b[e])&&d.visible)d=this._parseLayer(d,a),this.addChild(d,c,c),this.width=Math.max(this.width,d.width),this.height=Math.max(this.height,d.height),c++},allLayers:function(){for(var a=[],c=this._children,b=0,d=c.length;b<d;b++){var e=c[b];e&&e instanceof cc.TMXLayer&&a.push(e)}return a},getLayer:function(a){if(!a||
0===a.length)throw"cc.TMXTiledMap.getLayer(): layerName should be non-null or non-empty string.";for(var c=this._children,b=0;b<c.length;b++){var d=c[b];if(d&&d.layerName==a)return d}return null},getObjectGroup:function(a){if(!a||0===a.length)throw"cc.TMXTiledMap.getObjectGroup(): groupName should be non-null or non-empty string.";if(this.objectGroups)for(var c=0;c<this.objectGroups.length;c++){var b=this.objectGroups[c];if(b&&b.groupName==a)return b}return null},getProperty:function(a){return this.properties[a.toString()]},
propertiesForGID:function(a){return this._tileProperties[a]},_parseLayer:function(a,c){var b=this._tilesetForLayer(a,c),b=cc.TMXLayer.create(b,a,c);a.ownTiles=!1;b.setupTiles();return b},_tilesetForLayer:function(a,c){var b=a._layerSize,d=c.getTilesets();if(d)for(var e=d.length-1;0<=e;e--){var g=d[e];if(g)for(var f=0;f<b.height;f++)for(var h=0;h<b.width;h++){var k=a._tiles[h+b.width*f];if(0!=k&&(k&cc.TMX_TILE_FLIPPED_MASK)>>>0>=g.firstGid)return g}}cc.log("cocos2d: Warning: TMX Layer "+a.name+" has no tiles");
return null}});var _p=cc.TMXTiledMap.prototype;cc.defineGetterSetter(_p,"mapWidth",_p._getMapWidth,_p._setMapWidth);cc.defineGetterSetter(_p,"mapHeight",_p._getMapHeight,_p._setMapHeight);cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth);cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight);cc.TMXTiledMap.create=function(a,c){return new cc.TMXTiledMap(a,c)};cc.TMX_PROPERTY_NONE=0;cc.TMX_PROPERTY_MAP=1;cc.TMX_PROPERTY_LAYER=2;cc.TMX_PROPERTY_OBJECTGROUP=3;cc.TMX_PROPERTY_OBJECT=4;cc.TMX_PROPERTY_TILE=5;cc.TMX_TILE_HORIZONTAL_FLAG=2147483648;cc.TMX_TILE_VERTICAL_FLAG=1073741824;cc.TMX_TILE_DIAGONAL_FLAG=536870912;cc.TMX_TILE_FLIPPED_ALL=(cc.TMX_TILE_HORIZONTAL_FLAG|cc.TMX_TILE_VERTICAL_FLAG|cc.TMX_TILE_DIAGONAL_FLAG)>>>0;cc.TMX_TILE_FLIPPED_MASK=~cc.TMX_TILE_FLIPPED_ALL>>>0;
cc.TMXLayerInfo=cc.Class.extend({properties:null,name:"",_layerSize:null,_tiles:null,visible:null,_opacity:null,ownTiles:!0,_minGID:1E5,_maxGID:0,offset:null,ctor:function(){this.properties=[];this.name="";this._layerSize=null;this._tiles=[];this.visible=!0;this._opacity=0;this.ownTiles=!0;this._minGID=1E5;this._maxGID=0;this.offset=cc.p(0,0)},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a}});
cc.TMXTilesetInfo=cc.Class.extend({name:"",firstGid:0,_tileSize:null,spacing:0,margin:0,sourceImage:"",imageSize:null,ctor:function(){this._tileSize=cc.size(0,0);this.imageSize=cc.size(0,0)},rectForGID:function(a){var c=cc.rect(0,0,0,0);c.width=this._tileSize.width;c.height=this._tileSize.height;a&=cc.TMX_TILE_FLIPPED_MASK;a-=parseInt(this.firstGid,10);var b=parseInt((this.imageSize.width-2*this.margin+this.spacing)/(this._tileSize.width+this.spacing),10);c.x=parseInt(a%b*(this._tileSize.width+this.spacing)+
this.margin,10);c.y=parseInt(parseInt(a/b,10)*(this._tileSize.height+this.spacing)+this.margin,10);return c}});
cc.TMXMapInfo=cc.SAXParser.extend({properties:null,orientation:null,parentElement:null,parentGID:null,layerAttrs:0,storingCharacters:!1,tmxFileName:null,currentString:null,_objectGroups:null,_mapSize:null,_tileSize:null,_layers:null,_tilesets:null,_tileProperties:null,_resources:"",_currentFirstGID:0,ctor:function(a,c){cc.SAXParser.prototype.ctor.apply(this);this._mapSize=cc.size(0,0);this._tileSize=cc.size(0,0);this._layers=[];this._tilesets=[];this._objectGroups=[];this.properties=[];this._tileProperties=
{};this._currentFirstGID=0;void 0!==c?this.initWithXML(a,c):void 0!==a&&this.initWithTMXFile(a)},getOrientation:function(){return this.orientation},setOrientation:function(a){this.orientation=a},getMapSize:function(){return cc.size(this._mapSize.width,this._mapSize.height)},setMapSize:function(a){this._mapSize.width=a.width;this._mapSize.height=a.height},_getMapWidth:function(){return this._mapSize.width},_setMapWidth:function(a){this._mapSize.width=a},_getMapHeight:function(){return this._mapSize.height},
_setMapHeight:function(a){this._mapSize.height=a},getTileSize:function(){return cc.size(this._tileSize.width,this._tileSize.height)},setTileSize:function(a){this._tileSize.width=a.width;this._tileSize.height=a.height},_getTileWidth:function(){return this._tileSize.width},_setTileWidth:function(a){this._tileSize.width=a},_getTileHeight:function(){return this._tileSize.height},_setTileHeight:function(a){this._tileSize.height=a},getLayers:function(){return this._layers},setLayers:function(a){this._layers.push(a)},
getTilesets:function(){return this._tilesets},setTilesets:function(a){this._tilesets.push(a)},getObjectGroups:function(){return this._objectGroups},setObjectGroups:function(a){this._objectGroups.push(a)},getParentElement:function(){return this.parentElement},setParentElement:function(a){this.parentElement=a},getParentGID:function(){return this.parentGID},setParentGID:function(a){this.parentGID=a},getLayerAttribs:function(){return this.layerAttrs},setLayerAttribs:function(a){this.layerAttrs=a},getStoringCharacters:function(){return this.storingCharacters},
setStoringCharacters:function(a){this.storingCharacters=a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},initWithTMXFile:function(a){this._internalInit(a,null);return this.parseXMLFile(a)},initWithXML:function(a,c){this._internalInit(null,c);return this.parseXMLString(a)},parseXMLFile:function(a,c){var b=(c=c||!1)?a:cc.loader.getRes(a);if(!b)throw"Please load the resource first : "+a;var d,e,b=this._parseXML(b).documentElement;d=b.getAttribute("version");
e=b.getAttribute("orientation");if("map"==b.nodeName&&("1.0"!=d&&null!==d&&cc.log("cocos2d: TMXFormat: Unsupported TMX version:"+d),"orthogonal"==e?this.orientation=cc.TMX_ORIENTATION_ORTHO:"isometric"==e?this.orientation=cc.TMX_ORIENTATION_ISO:"hexagonal"==e?this.orientation=cc.TMX_ORIENTATION_HEX:null!==e&&cc.log("cocos2d: TMXFomat: Unsupported orientation:"+e),d=cc.size(0,0),d.width=parseFloat(b.getAttribute("width")),d.height=parseFloat(b.getAttribute("height")),this.setMapSize(d),d=cc.size(0,
0),d.width=parseFloat(b.getAttribute("tilewidth")),d.height=parseFloat(b.getAttribute("tileheight")),this.setTileSize(d),e=b.querySelectorAll("map \x3e properties \x3e  property"))){var g={};for(d=0;d<e.length;d++)g[e[d].getAttribute("name")]=e[d].getAttribute("value");this.properties=g}g=b.getElementsByTagName("tileset");"map"!==b.nodeName&&(g=[],g.push(b));for(d=0;d<g.length;d++){e=g[d];var f=e.getAttribute("source");if(f)e=c?cc.path.join(this._resources,f):cc.path.changeBasename(a,f),this.parseXMLFile(e);
else{f=new cc.TMXTilesetInfo;f.name=e.getAttribute("name")||"";f.firstGid=parseInt(e.getAttribute("firstgid"))||0;f.spacing=parseInt(e.getAttribute("spacing"))||0;f.margin=parseInt(e.getAttribute("margin"))||0;var h=cc.size(0,0);h.width=parseFloat(e.getAttribute("tilewidth"));h.height=parseFloat(e.getAttribute("tileheight"));f._tileSize=h;var h=e.getElementsByTagName("image")[0].getAttribute("source"),k=-1;this.tmxFileName&&(k=this.tmxFileName.lastIndexOf("/"));-1!==k?(k=this.tmxFileName.substr(0,
k+1),f.sourceImage=k+h):f.sourceImage=this._resources+(this._resources?"/":"")+h;this.setTilesets(f);if(h=e.getElementsByTagName("tile"))for(k=0;k<h.length;k++){e=h[k];this.parentGID=parseInt(f.firstGid)+parseInt(e.getAttribute("id")||0);var l=e.querySelectorAll("properties \x3e property");if(l){var m={};for(e=0;e<l.length;e++){var n=l[e].getAttribute("name");m[n]=l[e].getAttribute("value")}this._tileProperties[this.parentGID]=m}}}}if(g=b.getElementsByTagName("layer"))for(d=0;d<g.length;d++){h=g[d];
k=h.getElementsByTagName("data")[0];f=new cc.TMXLayerInfo;f.name=h.getAttribute("name");e=cc.size(0,0);e.width=parseFloat(h.getAttribute("width"));e.height=parseFloat(h.getAttribute("height"));f._layerSize=e;e=h.getAttribute("visible");f.visible="0"!=e;e=h.getAttribute("opacity")||1;f._opacity=e?parseInt(255*parseFloat(e)):255;f.offset=cc.p(parseFloat(h.getAttribute("x"))||0,parseFloat(h.getAttribute("y"))||0);l="";for(e=0;e<k.childNodes.length;e++)l+=k.childNodes[e].nodeValue;l=l.trim();e=k.getAttribute("compression");
m=k.getAttribute("encoding");if(e&&"gzip"!==e&&"zlib"!==e)return cc.log("cc.TMXMapInfo.parseXMLFile(): unsupported compression method"),null;switch(e){case "gzip":f._tiles=cc.unzipBase64AsArray(l,4);break;case "zlib":e=new Zlib.Inflate(cc.Codec.Base64.decodeAsArray(l,1));f._tiles=cc.uint8ArrayToUint32Array(e.decompress());break;case null:case "":if("base64"==m)f._tiles=cc.Codec.Base64.decodeAsArray(l,4);else if("csv"===m){f._tiles=[];e=l.split(",");for(k=0;k<e.length;k++)f._tiles.push(parseInt(e[k]))}else{e=
k.getElementsByTagName("tile");f._tiles=[];for(k=0;k<e.length;k++)f._tiles.push(parseInt(e[k].getAttribute("gid")))}break;default:this.layerAttrs==cc.TMXLayerInfo.ATTRIB_NONE&&cc.log("cc.TMXMapInfo.parseXMLFile(): Only base64 and/or gzip/zlib maps are supported")}if(h=h.querySelectorAll("properties \x3e property")){k={};for(e=0;e<h.length;e++)k[h[e].getAttribute("name")]=h[e].getAttribute("value");f.properties=k}this.setLayers(f)}if(g=b.getElementsByTagName("objectgroup"))for(d=0;d<g.length;d++){h=
g[d];f=new cc.TMXObjectGroup;f.groupName=h.getAttribute("name");f.setPositionOffset(cc.p(parseFloat(h.getAttribute("x"))*this.getTileSize().width||0,parseFloat(h.getAttribute("y"))*this.getTileSize().height||0));if(k=h.querySelectorAll("objectgroup \x3e properties \x3e property"))for(e=0;e<k.length;e++)l={},l[k[e].getAttribute("name")]=k[e].getAttribute("value"),f.properties=l;if(h=h.querySelectorAll("object"))for(e=0;e<h.length;e++){l=h[e];k={};k.name=l.getAttribute("name")||"";k.type=l.getAttribute("type")||
"";k.x=parseInt(l.getAttribute("x")||0)+f.getPositionOffset().x;m=parseInt(l.getAttribute("y")||0)+f.getPositionOffset().y;k.width=parseInt(l.getAttribute("width"))||0;k.height=parseInt(l.getAttribute("height"))||0;k.y=parseInt(this.getMapSize().height*this.getTileSize().height)-m-k.height;if(m=l.querySelectorAll("properties \x3e property"))for(n=0;n<m.length;n++)k[m[n].getAttribute("name")]=m[n].getAttribute("value");if((m=l.querySelectorAll("polygon"))&&0<m.length)(m=m[0].getAttribute("points"))&&
(k.polygonPoints=this._parsePointsString(m));if((l=l.querySelectorAll("polyline"))&&0<l.length)(l=l[0].getAttribute("points"))&&(k.polylinePoints=this._parsePointsString(l));f.setObjects(k)}this.setObjectGroups(f)}return b},_parsePointsString:function(a){if(!a)return null;var c=[];a=a.split(" ");for(var b=0;b<a.length;b++){var d=a[b].split(",");c.push({x:d[0],y:d[1]})}return c},parseXMLString:function(a){return this.parseXMLFile(a,!0)},getTileProperties:function(){return this._tileProperties},setTileProperties:function(a){this._tileProperties.push(a)},
getCurrentString:function(){return this.currentString},setCurrentString:function(a){this.currentString=a},getTMXFileName:function(){return this.tmxFileName},setTMXFileName:function(a){this.tmxFileName=a},_internalInit:function(a,c){this._tilesets.length=0;this._layers.length=0;this.tmxFileName=a;c&&(this._resources=c);this._objectGroups.length=0;this.properties.length=0;this._tileProperties.length=0;this.currentString="";this.storingCharacters=!1;this.layerAttrs=cc.TMXLayerInfo.ATTRIB_NONE;this.parentElement=
cc.TMX_PROPERTY_NONE;this._currentFirstGID=0}});_p=cc.TMXMapInfo.prototype;cc.defineGetterSetter(_p,"mapWidth",_p._getMapWidth,_p._setMapWidth);cc.defineGetterSetter(_p,"mapHeight",_p._getMapHeight,_p._setMapHeight);cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth);cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight);cc.TMXMapInfo.create=function(a,c){return new cc.TMXMapInfo(a,c)};cc.loader.register(["tmx","tsx"],cc._txtLoader);
cc.TMXLayerInfo.ATTRIB_NONE=1;cc.TMXLayerInfo.ATTRIB_BASE64=2;cc.TMXLayerInfo.ATTRIB_GZIP=4;cc.TMXLayerInfo.ATTRIB_ZLIB=8;cc.TMXObjectGroup=cc.Class.extend({properties:null,groupName:"",_positionOffset:null,_objects:null,ctor:function(){this.groupName="";this._positionOffset=cc.p(0,0);this.properties=[];this._objects=[]},getPositionOffset:function(){return cc.p(this._positionOffset)},setPositionOffset:function(a){this._positionOffset.x=a.x;this._positionOffset.y=a.y},getProperties:function(){return this.properties},setProperties:function(a){this.properties.push(a)},getGroupName:function(){return this.groupName.toString()},
setGroupName:function(a){this.groupName=a},propertyNamed:function(a){return this.properties[a]},objectNamed:function(a){if(this._objects&&0<this._objects.length)for(var c=this._objects,b=0,d=c.length;b<d;b++){var e=c[b].name;if(e&&e==a)return c[b]}return null},getObjects:function(){return this._objects},setObjects:function(a){this._objects.push(a)}});cc.TMXLayer=cc.SpriteBatchNode.extend({tiles:null,tileset:null,layerOrientation:null,properties:null,layerName:"",_layerSize:null,_mapTileSize:null,_opacity:255,_minGID:null,_maxGID:null,_vertexZvalue:null,_useAutomaticVertexZ:null,_alphaFuncValue:null,_reusedTile:null,_atlasIndexArray:null,_contentScaleFactor:null,_cacheCanvas:null,_cacheContext:null,_cacheTexture:null,_subCacheCanvas:null,_subCacheContext:null,_subCacheCount:0,_subCacheWidth:0,_maxCachePixel:1E7,_className:"TMXLayer",ctor:function(a,
c,b){cc.SpriteBatchNode.prototype.ctor.call(this);this._descendants=[];this._layerSize=cc.size(0,0);this._mapTileSize=cc.size(0,0);if(cc._renderType===cc._RENDER_TYPE_CANVAS){var d=cc._canvas,e=cc.newElement("canvas");e.width=d.width;e.height=d.height;this._cacheCanvas=e;this._cacheContext=this._cacheCanvas.getContext("2d");var g=new cc.Texture2D;g.initWithElement(e);g.handleLoadedTexture();this._cacheTexture=g;this.width=d.width;this.height=d.height;this._cachedParent=this}void 0!==b&&this.initWithTilesetInfo(a,
c,b)},setContentSize:function(a,c){var b=this._contentSize;cc.Node.prototype.setContentSize.call(this,a,c);if(cc._renderType===cc._RENDER_TYPE_CANVAS){var d=this._cacheCanvas,e=cc.contentScaleFactor();d.width=0|1.5*b.width*e;d.height=0|1.5*b.height*e;this.layerOrientation===cc.TMX_ORIENTATION_HEX?this._cacheContext.translate(0,d.height-0.5*this._mapTileSize.height):this._cacheContext.translate(0,d.height);b=this._cacheTexture._contentSize;b.width=d.width;b.height=d.height;b=d.width*d.height;if(b>
this._maxCachePixel){this._subCacheCanvas||(this._subCacheCanvas=[]);this._subCacheContext||(this._subCacheContext=[]);this._subCacheCount=Math.ceil(b/this._maxCachePixel);b=this._subCacheCanvas;for(e=0;e<this._subCacheCount;e++){b[e]||(b[e]=document.createElement("canvas"),this._subCacheContext[e]=b[e].getContext("2d"));var g=b[e];g.width=this._subCacheWidth=Math.round(d.width/this._subCacheCount);g.height=d.height}for(e=this._subCacheCount;e<b.length;e++)g.width=0,g.height=0}else this._subCacheCount=
0}},getTexture:null,_getTextureForCanvas:function(){return this._cacheTexture},visit:null,_visitForCanvas:function(a){var c=a||cc._renderContext;if(this._visible){c.save();this.transform(a);var b,d=this._children;if(this._cacheDirty){var e=cc.view;e._setScaleXYForRenderTexture();var g=this._cacheContext,f=this._cacheCanvas;g.clearRect(0,0,f.width,-f.height);g.save();g.translate(this._anchorPointInPoints.x,-this._anchorPointInPoints.y);if(d){this.sortAllChildren();for(b=0;b<d.length;b++)d[b]&&d[b].visit(g)}g.restore();
if(0<this._subCacheCount){d=this._subCacheWidth;g=f.height;for(b=0;b<this._subCacheCount;b++)this._subCacheContext[b].drawImage(f,b*d,0,d,g,0,0,d,g)}e._resetScale();this._cacheDirty=!1}this.draw(a);c.restore()}},draw:null,_drawForCanvas:function(a){a=a||cc._renderContext;var c=0|-this._anchorPointInPoints.x,b=0|-this._anchorPointInPoints.y,d=cc.view,e=this._cacheCanvas;if(e){var g=this._subCacheCount,f=e.height*d._scaleY;if(0<g)for(var e=this._subCacheCanvas,h=0;h<g;h++){var k=e[h];this.layerOrientation===
cc.TMX_ORIENTATION_HEX?a.drawImage(e[h],0,0,k.width,k.height,c+h*this._subCacheWidth,-(b+f)+0.5*this._mapTileSize.height,k.width*d._scaleX,f):a.drawImage(e[h],0,0,k.width,k.height,c+h*this._subCacheWidth,-(b+f),k.width*d._scaleX,f)}else this.layerOrientation===cc.TMX_ORIENTATION_HEX?a.drawImage(e,0,0,e.width,e.height,c,-(b+f)+0.5*this._mapTileSize.height,e.width*d._scaleX,f):a.drawImage(e,0,0,e.width,e.height,c,-(b+f),e.width*d._scaleX,f)}},getLayerSize:function(){return cc.size(this._layerSize.width,
this._layerSize.height)},setLayerSize:function(a){this._layerSize.width=a.width;this._layerSize.height=a.height},_getLayerWidth:function(){return this._layerSize.width},_setLayerWidth:function(a){this._layerSize.width=a},_getLayerHeight:function(){return this._layerSize.height},_setLayerHeight:function(a){this._layerSize.height=a},getMapTileSize:function(){return cc.size(this._mapTileSize.width,this._mapTileSize.height)},setMapTileSize:function(a){this._mapTileSize.width=a.width;this._mapTileSize.height=
a.height},_getTileWidth:function(){return this._mapTileSize.width},_setTileWidth:function(a){this._mapTileSize.width=a},_getTileHeight:function(){return this._mapTileSize.height},_setTileHeight:function(a){this._mapTileSize.height=a},getTiles:function(){return this.tiles},setTiles:function(a){this.tiles=a},getTileset:function(){return this.tileset},setTileset:function(a){this.tileset=a},getLayerOrientation:function(){return this.layerOrientation},setLayerOrientation:function(a){this.layerOrientation=
a},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},initWithTilesetInfo:function(a,c,b){var d=c._layerSize,e=0.35*parseInt(d.width*d.height)+1,g;a&&(g=cc.textureCache.addImage(a.sourceImage));return this.initWithTexture(g,e)?(this.layerName=c.name,this._layerSize=d,this.tiles=c._tiles,this._minGID=c._minGID,this._maxGID=c._maxGID,this._opacity=c._opacity,this.properties=c.properties,this._contentScaleFactor=cc.director.getContentScaleFactor(),this.tileset=
a,this._mapTileSize=b.getTileSize(),this.layerOrientation=b.orientation,a=this._calculateLayerOffset(c.offset),this.setPosition(cc.pointPixelsToPoints(a)),this._atlasIndexArray=[],this.setContentSize(cc.sizePixelsToPoints(cc.size(this._layerSize.width*this._mapTileSize.width,this._layerSize.height*this._mapTileSize.height))),this._useAutomaticVertexZ=!1,this._vertexZvalue=0,!0):!1},releaseMap:function(){this.tiles&&(this.tiles=null);this._atlasIndexArray&&(this._atlasIndexArray=null)},getTileAt:function(a,
c){if(!a)throw"cc.TMXLayer.getTileAt(): pos should be non-null";void 0!==c&&(a=cc.p(a,c));if(a.x>=this._layerSize.width||a.y>=this._layerSize.height||0>a.x||0>a.y)throw"cc.TMXLayer.getTileAt(): invalid position";if(!this.tiles||!this._atlasIndexArray)return cc.log("cc.TMXLayer.getTileAt(): TMXLayer: the tiles map has been released"),null;var b=null,d=this.getTileGIDAt(a);if(0===d)return b;var e=0|a.x+a.y*this._layerSize.width,b=this.getChildByTag(e);b||(d=this.tileset.rectForGID(d),d=cc.rectPixelsToPoints(d),
b=new cc.Sprite,b.initWithTexture(this.texture,d),b.batchNode=this,b.setPosition(this.getPositionAt(a)),b.vertexZ=this._vertexZForPos(a),b.anchorX=0,b.anchorY=0,b.opacity=this._opacity,d=this._atlasIndexForExistantZ(e),this.addSpriteWithoutQuad(b,d,e));return b},getTileGIDAt:function(a,c){if(!a)throw"cc.TMXLayer.getTileGIDAt(): pos should be non-null";void 0!==c&&(a=cc.p(a,c));if(a.x>=this._layerSize.width||a.y>=this._layerSize.height||0>a.x||0>a.y)throw"cc.TMXLayer.getTileGIDAt(): invalid position";
return!this.tiles||!this._atlasIndexArray?(cc.log("cc.TMXLayer.getTileGIDAt(): TMXLayer: the tiles map has been released"),null):(this.tiles[0|a.x+a.y*this._layerSize.width]&cc.TMX_TILE_FLIPPED_MASK)>>>0},getTileFlagsAt:function(a,c){if(!a)throw"cc.TMXLayer.getTileFlagsAt(): pos should be non-null";void 0!==c&&(a=cc.p(a,c));if(a.x>=this._layerSize.width||a.y>=this._layerSize.height||0>a.x||0>a.y)throw"cc.TMXLayer.getTileFlagsAt(): invalid position";return!this.tiles||!this._atlasIndexArray?(cc.log("cc.TMXLayer.getTileFlagsAt(): TMXLayer: the tiles map has been released"),
null):(this.tiles[0|a.x+a.y*this._layerSize.width]&cc.TMX_TILE_FLIPPED_ALL)>>>0},setTileGID:function(a,c,b,d){if(!c)throw"cc.TMXLayer.setTileGID(): pos should be non-null";void 0!==d?c=cc.p(c,b):d=b;if(c.x>=this._layerSize.width||c.y>=this._layerSize.height||0>c.x||0>c.y)throw"cc.TMXLayer.setTileGID(): invalid position";if(!this.tiles||!this._atlasIndexArray)cc.log("cc.TMXLayer.setTileGID(): TMXLayer: the tiles map has been released");else if(0!==a&&a<this.tileset.firstGid)cc.log("cc.TMXLayer.setTileGID(): invalid gid:"+
a);else{d=d||0;this._setNodeDirtyForCache();b=this.getTileFlagsAt(c);var e=this.getTileGIDAt(c);if(e!=a||b!=d)if(b=(a|d)>>>0,0===a)this.removeTileAt(c);else if(0===e)this._insertTileForGID(b,c);else{var e=c.x+c.y*this._layerSize.width,g=this.getChildByTag(e);g?(a=this.tileset.rectForGID(a),a=cc.rectPixelsToPoints(a),g.setTextureRect(a,!1),null!=d&&this._setupTileSprite(g,c,b),this.tiles[e]=b):this._updateTileForGID(b,c)}}},removeTileAt:function(a,c){if(!a)throw"cc.TMXLayer.removeTileAt(): pos should be non-null";
void 0!==c&&(a=cc.p(a,c));if(a.x>=this._layerSize.width||a.y>=this._layerSize.height||0>a.x||0>a.y)throw"cc.TMXLayer.removeTileAt(): invalid position";if(!this.tiles||!this._atlasIndexArray)cc.log("cc.TMXLayer.removeTileAt(): TMXLayer: the tiles map has been released");else if(0!==this.getTileGIDAt(a)){cc._renderType===cc._RENDER_TYPE_CANVAS&&this._setNodeDirtyForCache();var b=0|a.x+a.y*this._layerSize.width,d=this._atlasIndexForExistantZ(b);this.tiles[b]=0;this._atlasIndexArray.splice(d,1);if(b=
this.getChildByTag(b))cc.SpriteBatchNode.prototype.removeChild.call(this,b,!0);else if(cc._renderType===cc._RENDER_TYPE_WEBGL&&this.textureAtlas.removeQuadAtIndex(d),this._children)for(var b=this._children,e=0,g=b.length;e<g;e++){var f=b[e];if(f){var h=f.atlasIndex;h>=d&&(f.atlasIndex=h-1)}}}},getPositionAt:function(a,c){void 0!==c&&(a=cc.p(a,c));var b=cc.p(0,0);switch(this.layerOrientation){case cc.TMX_ORIENTATION_ORTHO:b=this._positionForOrthoAt(a);break;case cc.TMX_ORIENTATION_ISO:b=this._positionForIsoAt(a);
break;case cc.TMX_ORIENTATION_HEX:b=this._positionForHexAt(a)}return cc.pointPixelsToPoints(b)},getProperty:function(a){return this.properties[a]},setupTiles:function(){cc._renderType===cc._RENDER_TYPE_CANVAS?this.tileset.imageSize=this._originalTexture.getContentSizeInPixels():(this.tileset.imageSize=this.textureAtlas.texture.getContentSizeInPixels(),this.textureAtlas.texture.setAliasTexParameters());this._parseInternalProperties();cc._renderType===cc._RENDER_TYPE_CANVAS&&this._setNodeDirtyForCache();
for(var a=this._layerSize.height,c=this._layerSize.width,b=0;b<a;b++)for(var d=0;d<c;d++){var e=this.tiles[d+c*b];0!==e&&(this._appendTileForGID(e,cc.p(d,b)),this._minGID=Math.min(e,this._minGID),this._maxGID=Math.max(e,this._maxGID))}this._maxGID>=this.tileset.firstGid&&this._minGID>=this.tileset.firstGid||cc.log("cocos2d:TMX: Only 1 tileset per layer is supported")},addChild:function(a,c,b){cc.log("addChild: is not supported on cc.TMXLayer. Instead use setTileGID or tileAt.")},removeChild:function(a,
c){if(a)if(-1===this._children.indexOf(a))cc.log("cc.TMXLayer.removeChild(): Tile does not belong to TMXLayer");else{cc._renderType===cc._RENDER_TYPE_CANVAS&&this._setNodeDirtyForCache();var b=a.atlasIndex;this.tiles[this._atlasIndexArray[b]]=0;this._atlasIndexArray.splice(b,1);cc.SpriteBatchNode.prototype.removeChild.call(this,a,c)}},getLayerName:function(){return this.layerName},setLayerName:function(a){this.layerName=a},_positionForIsoAt:function(a){return cc.p(this._mapTileSize.width/2*(this._layerSize.width+
a.x-a.y-1),this._mapTileSize.height/2*(2*this._layerSize.height-a.x-a.y-2))},_positionForOrthoAt:function(a){return cc.p(a.x*this._mapTileSize.width,(this._layerSize.height-a.y-1)*this._mapTileSize.height)},_positionForHexAt:function(a){return cc.p(3*a.x*this._mapTileSize.width/4,(this._layerSize.height-a.y-1)*this._mapTileSize.height+(1==a.x%2?-this._mapTileSize.height/2:0))},_calculateLayerOffset:function(a){var c=cc.p(0,0);switch(this.layerOrientation){case cc.TMX_ORIENTATION_ORTHO:c=cc.p(a.x*
this._mapTileSize.width,-a.y*this._mapTileSize.height);break;case cc.TMX_ORIENTATION_ISO:c=cc.p(this._mapTileSize.width/2*(a.x-a.y),this._mapTileSize.height/2*(-a.x-a.y));break;case cc.TMX_ORIENTATION_HEX:(0!==a.x||0!==a.y)&&cc.log("offset for hexagonal map not implemented yet")}return c},_appendTileForGID:function(a,c){var b=this.tileset.rectForGID(a),b=cc.rectPixelsToPoints(b),d=0|c.x+c.y*this._layerSize.width,b=this._reusedTileWithRect(b);this._setupTileSprite(b,c,a);var e=this._atlasIndexArray.length;
this.insertQuadFromSprite(b,e);this._atlasIndexArray.splice(e,0,d);return b},_insertTileForGID:function(a,c){var b=this.tileset.rectForGID(a),b=cc.rectPixelsToPoints(b),d=0|c.x+c.y*this._layerSize.width,b=this._reusedTileWithRect(b);this._setupTileSprite(b,c,a);var e=this._atlasIndexForNewZ(d);this.insertQuadFromSprite(b,e);this._atlasIndexArray.splice(e,0,d);if(this._children)for(var g=this._children,f=0,h=g.length;f<h;f++){var k=g[f];if(k){var l=k.atlasIndex;l>=e&&(k.atlasIndex=l+1)}}this.tiles[d]=
a;return b},_updateTileForGID:function(a,c){var b=this.tileset.rectForGID(a),d=this._contentScaleFactor,b=cc.rect(b.x/d,b.y/d,b.width/d,b.height/d),d=c.x+c.y*this._layerSize.width,b=this._reusedTileWithRect(b);this._setupTileSprite(b,c,a);b.atlasIndex=this._atlasIndexForExistantZ(d);b.dirty=!0;b.updateTransform();this.tiles[d]=a;return b},_parseInternalProperties:function(){var a=this.getProperty("cc_vertexz");if(a)if("automatic"==a){this._useAutomaticVertexZ=!0;var c=this.getProperty("cc_alpha_func"),
a=0;c&&(a=parseFloat(c));cc._renderType===cc._RENDER_TYPE_WEBGL&&(this.shaderProgram=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLORALPHATEST),c=cc._renderContext.getUniformLocation(this.shaderProgram.getProgram(),cc.UNIFORM_ALPHA_TEST_VALUE_S),this.shaderProgram.use(),this.shaderProgram.setUniformLocationWith1f(c,a))}else this._vertexZvalue=parseInt(a,10)},_setupTileSprite:function(a,c,b){var d=c.x+c.y*this._layerSize.width;a.setPosition(this.getPositionAt(c));cc._renderType===cc._RENDER_TYPE_WEBGL?
a.vertexZ=this._vertexZForPos(c):a.tag=d;a.anchorX=0;a.anchorY=0;a.opacity=this._opacity;cc._renderType===cc._RENDER_TYPE_WEBGL&&(a.rotation=0);a.setFlippedX(!1);a.setFlippedY(!1);(b&cc.TMX_TILE_DIAGONAL_FLAG)>>>0?(a.anchorX=0.5,a.anchorY=0.5,a.x=this.getPositionAt(c).x+a.width/2,a.y=this.getPositionAt(c).y+a.height/2,c=(b&(cc.TMX_TILE_HORIZONTAL_FLAG|cc.TMX_TILE_VERTICAL_FLAG)>>>0)>>>0,c==cc.TMX_TILE_HORIZONTAL_FLAG?a.rotation=90:c==cc.TMX_TILE_VERTICAL_FLAG?a.rotation=270:(a.rotation=c==(cc.TMX_TILE_VERTICAL_FLAG|
cc.TMX_TILE_HORIZONTAL_FLAG)>>>0?90:270,a.setFlippedX(!0))):((b&cc.TMX_TILE_HORIZONTAL_FLAG)>>>0&&a.setFlippedX(!0),(b&cc.TMX_TILE_VERTICAL_FLAG)>>>0&&a.setFlippedY(!0))},_reusedTileWithRect:function(a){cc._renderType===cc._RENDER_TYPE_WEBGL?(this._reusedTile?(this._reusedTile.batchNode=null,this._reusedTile.setTextureRect(a,!1)):(this._reusedTile=new cc.Sprite,this._reusedTile.initWithTexture(this.texture,a,!1)),this._reusedTile.batchNode=this):(this._reusedTile=new cc.Sprite,this._reusedTile.initWithTexture(this._textureForCanvas,
a,!1),this._reusedTile.batchNode=this,this._reusedTile.parent=this);return this._reusedTile},_vertexZForPos:function(a){var c=0,b=0;if(this._useAutomaticVertexZ)switch(this.layerOrientation){case cc.TMX_ORIENTATION_ISO:b=this._layerSize.width+this._layerSize.height;c=-(b-(a.x+a.y));break;case cc.TMX_ORIENTATION_ORTHO:c=-(this._layerSize.height-a.y);break;case cc.TMX_ORIENTATION_HEX:cc.log("TMX Hexa zOrder not supported");break;default:cc.log("TMX invalid value")}else c=this._vertexZvalue;return c},
_atlasIndexForExistantZ:function(a){var c;if(this._atlasIndexArray)for(var b=this._atlasIndexArray,d=0,e=b.length;d<e&&!(c=b[d],c==a);d++);"number"!=typeof c&&cc.log("cc.TMXLayer._atlasIndexForExistantZ(): TMX atlas index not found. Shall not happen");return d},_atlasIndexForNewZ:function(a){for(var c=this._atlasIndexArray,b=0,d=c.length;b<d&&!(a<c[b]);b++);return b}});_p=cc.TMXLayer.prototype;
cc._renderType==cc._RENDER_TYPE_WEBGL?(_p.draw=cc.SpriteBatchNode.prototype.draw,_p.visit=cc.SpriteBatchNode.prototype.visit,_p.getTexture=cc.SpriteBatchNode.prototype.getTexture):(_p.draw=_p._drawForCanvas,_p.visit=_p._visitForCanvas,_p.getTexture=_p._getTextureForCanvas);cc.defineGetterSetter(_p,"texture",_p.getTexture,_p.setTexture);cc.defineGetterSetter(_p,"layerWidth",_p._getLayerWidth,_p._setLayerWidth);cc.defineGetterSetter(_p,"layerHeight",_p._getLayerHeight,_p._setLayerHeight);
cc.defineGetterSetter(_p,"tileWidth",_p._getTileWidth,_p._setTileWidth);cc.defineGetterSetter(_p,"tileHeight",_p._getTileHeight,_p._setTileHeight);cc.TMXLayer.create=function(a,c,b){return new cc.TMXLayer(a,c,b)};