cc.MotionStreak=cc.NodeRGBA.extend({texture:null,fastMode:!1,startingPositionInitialized:!1,_blendFunc:null,_stroke:0,_fadeDelta:0,_minSeg:0,_maxPoints:0,_nuPoints:0,_previousNuPoints:0,_pointVertexes:null,_pointState:null,_vertices:null,_colorPointer:null,_texCoords:null,_verticesBuffer:null,_colorPointerBuffer:null,_texCoordsBuffer:null,_className:"MotionStreak",ctor:function(a,d,c,b,g){cc.NodeRGBA.prototype.ctor.call(this);this._positionR=cc.p(0,0);this._blendFunc=new cc.BlendFunc(cc.SRC_ALPHA,
cc.ONE_MINUS_SRC_ALPHA);this._vertexWebGLBuffer=cc._renderContext.createBuffer();this.startingPositionInitialized=this.fastMode=!1;this.texture=null;this._previousNuPoints=this._nuPoints=this._maxPoints=this._minSeg=this._fadeDelta=this._stroke=0;this._texCoordsBuffer=this._colorPointerBuffer=this._verticesBuffer=this._texCoords=this._colorPointer=this._vertices=this._pointState=this._pointVertexes=null;void 0!==g&&this.initWithFade(a,d,c,b,g)},getTexture:function(){return this.texture},setTexture:function(a){this.texture!=
a&&(this.texture=a)},getBlendFunc:function(){return this._blendFunc},setBlendFunc:function(a,d){void 0===d?this._blendFunc=a:(this._blendFunc.src=a,this._blendFunc.dst=d)},getOpacity:function(){cc.log("cc.MotionStreak.getOpacity has not been supported.");return 0},setOpacity:function(a){cc.log("cc.MotionStreak.setOpacity has not been supported.")},setOpacityModifyRGB:function(a){},isOpacityModifyRGB:function(){return!1},onExit:function(){cc.Node.prototype.onExit.call(this);this._verticesBuffer&&cc._renderContext.deleteBuffer(this._verticesBuffer);
this._texCoordsBuffer&&cc._renderContext.deleteBuffer(this._texCoordsBuffer);this._colorPointerBuffer&&cc._renderContext.deleteBuffer(this._colorPointerBuffer)},isFastMode:function(){return this.fastMode},setFastMode:function(a){this.fastMode=a},isStartingPositionInitialized:function(){return this.startingPositionInitialized},setStartingPositionInitialized:function(a){this.startingPositionInitialized=a},initWithFade:function(a,d,c,b,g){if(!g)throw"cc.MotionStreak.initWithFade(): Invalid filename or texture";
"string"===typeof g&&(g=cc.textureCache.addImage(g));cc.Node.prototype.setPosition.call(this,cc.p(0,0));this.anchorY=this.anchorX=0;this.ignoreAnchor=!0;this.startingPositionInitialized=!1;this.fastMode=!0;this._minSeg=-1==d?c/5:d;this._minSeg*=this._minSeg;this._stroke=c;this._fadeDelta=1/a;a=(0|60*a)+2;this._nuPoints=0;this._pointState=new Float32Array(a);this._pointVertexes=new Float32Array(2*a);this._vertices=new Float32Array(4*a);this._texCoords=new Float32Array(4*a);this._colorPointer=new Uint8Array(8*
a);this._maxPoints=a;a=cc._renderContext;this._verticesBuffer=a.createBuffer();this._texCoordsBuffer=a.createBuffer();this._colorPointerBuffer=a.createBuffer();this._blendFunc.src=a.SRC_ALPHA;this._blendFunc.dst=a.ONE_MINUS_SRC_ALPHA;this.shaderProgram=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR);this.texture=g;this.color=b;this.scheduleUpdate();a.bindBuffer(a.ARRAY_BUFFER,this._verticesBuffer);a.bufferData(a.ARRAY_BUFFER,this._vertices,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,
this._texCoordsBuffer);a.bufferData(a.ARRAY_BUFFER,this._texCoords,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this._colorPointerBuffer);a.bufferData(a.ARRAY_BUFFER,this._colorPointer,a.DYNAMIC_DRAW);return!0},tintWithColor:function(a){this.color=a;for(var d=this._colorPointer,c=0,b=2*this._nuPoints;c<b;c++)d[4*c]=a.r,d[4*c+1]=a.g,d[4*c+2]=a.b},reset:function(){this._nuPoints=0},setPosition:function(a,d){this.startingPositionInitialized=!0;void 0===d?(this._positionR.x=a.x,this._positionR.y=a.y):
(this._positionR.x=a,this._positionR.y=d)},getPositionX:function(){return this._positionR.x},setPositionX:function(a){this._positionR.x=a;this.startingPositionInitialized||(this.startingPositionInitialized=!0)},getPositionY:function(){return this._positionR.y},setPositionY:function(a){this._positionR.y=a;this.startingPositionInitialized||(this.startingPositionInitialized=!0)},draw:function(a){!(1>=this._nuPoints)&&(this.texture&&this.texture.isLoaded())&&(a=a||cc._renderContext,cc.nodeDrawSetup(this),
cc.glEnableVertexAttribs(cc.VERTEX_ATTRIB_FLAG_POS_COLOR_TEX),cc.glBlendFunc(this._blendFunc.src,this._blendFunc.dst),cc.glBindTexture2D(this.texture),a.bindBuffer(a.ARRAY_BUFFER,this._verticesBuffer),a.bufferData(a.ARRAY_BUFFER,this._vertices,a.DYNAMIC_DRAW),a.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION,2,a.FLOAT,!1,0,0),a.bindBuffer(a.ARRAY_BUFFER,this._texCoordsBuffer),a.bufferData(a.ARRAY_BUFFER,this._texCoords,a.DYNAMIC_DRAW),a.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS,2,a.FLOAT,!1,0,
0),a.bindBuffer(a.ARRAY_BUFFER,this._colorPointerBuffer),a.bufferData(a.ARRAY_BUFFER,this._colorPointer,a.DYNAMIC_DRAW),a.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR,4,a.UNSIGNED_BYTE,!0,0,0),a.drawArrays(a.TRIANGLE_STRIP,0,2*this._nuPoints),cc.g_NumberOfDraws++)},update:function(a){if(this.startingPositionInitialized){a*=this._fadeDelta;var d,c,b,g,m=0,f=this._nuPoints,h=this._pointState,k=this._pointVertexes,l=this._vertices,e=this._colorPointer;for(b=0;b<f;b++)h[b]-=a,0>=h[b]?m++:(d=b-m,0<m?(h[d]=
h[b],k[2*d]=k[2*b],k[2*d+1]=k[2*b+1],g=2*b,c=2*d,l[2*c]=l[2*g],l[2*c+1]=l[2*g+1],l[2*(c+1)]=l[2*(g+1)],l[2*(c+1)+1]=l[2*(g+1)+1],g*=4,c*=4,e[c+0]=e[g+0],e[c+1]=e[g+1],e[c+2]=e[g+2],e[c+4]=e[g+4],e[c+5]=e[g+5],e[c+6]=e[g+6]):c=8*d,d=255*h[d],e[c+3]=d,e[c+7]=d);f-=m;b=!0;if(f>=this._maxPoints)b=!1;else if(0<f&&(a=cc.pDistanceSQ(cc.p(k[2*(f-1)],k[2*(f-1)+1]),this._positionR)<this._minSeg,c=1==f?!1:cc.pDistanceSQ(cc.p(k[2*(f-2)],k[2*(f-2)+1]),this._positionR)<2*this._minSeg,a||c))b=!1;b&&(k[2*f]=this._positionR.x,
k[2*f+1]=this._positionR.y,h[f]=1,h=8*f,b=this._displayedColor,e[h]=b.r,e[h+1]=b.g,e[h+2]=b.b,e[h+4]=b.r,e[h+5]=b.g,e[h+6]=b.b,e[h+3]=255,e[h+7]=255,0<f&&this.fastMode&&(1<f?cc.vertexLineToPolygon(k,this._stroke,this._vertices,f,1):cc.vertexLineToPolygon(k,this._stroke,this._vertices,0,2)),f++);this.fastMode||cc.vertexLineToPolygon(k,this._stroke,this._vertices,0,f);if(f&&this._previousNuPoints!=f){k=1/f;e=this._texCoords;for(b=0;b<f;b++)e[4*b]=0,e[4*b+1]=k*b,e[2*(2*b+1)]=1,e[2*(2*b+1)+1]=k*b;this._previousNuPoints=
f}this._nuPoints=f}}});cc.MotionStreak.create=function(a,d,c,b,g){return new cc.MotionStreak(a,d,c,b,g)};