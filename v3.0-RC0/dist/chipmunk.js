(function(){Object.create=Object.create||function(a){function b(){}b.prototype=a;return new b};var h;"undefined"===typeof exports?(h={},"object"===typeof window&&(window.cp=h)):h=exports;var l=function(a,b){if(!a)throw Error("Assertion failed: "+b);},G=function(a,b){!a&&(console&&console.warn)&&(console.warn("ASSERTION FAILED: "+b),console.trace&&console.trace())},ab=function(a,b){return a<b?a:b},bb=function(a,b){return a>b?a:b},t,w;"object"===typeof window&&-1<window.navigator.userAgent.indexOf("Firefox")?
(t=Math.min,w=Math.max):(t=ab,w=bb);var H=function(a,b){return a<b?a+" "+b:b+" "+a},M=function(a,b){for(var c=0;c<a.length;c++)if(a[c]===b){a[c]=a[a.length-1];a.length--;break}};h.momentForCircle=function(a,b,c,d){return a*(0.5*(b*b+c*c)+I(d))};h.areaForCircle=function(a,b){return Math.PI*Math.abs(a*a-b*b)};h.momentForSegment=function(a,b,c){var d=N(p(c,b));b=v(s(b,c),0.5);return a*(d*d/12+I(b))};h.areaForSegment=function(a,b,c){return c*(Math.PI*c+2*Ga(a,b))};h.momentForPoly=function(a,b,c){for(var d=
0,e=0,f=b.length,g=0;g<f;g+=2)var k=b[g]+c.x,na=b[g+1]+c.y,h=b[(g+2)%f]+c.x,u=b[(g+3)%f]+c.y,m=h*na-u*k,d=d+m*(k*k+na*na+(k*h+na*u)+(h*h+u*u)),e=e+m;return a*d/(6*e)};h.areaForPoly=function(a){for(var b=0,c=0,d=a.length;c<d;c+=2)b+=E(new m(a[c],a[c+1]),new m(a[(c+2)%d],a[(c+3)%d]));return-b/2};var cb=h.centroidForPoly=function(a){for(var b=0,c=new m(0,0),d=0,e=a.length;d<e;d+=2)var f=new m(a[d],a[d+1]),g=new m(a[(d+2)%e],a[(d+3)%e]),k=E(f,g),b=b+k,c=s(c,v(s(f,g),k));return v(c,1/(3*b))};h.recenterPoly=
function(a){for(var b=cb(a),c=0;c<a.length;c+=2)a[c]-=b.x,a[c+1]-=b.y};var db=h.momentForBox=function(a,b,c){return a*(b*b+c*c)/12};h.momentForBox2=function(a,b){width=b.r-b.l;height=b.t-b.b;offset=v([b.l+b.r,b.b+b.t],0.5);return db(a,width,height)+a*I(offset)};var F=function(a,b,c){return t(w(a,b),c)},Ha=h.clamp01=function(a){return w(0,t(a,1))},eb=0,m=h.Vect=function(a,b){this.x=a;this.y=b;eb++};h.v=function(a,b){return new m(a,b)};var D=h.vzero=new m(0,0),r=h.v.dot=function(a,b){return a.x*b.x+
a.y*b.y},N=h.v.len=function(a){return Math.sqrt(r(a,a))};h.v.eql=function(a,b){return a.x===b.x&&a.y===b.y};var s=h.v.add=function(a,b){return new m(a.x+b.x,a.y+b.y)};m.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};var p=h.v.sub=function(a,b){return new m(a.x-b.x,a.y-b.y)};m.prototype.sub=function(a){this.x-=a.x;this.y-=a.y;return this};var O=h.v.neg=function(a){return new m(-a.x,-a.y)};m.prototype.neg=function(){this.x=-this.x;this.y=-this.y;return this};var v=h.v.mult=function(a,
b){return new m(a.x*b,a.y*b)};m.prototype.mult=function(a){this.x*=a;this.y*=a;return this};var E=h.v.cross=function(a,b){return a.x*b.y-a.y*b.x},P=h.v.perp=function(a){return new m(-a.y,a.x)};h.v.pvrperp=function(a){return new m(a.y,-a.x)};var fb=h.v.project=function(a,b){return v(b,r(a,b)/I(b))};m.prototype.project=function(a){this.mult(r(this,a)/I(a));return this};var z=h.v.rotate=function(a,b){return new m(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)};m.prototype.rotate=function(a){this.x=this.x*a.x-this.y*
a.y;this.y=this.x*a.y+this.y*a.x;return this};var gb=h.v.unrotate=function(a,b){return new m(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},I=h.v.lengthsq=function(a){return r(a,a)},pa=h.v.lerp=function(a,b,c){return s(v(a,1-c),v(b,c))},Q=h.v.normalize=function(a){return v(a,1/N(a))},Ia=h.v.normalize_safe=function(a){return 0===a.x&&0===a.y?D:Q(a)},ba=h.v.clamp=function(a,b){return r(a,a)>b*b?v(Q(a),b):a};h.v.lerpconst=function(a,b,c){return s(a,ba(p(b,a),c))};var Ga=h.v.dist=function(a,b){return N(p(a,b))},hb=
h.v.distsq=function(a,b){return I(p(a,b))};h.v.near=function(a,b,c){return hb(a,b)<c*c};var ib=h.v.slerp=function(a,b,c){var d=Math.acos(r(a,b));if(d){var e=1/Math.sin(d);return s(v(a,Math.sin((1-c)*d)*e),v(b,Math.sin(c*d)*e))}return a};h.v.slerpconst=function(a,b,c){var d=Math.acos(r(a,b));return ib(a,b,t(c,d)/d)};h.v.forangle=function(a){return new m(Math.cos(a),Math.sin(a))};h.v.toangle=function(a){return Math.atan2(a.y,a.x)};h.v.str=function(a){return"("+a.x.toFixed(3)+", "+a.y.toFixed(3)+")"};
var jb=0,Y=h.BB=function(a,b,c,d){this.l=a;this.b=b;this.r=c;this.t=d;jb++};h.bb=function(a,b,c,d){return new Y(a,b,c,d)};var Ja=0;h.NO_GROUP=0;var kb=h.ALL_LAYERS=-1;h.resetShapeIdCounter=function(){Ja=0};var B=h.Shape=function(a){this.body=a;this.bb_l=this.bb_b=this.bb_r=this.bb_t=0;this.hashid=Ja++;this.sensor=!1;this.u=this.e=0;this.surface_v=D;this.group=this.collision_type=0;this.layers=kb;this.space=null;this.collisionCode=this.collisionCode};B.prototype.setElasticity=function(a){this.e=a};
B.prototype.setFriction=function(a){this.body.activate();this.u=a};B.prototype.setLayers=function(a){this.body.activate();this.layers=a};B.prototype.setSensor=function(a){this.body.activate();this.sensor=a};B.prototype.setCollisionType=function(a){this.body.activate();this.collision_type=a};B.prototype.getBody=function(){return this.body};B.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)};B.prototype.setBody=function(a){l(!this.active(),"You cannot change the body on an active shape. You must remove the shape, then ");
this.body=a};B.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)};B.prototype.update=function(a,b){l(!isNaN(b.x),"Rotation is NaN");l(!isNaN(a.x),"Position is NaN");this.cacheData(a,b)};B.prototype.getBB=function(){return new Y(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var qa=function(a){this.shape=a;this.d=Infinity;this.n=D},ca=function(a,b,c){this.shape=a;this.t=b;this.n=c};ca.prototype.hitPoint=function(a,b){return pa(a,b,this.t)};ca.prototype.hitDist=function(a,b){return Ga(a,
b)*this.t};var Z=h.CircleShape=function(a,b,c){this.c=this.tc=c;this.r=b;this.type="circle";B.call(this,a)};Z.prototype=Object.create(B.prototype);Z.prototype.cacheData=function(a,b){var c=this.tc=z(this.c,b).add(a),d=this.r;this.bb_l=c.x-d;this.bb_b=c.y-d;this.bb_r=c.x+d;this.bb_t=c.y+d};Z.prototype.pointQuery=function(a){a=p(a,this.tc);var b=I(a),c=this.r;if(b<c*c){var d=new qa(this),b=Math.sqrt(b);d.d=c-b;d.n=v(a,1/b);return d}};var ra=function(a,b,c,d,e,f){d=p(d,b);e=p(e,b);b=r(d,d)-2*r(d,e)+
r(e,e);f=-2*r(d,d)+2*r(d,e);c=r(d,d)-c*c;c=f*f-4*b*c;if(0<=c&&(c=(-f-Math.sqrt(c))/(2*b),0<=c&&1>=c))return new ca(a,c,Q(pa(d,e,c)))};Z.prototype.segmentQuery=function(a,b){return ra(this,this.tc,this.r,a,b)};var T=h.SegmentShape=function(a,b,c,d){this.a=b;this.b=c;this.n=P(Q(p(c,b)));this.ta=this.tb=this.tn=null;this.r=d;this.b_tangent=this.a_tangent=D;this.type="segment";B.call(this,a)};T.prototype=Object.create(B.prototype);T.prototype.cacheData=function(a,b){this.ta=s(a,z(this.a,b));this.tb=s(a,
z(this.b,b));this.tn=z(this.n,b);var c,d,e,f;this.ta.x<this.tb.x?(c=this.ta.x,d=this.tb.x):(c=this.tb.x,d=this.ta.x);this.ta.y<this.tb.y?(e=this.ta.y,f=this.tb.y):(e=this.tb.y,f=this.ta.y);var g=this.r;this.bb_l=c-g;this.bb_b=e-g;this.bb_r=d+g;this.bb_t=f+g};T.prototype.pointQuery=function(a){if(this.bb_l<=a.x&&this.bb_r>=a.x&&this.bb_b<=a.y&&this.bb_t>=a.y){var b=this.ta,c=p(this.tb,b),d=Ha(r(c,p(a,b))/I(c)),b=s(b,v(c,d));a=p(a,b);d=I(a);b=this.r;if(d<b*b)return c=new qa(this),d=Math.sqrt(d),c.d=
b-d,c.n=v(a,1/d),c}};T.prototype.segmentQuery=function(a,b){var c=this.tn,d=r(p(this.ta,a),c),e=this.r,f=0<d?O(c):c,g=p(v(f,e),a),k=s(this.ta,g),h=s(this.tb,g),g=p(b,a);if(0>=E(g,k)*E(g,h)){if(e=d+(0<d?-e:e),d=-e,c=r(g,c)-e,0>d*c)return new ca(this,d/(d-c),f)}else if(0!==e)return f=ra(this,this.ta,this.r,a,b),c=ra(this,this.tb,this.r,a,b),f?c&&c.t<f.t?c:f:c};T.prototype.setNeighbors=function(a,b){this.a_tangent=p(a,this.a);this.b_tangent=p(b,this.b)};T.prototype.setEndpoints=function(a,b){this.a=
a;this.b=b;this.n=P(Q(p(b,a)))};var C=h.PolyShape=function(a,b,c){l(4<=b.length,"Polygons require some verts");l("number"===typeof b[0],"Polygon verticies should be specified in a flattened list");var d;a:{d=b.length;for(var e=0;e<d;e+=2){var f=b[(e+2)%d],g=b[(e+3)%d];if(0<(f-b[e])*(b[(e+5)%d]-g)-(g-b[e+1])*(b[(e+4)%d]-f)){d=!1;break a}}d=!0}l(d,"Polygon is concave or has a reversed winding.");this.setVerts(b,c);this.type="poly";B.call(this,a)};C.prototype=Object.create(B.prototype);var Ka=function(a,
b){this.n=a;this.d=b};C.prototype.setVerts=function(a,b){var c=a.length,d=c>>1;this.verts=Array(c);this.tVerts=Array(c);this.axes=Array(d);this.tAxes=Array(d);for(d=0;d<c;d+=2){var e=a[d]+b.x,f=a[d+1]+b.y,g=Q(P(new m(a[(d+2)%c]+b.x-e,a[(d+3)%c]+b.y-f)));this.verts[d]=e;this.verts[d+1]=f;this.axes[d>>1]=new Ka(g,g.x*e+g.y*f);this.tAxes[d>>1]=new Ka(new m(0,0),0)}};h.BoxShape=function(a,b,c){b/=2;c/=2;return lb(a,new Y(-b,-c,b,c))};var lb=h.BoxShape2=function(a,b){return new C(a,[b.l,b.b,b.l,b.t,b.r,
b.t,b.r,b.b],D)};C.prototype.transformVerts=function(a,b){for(var c=this.verts,d=this.tVerts,e=Infinity,f=-Infinity,g=Infinity,k=-Infinity,h=0;h<c.length;h+=2){var m=c[h],u=c[h+1],l=a.x+m*b.x-u*b.y,m=a.y+m*b.y+u*b.x;d[h]=l;d[h+1]=m;e=t(e,l);f=w(f,l);g=t(g,m);k=w(k,m)}this.bb_l=e;this.bb_b=g;this.bb_r=f;this.bb_t=k};C.prototype.transformAxes=function(a,b){for(var c=this.axes,d=this.tAxes,e=0;e<c.length;e++){var f=z(c[e].n,b);d[e].n=f;d[e].d=r(a,f)+c[e].d}};C.prototype.cacheData=function(a,b){this.transformAxes(a,
b);this.transformVerts(a,b)};C.prototype.pointQuery=function(a){if(this.bb_l<=a.x&&this.bb_r>=a.x&&this.bb_b<=a.y&&this.bb_t>=a.y){for(var b=new qa(this),c=this.tAxes,d=0;d<c.length;d++){var e=c[d].n,f=c[d].d-r(e,a);if(0>f)return;f<b.d&&(b.d=f,b.n=e)}return b}};C.prototype.segmentQuery=function(a,b){for(var c=this.tAxes,d=this.tVerts,e=c.length,f=2*e,g=0;g<e;g++){var k=c[g].n,h=r(a,k);if(!(c[g].d>h)){var m=r(b,k),h=(c[g].d-h)/(m-h);if(!(0>h||1<h)){var m=pa(a,b,h),m=-E(k,m),u=-(k.x*d[(2*g+3)%f]-k.y*
d[(2*g+2)%f]);if(-(k.x*d[2*g+1]-k.y*d[2*g])<=m&&m<=u)return new ca(this,h,k)}}}};C.prototype.getNumVerts=function(){return this.verts.length/2};C.prototype.getVert=function(a){return new m(this.verts[2*a],this.verts[2*a+1])};C.prototype.valueOnAxis=function(a,b){for(var c=this.tVerts,d=a.x*c[0]+a.y*c[1],e=2;e<c.length;e+=2)d=t(d,a.x*c[e]+a.y*c[e+1]);return d-b};C.prototype.containsVert=function(a,b){for(var c=this.tAxes,d=0;d<c.length;d++){var e=c[d].n;if(0<e.x*a+e.y*b-c[d].d)return!1}return!0};C.prototype.containsVertPartial=
function(a,b,c){for(var d=this.tAxes,e=0;e<d.length;e++)if(c=d[e].n,!(0>r(c,c))&&0<c.x*a+c.y*b-d[e].d)return!1;return!0};C.prototype.getNumVerts=function(){return this.verts.length/2};C.prototype.getVert=function(a){return new m(this.verts[2*a],this.verts[2*a+1])};var q=h.Body=function(a,b){this.p=new m(0,0);this.vx=this.vy=0;this.f=new m(0,0);this.t=this.w=0;this.w_limit=this.v_limit=Infinity;this.w_bias=this.v_biasx=this.v_biasy=0;this.space=null;this.shapeList=[];this.nodeNext=this.nodeRoot=this.constraintList=
this.arbiterList=null;this.nodeIdleTime=0;this.setMass(a);this.setMoment(b);this.rot=new m(0,0);this.setAngle(0)};h.StaticBody=function(){body=new q(Infinity,Infinity);body.nodeIdleTime=Infinity;return body};if("undefined"!==typeof DEBUG&&DEBUG){var sa=function(a,b){l(a.x==a.x&&a.y==a.y,b)},ta=function(a,b){l(Infinity!==Math.abs(a.x)&&Infinity!==Math.abs(a.y),b)};q.prototype.sanityCheck=function(){l(this.m===this.m&&this.m_inv===this.m_inv,"Body's mass is invalid.");l(this.i===this.i&&this.i_inv===
this.i_inv,"Body's moment is invalid.");var a=this.p;sa(a,"Body's position is invalid.");ta(a,"Body's position is invalid.");a=this.f;sa(a,"Body's force is invalid.");ta(a,"Body's force is invalid.");l(this.vx===this.vx&&Infinity!==Math.abs(this.vx),"Body's velocity is invalid.");l(this.vy===this.vy&&Infinity!==Math.abs(this.vy),"Body's velocity is invalid.");l(this.a===this.a&&Infinity!==Math.abs(this.a),"Body's angle is invalid.");l(this.w===this.w&&Infinity!==Math.abs(this.w),"Body's angular velocity is invalid.");
l(this.t===this.t&&Infinity!==Math.abs(this.t),"Body's torque is invalid.");a=this.rot;sa(a,"Internal error: Body's rotation vector is invalid.");ta(a,"Internal error: Body's rotation vector is invalid.");l(this.v_limit===this.v_limit,"Body's velocity limit is invalid.");l(this.w_limit===this.w_limit,"Body's angular velocity limit is invalid.")}}else q.prototype.sanityCheck=function(){};q.prototype.getPos=function(){return this.p};q.prototype.getVel=function(){return new m(this.vx,this.vy)};q.prototype.getAngVel=
function(){return this.w};q.prototype.isSleeping=function(){return null!==this.nodeRoot};q.prototype.isStatic=function(){return Infinity===this.nodeIdleTime};q.prototype.isRogue=function(){return null===this.space};q.prototype.setMass=function(a){l(0<a,"Mass must be positive and non-zero.");this.activate();this.m=a;this.m_inv=1/a};q.prototype.setMoment=function(a){l(0<a,"Moment of Inertia must be positive and non-zero.");this.activate();this.i=a;this.i_inv=1/a};q.prototype.addShape=function(a){this.shapeList.push(a)};
q.prototype.removeShape=function(a){M(this.shapeList,a)};var ua=function(a,b,c){if(a===c)return a.next(b);a.a===b?a.next_a=ua(a.next_a,b,c):a.next_b=ua(a.next_b,b,c);return a};q.prototype.removeConstraint=function(a){this.constraintList=ua(this.constraintList,this,a)};q.prototype.setPos=function(a){this.activate();this.sanityCheck();this.p=a};q.prototype.setVel=function(a){this.activate();this.vx=a.x;this.vy=a.y};q.prototype.setAngVel=function(a){this.activate();this.w=a};q.prototype.setAngleInternal=
function(a){l(!isNaN(a),"Internal Error: Attempting to set body's angle to NaN");this.a=a;this.rot.x=Math.cos(a);this.rot.y=Math.sin(a)};q.prototype.setAngle=function(a){this.activate();this.sanityCheck();this.setAngleInternal(a)};q.prototype.velocity_func=function(a,b,c){var d=this.vx*b+(a.x+this.f.x*this.m_inv)*c;a=this.vy*b+(a.y+this.f.y*this.m_inv)*c;var e=this.v_limit,f=d*d+a*a,e=f>e*e?e/Math.sqrt(f):1;this.vx=d*e;this.vy=a*e;d=this.w_limit;this.w=F(this.w*b+this.t*this.i_inv*c,-d,d);this.sanityCheck()};
q.prototype.position_func=function(a){this.p.x+=(this.vx+this.v_biasx)*a;this.p.y+=(this.vy+this.v_biasy)*a;this.setAngleInternal(this.a+(this.w+this.w_bias)*a);this.w_bias=this.v_biasx=this.v_biasy=0;this.sanityCheck()};q.prototype.resetForces=function(){this.activate();this.f=new m(0,0);this.t=0};q.prototype.applyForce=function(a,b){this.activate();this.f=s(this.f,a);this.t+=E(b,a)};q.prototype.applyImpulse=function(a,b){this.activate();va(this,a.x,a.y,b)};q.prototype.getVelAtPoint=function(a){return s(new m(this.vx,
this.vy),v(P(a),this.w))};q.prototype.getVelAtWorldPoint=function(a){return this.getVelAtPoint(p(a,this.p))};q.prototype.getVelAtLocalPoint=function(a){return this.getVelAtPoint(z(a,this.rot))};q.prototype.eachShape=function(a){for(var b=0,c=this.shapeList.length;b<c;b++)a(this.shapeList[b])};q.prototype.eachConstraint=function(a){for(var b=this.constraintList;b;){var c=b.next(this);a(b);b=c}};q.prototype.eachArbiter=function(a){for(var b=this.arbiterList;b;){var c=b.next(this);b.swappedColl=this===
b.body_b;a(b);b=c}};q.prototype.local2World=function(a){return s(this.p,z(a,this.rot))};q.prototype.world2Local=function(a){return gb(p(a,this.p),this.rot)};q.prototype.kineticEnergy=function(){var a=this.vx*this.vx+this.vy*this.vy,b=this.w*this.w;return(a?a*this.m:0)+(b?b*this.i:0)};var wa=h.SpatialIndex=function(a){if(this.staticIndex=a)l(!a.dynamicIndex,"This static index is already associated with a dynamic index."),a.dynamicIndex=this};wa.prototype.collideStatic=function(a,b){if(0<a.count){var c=
a.query;this.each(function(a){c(a,new Y(a.bb_l,a.bb_b,a.bb_r,a.bb_t),b)})}};var A=h.BBTree=function(a){wa.call(this,a);this.velocityFunc=null;this.leaves={};this.count=0;this.root=null;this.stamp=0};A.prototype=Object.create(wa.prototype);var mb=0,R=function(a,b,c){this.obj=null;this.bb_l=t(b.bb_l,c.bb_l);this.bb_b=t(b.bb_b,c.bb_b);this.bb_r=w(b.bb_r,c.bb_r);this.bb_t=w(b.bb_t,c.bb_t);this.parent=null;this.setA(b);this.setB(c);mb++},nb=0,U=function(a,b){this.obj=b;a.getBB(b,this);this.parent=null;
this.stamp=1;this.pairs=null;nb++};A.prototype.getBB=function(a,b){var c=this.velocityFunc;if(c){var d=0.1*(a.bb_r-a.bb_l),e=0.1*(a.bb_t-a.bb_b),c=v(c(a),0.1);b.bb_l=a.bb_l+t(-d,c.x);b.bb_b=a.bb_b+t(-e,c.y);b.bb_r=a.bb_r+w(d,c.x);b.bb_t=a.bb_t+w(e,c.y)}else b.bb_l=a.bb_l,b.bb_b=a.bb_b,b.bb_r=a.bb_r,b.bb_t=a.bb_t};A.prototype.getStamp=function(){var a=this.dynamicIndex;return a&&a.stamp?a.stamp:this.stamp};A.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:
this.stamp++};var ob=function(a,b){this.a=a;this.b=b},xa=function(a,b){this.prev=null;this.next=b;this.leaf=a};xa.prototype.unlink=function(){var a=this.next,b=this.prev;a&&(a.a.leaf==this.leaf?a.a.prev=b:a.b.prev=b);b?b.a.leaf==this.leaf?b.a.next=a:b.b.next=a:this.leaf.pairs=a};U.prototype.clearPairs=function(a){a=this.pairs;var b;for(this.pairs=null;a;)a.a.leaf==this?(b=a.a.next,a.b.unlink()):(b=a.b.next,a.a.unlink()),a=b};var La=function(a,b,c){c=a.pairs;var d=b.pairs,e=new ob(new xa(a,c),new xa(b,
d));a.pairs=b.pairs=e;c&&(c.a.leaf==a?c.a.prev=e:c.b.prev=e);d&&(d.a.leaf==b?d.a.prev=e:d.b.prev=e)};R.prototype.setA=function(a){this.A=a;a.parent=this};R.prototype.setB=function(a){this.B=a;a.parent=this};U.prototype.isLeaf=!0;R.prototype.isLeaf=!1;R.prototype.otherChild=function(a){return this.A==a?this.B:this.A};R.prototype.replaceChild=function(a,b,c){G(a==this.A||a==this.B,"Node is not a child of parent.");this.A==a?this.setA(b):this.setB(b);for(a=this;a;a=a.parent)b=a.A,c=a.B,a.bb_l=t(b.bb_l,
c.bb_l),a.bb_b=t(b.bb_b,c.bb_b),a.bb_r=w(b.bb_r,c.bb_r),a.bb_t=w(b.bb_t,c.bb_t)};R.prototype.bbArea=U.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var Ma=function(a,b){return(w(a.bb_r,b.bb_r)-t(a.bb_l,b.bb_l))*(w(a.bb_t,b.bb_t)-t(a.bb_b,b.bb_b))},Na=function(a,b){return Math.abs(a.bb_l+a.bb_r-b.bb_l-b.bb_r)+Math.abs(a.bb_b+b.bb_t-b.bb_b-b.bb_t)},da=function(a,b,c){if(null==a)return b;if(a.isLeaf)return new R(c,b,a);var d=a.B.bbArea()+Ma(a.A,b),e=a.A.bbArea()+Ma(a.B,
b);d===e&&(d=Na(a.A,b),e=Na(a.B,b));e<d?a.setB(da(a.B,b,c)):a.setA(da(a.A,b,c));a.bb_l=t(a.bb_l,b.bb_l);a.bb_b=t(a.bb_b,b.bb_b);a.bb_r=w(a.bb_r,b.bb_r);a.bb_t=w(a.bb_t,b.bb_t);return a};R.prototype.intersectsBB=U.prototype.intersectsBB=function(a){return this.bb_l<=a.r&&a.l<=this.bb_r&&this.bb_b<=a.t&&a.b<=this.bb_t};var oa=function(a,b,c){a.intersectsBB(b)&&(a.isLeaf?c(a.obj):(oa(a.A,b,c),oa(a.B,b,c)))},Oa=function(a,b,c){var d=1/(c.x-b.x),e=a.bb_l==b.x?-Infinity:(a.bb_l-b.x)*d,f=a.bb_r==b.x?Infinity:
(a.bb_r-b.x)*d,d=t(e,f),e=w(e,f),f=1/(c.y-b.y);c=a.bb_b==b.y?-Infinity:(a.bb_b-b.y)*f;b=a.bb_t==b.y?Infinity:(a.bb_t-b.y)*f;a=t(c,b);b=w(c,b);return a<=e&&d<=b&&(d=w(d,a),0<=t(e,b)&&1>=d)?w(d,0):Infinity},ea=function(a,b,c,d,e){if(a.isLeaf)return e(a.obj);var f=Oa(a.A,b,c),g=Oa(a.B,b,c);f<g?(f<d&&(d=t(d,ea(a.A,b,c,d,e))),g<d&&(d=t(d,ea(a.B,b,c,d,e)))):(g<d&&(d=t(d,ea(a.B,b,c,d,e))),f<d&&(d=t(d,ea(a.A,b,c,d,e))));return d},Pa=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a)return b=a.otherChild(b),
b.parent=a.parent,b;d.parent.replaceChild(d,d.otherChild(b),c);return a},$=function(a,b,c,d,e){b.bb_l<=a.bb_r&&(a.bb_l<=b.bb_r&&b.bb_b<=a.bb_t&&a.bb_b<=b.bb_t)&&(a.isLeaf?c?La(b,a,d):(a.stamp<b.stamp&&La(a,b,d),e&&e(b.obj,a.obj)):($(a.A,b,c,d,e),$(a.B,b,c,d,e)))},Qa=function(a,b,c,d){if(a.stamp==b.getStamp()){c&&$(c,a,!1,b,d);for(c=a;c.parent;c=c.parent)c==c.parent.A?$(c.parent.B,a,!0,b,d):$(c.parent.A,a,!1,b,d)}else for(b=a.pairs;b;)a==b.b.leaf?(d&&d(b.a.leaf.obj,a.obj),b=b.b.next):b=b.a.next},ya=
function(a,b,c,d){a.isLeaf?Qa(a,b,c,d):(ya(a.A,b,c,d),ya(a.B,b,c,d))};U.prototype.containsObj=function(a){return this.bb_l<=a.bb_l&&this.bb_r>=a.bb_r&&this.bb_b<=a.bb_b&&this.bb_t>=a.bb_t};U.prototype.update=function(a){var b=a.root;return!this.containsObj(this.obj)?(a.getBB(this.obj,this),b=Pa(b,this,a),a.root=da(b,this,a),this.clearPairs(a),this.stamp=a.getStamp(),!0):!1};U.prototype.addPairs=function(a){var b=a.dynamicIndex;b?(a=b.root)&&$(a,this,!0,b,null):Qa(this,a,a.staticIndex.root,null)};
A.prototype.insert=function(a,b){var c=new U(this,a);this.leaves[b]=c;this.root=da(this.root,c,this);this.count++;c.stamp=this.getStamp();c.addPairs(this);this.incrementStamp()};A.prototype.remove=function(a,b){var c=this.leaves[b];delete this.leaves[b];this.root=Pa(this.root,c,this);this.count--;c.clearPairs(this)};A.prototype.contains=function(a,b){return null!=this.leaves[b]};var pb=function(a,b){};A.prototype.reindexQuery=function(a){if(this.root){var b,c=this.leaves;for(b in c)c[b].update(this);
c=(b=this.staticIndex)&&b.root;ya(this.root,this,c,a);b&&!c&&this.collideStatic(this,b,a);this.incrementStamp()}};A.prototype.reindex=function(){this.reindexQuery(pb)};A.prototype.reindexObject=function(a,b){var c=this.leaves[b];c&&(c.update(this)&&c.addPairs(this),this.incrementStamp())};A.prototype.pointQuery=function(a,b){this.root&&oa(this.root,new Y(a.x,a.y,a.x,a.y),b)};A.prototype.segmentQuery=function(a,b,c,d){this.root&&ea(this.root,a,b,c,d)};A.prototype.query=function(a,b){this.root&&oa(this.root,
a,b)};A.prototype.count=function(){return this.count};A.prototype.each=function(a){for(var b in this.leaves)a(this.leaves[b].obj)};var za=function(a,b,c,d){if(1==d)return b[c];if(2==d)return new R(a,b[c],b[c+1]);for(var e=b[c],f=e.bb_l,g=e.bb_b,k=e.bb_r,h=e.bb_t,m=c+d,u=c+1;u<m;u++)e=b[u],f=t(f,e.bb_l),g=t(g,e.bb_b),k=w(k,e.bb_r),h=w(h,e.bb_t);var e=k-f>h-g,l=Array(2*d);if(e)for(u=c;u<m;u++)l[2*u+0]=b[u].bb_l,l[2*u+1]=b[u].bb_r;else for(u=c;u<m;u++)l[2*u+0]=b[u].bb_b,l[2*u+1]=b[u].bb_t;l.sort(function(a,
b){return a-b});var n=0.5*(l[d-1]+l[d]),u=f,l=g,p=k,q=h;e?p=f=n:q=g=n;for(var n=m,r=c;r<n;)e=b[r],(w(e.bb_r,k)-t(e.bb_l,f))*(w(e.bb_t,h)-t(e.bb_b,g))<(w(e.bb_r,p)-t(e.bb_l,u))*(w(e.bb_t,q)-t(e.bb_b,l))?(n--,b[r]=b[n],b[n]=e):r++;if(n==d){e=null;for(u=c;u<m;u++)e=da(e,b[u],a);return e}return NodeNew(a,za(a,b,c,n-c),za(a,b,n,m-n))};A.prototype.optimize=function(){var a=Array(this.count),b=0,c;for(c in this.leaves)a[b++]=this.nodes[c];this.root=za(tree,a,a.length)};var Aa=function(a,b){!a.isLeaf&&10>=
b&&(Aa(a.a,b+1),Aa(a.b,b+1));for(var c=0;c<b;c++);};A.prototype.log=function(){this.root&&Aa(this.root,0)};var X=h.CollisionHandler=function(){this.a=this.b=0};X.prototype.begin=function(a,b){return!0};X.prototype.preSolve=function(a,b){return!0};X.prototype.postSolve=function(a,b){};X.prototype.separate=function(a,b){};var y=function(a,b){this.u=this.e=0;this.surface_vr=D;this.a=a;this.body_a=a.body;this.b=b;this.body_b=b.body;this.contacts=this.thread_b_next=this.thread_b_prev=this.thread_a_next=
this.thread_a_prev=null;this.stamp=0;this.handler=null;this.swappedColl=!1;this.state="first coll"};y.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]};y.prototype.totalImpulse=function(){for(var a=this.contacts,b=new m(0,0),c=0,d=a.length;c<d;c++){var e=a[c];b.add(v(e.n,e.jnAcc))}return this.swappedColl?b:b.neg()};y.prototype.totalImpulseWithFriction=function(){for(var a=this.contacts,b=new m(0,0),c=0,d=a.length;c<d;c++){var e=a[c];b.add((new m(e.jnAcc,e.jtAcc)).rotate(e.n))}return this.swappedColl?
b:b.neg()};y.prototype.totalKE=function(){for(var a=(1-this.e)/(1+this.e),b=0,c=this.contacts,d=0,e=c.length;d<e;d++)var f=c[d],g=f.jnAcc,k=f.jtAcc,b=b+(a*g*g/f.nMass+k*k/f.tMass);return b};y.prototype.ignore=function(){this.state="ignore"};y.prototype.getA=function(){return this.swappedColl?this.b:this.a};y.prototype.getB=function(){return this.swappedColl?this.a:this.b};y.prototype.isFirstContact=function(){return"first coll"===this.state};var Ra=function(a,b,c){this.point=a;this.normal=b;this.dist=
c};y.prototype.getContactPointSet=function(){var a=Array(this.contacts.length),b;for(b=0;b<a.length;b++)a[b]=new Ra(this.contacts[b].p,this.contacts[b].n,this.contacts[b].dist);return a};y.prototype.getNormal=function(a){a=this.contacts[a].n;return this.swappedColl?O(a):a};y.prototype.getPoint=function(a){return this.contacts[a].p};y.prototype.getDepth=function(a){return this.contacts[a].dist};var Sa=function(a,b,c,d){c?c.body_a===b?c.thread_a_next=d:c.thread_b_next=d:b.arbiterList=d;d&&(d.body_a===
b?d.thread_a_prev=c:d.thread_b_prev=c)};y.prototype.unthread=function(){Sa(this,this.body_a,this.thread_a_prev,this.thread_a_next);Sa(this,this.body_b,this.thread_b_prev,this.thread_b_next);this.thread_b_prev=this.thread_b_next=this.thread_a_prev=this.thread_a_next=null};y.prototype.update=function(a,b,c,d){if(this.contacts)for(var e=0;e<this.contacts.length;e++)for(var f=this.contacts[e],g=0;g<a.length;g++){var k=a[g];k.hash===f.hash&&(k.jnAcc=f.jnAcc,k.jtAcc=f.jtAcc)}this.contacts=a;this.handler=
b;this.swappedColl=c.collision_type!==b.a;this.e=c.e*d.e;this.u=c.u*d.u;this.surface_vr=p(c.surface_v,d.surface_v);this.a=c;this.body_a=c.body;this.b=d;this.body_b=d.body;"cached"==this.state&&(this.state="first coll")};y.prototype.preStep=function(a,b,c){for(var d=this.body_a,e=this.body_b,f=0;f<this.contacts.length;f++){var g=this.contacts[f];g.r1=p(g.p,d.p);g.r2=p(g.p,e.p);g.nMass=1/fa(d,e,g.r1,g.r2,g.n);g.tMass=1/fa(d,e,g.r1,g.r2,P(g.n));g.bias=-c*t(0,g.dist+b)/a;g.jBias=0;g.bounce=Ba(d,e,g.r1,
g.r2,g.n)*this.e}};y.prototype.applyCachedImpulse=function(a){if(!this.isFirstContact())for(var b=this.body_a,c=this.body_b,d=0;d<this.contacts.length;d++){var e=this.contacts[d],f=e.n.x,g=e.n.y;J(b,c,e.r1,e.r2,(f*e.jnAcc-g*e.jtAcc)*a,(f*e.jtAcc+g*e.jnAcc)*a)}};var qb=0,rb=0;y.prototype.applyImpulse=function(){qb++;for(var a=this.body_a,b=this.body_b,c=this.surface_vr,d=this.u,e=0;e<this.contacts.length;e++){rb++;var f=this.contacts[e],g=f.nMass,k=f.n,h=f.r1,m=f.r2,l=b.vx-m.y*b.w-(a.vx-h.y*a.w),n=
b.vy+m.x*b.w-(a.vy+h.x*a.w),p=l*k.x+n*k.y,q=(l+c.x)*-k.y+(n+c.y)*k.x,n=f.jBias;f.jBias=w(n+(f.bias-(k.x*(b.v_biasx-m.y*b.w_bias-a.v_biasx+h.y*a.w_bias)+k.y*(m.x*b.w_bias+b.v_biasy-h.x*a.w_bias-a.v_biasy)))*g,0);l=f.jnAcc;f.jnAcc=w(l+-(f.bounce+p)*g,0);p=d*f.jnAcc;g=f.jtAcc;f.jtAcc=F(g+-q*f.tMass,-p,p);p=k.x*(f.jBias-n);n=k.y*(f.jBias-n);Ta(a,-p,-n,h);Ta(b,p,n,m);l=f.jnAcc-l;f=f.jtAcc-g;J(a,b,h,m,k.x*l-k.y*f,k.x*f+k.y*l)}};y.prototype.callSeparate=function(a){a.lookupHandler(this.a.collision_type,
this.b.collision_type).separate(this,a)};y.prototype.next=function(a){return this.body_a==a?this.thread_a_next:this.thread_b_next};var sb=0,S=function(a,b,c,d){this.p=a;this.n=b;this.dist=c;this.r1=this.r2=D;this.jnAcc=this.jtAcc=this.jBias=this.nMass=this.tMass=this.bounce=this.bias=0;this.hash=d;sb++},K=[],V=function(a,b,c,d){d=c+d;b=p(b,a);var e=I(b);if(!(e>=d*d))return e=Math.sqrt(e),new S(s(a,v(b,0.5+(c-0.5*d)/(e?e:Infinity))),e?v(b,1/e):new m(1,0),e-d,0)},Ca=0,Ua=function(a,b){var c=0,d=a.valueOnAxis(b[0].n,
b[0].d);if(0<d)return-1;for(var e=1;e<b.length;e++){var f=a.valueOnAxis(b[e].n,b[e].d);if(0<f)return-1;f>d&&(d=f,c=e)}Ca=d;return c},Va=function(a,b,c,d){for(var e=[],f=a.tVerts,g=0;g<f.length;g+=2){var k=f[g],h=f[g+1];b.containsVert(k,h)&&e.push(new S(new m(k,h),c,d,H(a.hashid,g>>1)))}f=b.tVerts;for(g=0;g<f.length;g+=2)k=f[g],h=f[g+1],a.containsVert(k,h)&&e.push(new S(new m(k,h),c,d,H(b.hashid,g>>1)));if(!e.length){e=[];f=a.tVerts;for(g=0;g<f.length;g+=2)k=f[g],h=f[g+1],b.containsVertPartial(k,h,
O(c))&&e.push(new S(new m(k,h),c,d,H(a.hashid,g)));f=b.tVerts;for(g=0;g<f.length;g+=2)k=f[g],h=f[g+1],a.containsVertPartial(k,h,c)&&e.push(new S(new m(k,h),c,d,H(b.hashid,g)))}return a=e},Wa=function(a,b,c){var d=r(b,a.ta)-a.r;a=r(b,a.tb)-a.r;return t(d,a)-c},Xa=function(a,b,c,d,e){for(var f=E(b.tn,b.ta),g=E(b.tn,b.tb),k=v(b.tn,e),h=c.tVerts,l=0;l<h.length;l+=2){var n=h[l],p=h[l+1];if(n*k.x+p*k.y<r(b.tn,b.ta)*e+b.r){var q=b.tn.x*p-b.tn.y*n;f>=q&&q>=g&&a.push(new S(new m(n,p),k,d,H(c.hashid,l)))}}};
Z.prototype.collisionCode=0;T.prototype.collisionCode=1;C.prototype.collisionCode=2;Z.prototype.collisionTable=[function(a,b){var c=V(a.tc,b.tc,a.r,b.r);return c?[c]:K},function(a,b){var c=b.ta,d=a.tc,e=p(b.tb,c),f=Ha(r(e,p(d,c))/I(e)),c=s(c,v(e,f));return(d=V(d,c,a.r,b.r))?(c=d.n,0===f&&0>r(c,b.a_tangent)||1===f&&0>r(c,b.b_tangent)?K:[d]):K},function(a,b){for(var c=b.tAxes,d=0,e=r(c[0].n,a.tc)-c[0].d-a.r,f=0;f<c.length;f++){var g=r(c[f].n,a.tc)-c[f].d-a.r;if(0<g)return K;g>e&&(e=g,d=f)}var c=c[d].n,
k=b.tVerts,h=k.length,l=d<<1,d=k[l],f=k[l+1],g=k[(l+2)%h],k=k[(l+3)%h],h=c.x*f-c.y*d,l=c.x*k-c.y*g,n=E(c,a.tc);if(n<l){var q=V(a.tc,new m(g,k),a.r,0,q);return q?[q]:K}return n<h?[new S(p(a.tc,v(c,a.r+e/2)),O(c),e,0)]:(q=V(a.tc,new m(d,f),a.r,0,q))?[q]:K}];T.prototype.collisionTable=[null,function(a,b){return K},function(a,b){var c=[],d=b.tAxes,e=d.length,f=r(a.tn,a.ta),g=b.valueOnAxis(a.tn,f)-a.r,f=b.valueOnAxis(O(a.tn),-f)-a.r;if(0<f||0<g)return K;var k=0,h=Wa(a,d[0].n,d[0].d);if(0<h)return K;for(var l=
0;l<e;l++){var n=Wa(a,d[l].n,d[l].d);if(0<n)return K;n>h&&(h=n,k=l)}d=O(d[k].n);l=s(a.ta,v(d,a.r));n=s(a.tb,v(d,a.r));b.containsVert(l.x,l.y)&&c.push(new S(l,d,h,H(a.hashid,0)));b.containsVert(n.x,n.y)&&c.push(new S(n,d,h,H(a.hashid,1)));if(g>=h||f>=h)g>f?Xa(c,a,b,g,1):Xa(c,a,b,f,-1);if(0===c.length){g=2*k;f=b.tVerts;h=new m(f[g],f[g+1]);if((k=V(a.ta,h,a.r,0,c))||(k=V(a.tb,h,a.r,0,c)))return[k];e*=2;e=new m(f[(g+2)%e],f[(g+3)%e]);if((k=V(a.ta,e,a.r,0,c))||(k=V(a.tb,e,a.r,0,c)))return[k]}return c}];
C.prototype.collisionTable=[null,null,function(a,b){var c=Ua(b,a.tAxes);if(-1==c)return K;var d=Ca,e=Ua(a,b.tAxes);if(-1==e)return K;var f=Ca;return d>f?Va(a,b,a.tAxes[c].n,d):Va(a,b,O(b.tAxes[e].n),f)}];var tb=h.collideShapes=function(a,b){l(a.collisionCode<=b.collisionCode,"Collided shapes must be sorted by type");return a.collisionTable[b.collisionCode](a,b)},Ya=new X,n=h.Space=function(){this.curr_dt=this.stamp=0;this.bodies=[];this.rousedBodies=[];this.sleepingComponents=[];this.staticShapes=
new A(null);this.activeShapes=new A(this.staticShapes);this.arbiters=[];this.contactBuffersHead=null;this.cachedArbiters={};this.constraints=[];this.locked=0;this.collisionHandlers={};this.defaultHandler=Ya;this.postStepCallbacks=[];this.iterations=10;this.gravity=D;this.damping=1;this.idleSpeedThreshold=0;this.sleepTimeThreshold=Infinity;this.collisionSlop=0.1;this.collisionBias=Math.pow(0.9,60);this.collisionPersistence=3;this.enableContactGraph=!1;this.staticBody=new q(Infinity,Infinity);this.staticBody.nodeIdleTime=
Infinity;this.collideShapes=this.makeCollideShapes()};n.prototype.getCurrentTimeStep=function(){return this.curr_dt};n.prototype.isLocked=function(){return this.locked};var L=function(a){l(!a.locked,"This addition/removal cannot be done safely during a call to cpSpaceStep()  or during a query. Put these calls into a post-step callback.")};n.prototype.addCollisionHandler=function(a,b,c,d,e,f){L(this);this.removeCollisionHandler(a,b);var g=new X;g.a=a;g.b=b;c&&(g.begin=c);d&&(g.preSolve=d);e&&(g.postSolve=
e);f&&(g.separate=f);this.collisionHandlers[H(a,b)]=g};n.prototype.removeCollisionHandler=function(a,b){L(this);delete this.collisionHandlers[H(a,b)]};n.prototype.setDefaultCollisionHandler=function(a,b,c,d){L(this);var e=new X;a&&(e.begin=a);b&&(e.preSolve=b);c&&(e.postSolve=c);d&&(e.separate=d);this.defaultHandler=e};n.prototype.lookupHandler=function(a,b){return this.collisionHandlers[H(a,b)]||this.defaultHandler};n.prototype.addShape=function(a){var b=a.body;if(b.isStatic())return this.addStaticShape(a);
l(!a.space,"This shape is already added to a space and cannot be added to another.");L(this);b.activate();b.addShape(a);a.update(b.p,b.rot);this.activeShapes.insert(a,a.hashid);a.space=this;return a};n.prototype.addStaticShape=function(a){l(!a.space,"This shape is already added to a space and cannot be added to another.");L(this);var b=a.body;b.addShape(a);a.update(b.p,b.rot);this.staticShapes.insert(a,a.hashid);a.space=this;return a};n.prototype.addBody=function(a){l(!a.isStatic(),"Static bodies cannot be added to a space as they are not meant to be simulated.");
l(!a.space,"This body is already added to a space and cannot be added to another.");L(this);this.bodies.push(a);a.space=this;return a};n.prototype.addConstraint=function(a){l(!a.space,"This shape is already added to a space and cannot be added to another.");L(this);var b=a.a,c=a.b;b.activate();c.activate();this.constraints.push(a);a.next_a=b.constraintList;b.constraintList=a;a.next_b=c.constraintList;c.constraintList=a;a.space=this;return a};n.prototype.filterArbiters=function(a,b){for(var c in this.cachedArbiters){var d=
this.cachedArbiters[c];if(a===d.body_a&&(b===d.a||null===b)||a===d.body_b&&(b===d.b||null===b))b&&"cached"!==d.state&&d.callSeparate(this),d.unthread(),M(this.arbiters,d),delete this.cachedArbiters[c]}};n.prototype.removeShape=function(a){var b=a.body;b.isStatic()?this.removeStaticShape(a):(l(this.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),L(this),b.activate(),b.removeShape(a),this.filterArbiters(b,a),this.activeShapes.remove(a,a.hashid),a.space=
null)};n.prototype.removeStaticShape=function(a){l(this.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)");L(this);var b=a.body;b.isStatic()&&b.activateStatic(a);b.removeShape(a);this.filterArbiters(b,a);this.staticShapes.remove(a,a.hashid);a.space=null};n.prototype.removeBody=function(a){l(this.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)");L(this);a.activate();M(this.bodies,a);a.space=
null};n.prototype.removeConstraint=function(a){l(this.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)");L(this);a.a.activate();a.b.activate();M(this.constraints,a);a.a.removeConstraint(a);a.b.removeConstraint(a);a.space=null};n.prototype.containsShape=function(a){return a.space===this};n.prototype.containsBody=function(a){return a.space==this};n.prototype.containsConstraint=function(a){return a.space==this};n.prototype.uncacheArbiter=function(a){delete this.cachedArbiters[H(a.a.hashid,
a.b.hashid)];M(this.arbiters,a)};n.prototype.eachBody=function(a){this.lock();for(var b=this.bodies,c=0;c<b.length;c++)a(b[c]);b=this.sleepingComponents;for(c=0;c<b.length;c++)for(var d=b[c];d;){var e=d.nodeNext;a(d);d=e}this.unlock(!0)};n.prototype.eachShape=function(a){this.lock();this.activeShapes.each(a);this.staticShapes.each(a);this.unlock(!0)};n.prototype.eachConstraint=function(a){this.lock();for(var b=this.constraints,c=0;c<b.length;c++)a(b[c]);this.unlock(!0)};n.prototype.reindexStatic=
function(){l(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");this.staticShapes.each(function(a){var b=a.body;a.update(b.p,b.rot)});this.staticShapes.reindex()};n.prototype.reindexShape=function(a){l(!this.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var b=a.body;a.update(b.p,b.rot);this.activeShapes.reindexObject(a,a.hashid);this.staticShapes.reindexObject(a,
a.hashid)};n.prototype.reindexShapesForBody=function(a){for(a=a.shapeList;a;a=a.next)this.reindexShape(a)};n.prototype.useSpatialHash=function(a,b){throw Error("Spatial Hash not yet implemented!");};n.prototype.activateBody=function(a){l(!a.isRogue(),"Internal error: Attempting to activate a rogue body.");if(this.locked)-1===this.rousedBodies.indexOf(a)&&this.rousedBodies.push(a);else{this.bodies.push(a);for(var b=0;b<a.shapeList.length;b++){var c=a.shapeList[b];this.staticShapes.remove(c,c.hashid);
this.activeShapes.insert(c,c.hashid)}for(b=a.arbiterList;b;b=b.next(a))if(c=b.body_a,a===c||c.isStatic()){var c=b.a,d=b.b;this.cachedArbiters[H(c.hashid,d.hashid)]=b;b.stamp=this.stamp;b.handler=this.lookupHandler(c.collision_type,d.collision_type);this.arbiters.push(b)}for(b=a.constraintList;b;b=b.nodeNext)c=b.a,(a===c||c.isStatic())&&this.constraints.push(b)}};n.prototype.deactivateBody=function(a){l(!a.isRogue(),"Internal error: Attempting to deactivate a rogue body.");M(this.bodies,a);for(var b=
0;b<a.shapeList.length;b++){var c=a.shapeList[b];this.activeShapes.remove(c,c.hashid);this.staticShapes.insert(c,c.hashid)}for(c=a.arbiterList;c;c=c.next(a))b=c.body_a,(a===b||b.isStatic())&&this.uncacheArbiter(c);for(c=a.constraintList;c;c=c.nodeNext)b=c.a,(a===b||b.isStatic())&&M(this.constraints,c)};q.prototype.activate=function(){if(!this.isRogue()){this.nodeIdleTime=0;var a=this?this.nodeRoot:null;if(a&&a.isSleeping(a)){l(!a.isRogue(),"Internal Error: componentActivate() called on a rogue body.");
for(var b=a.space,c=a;c;){var d=c.nodeNext;c.nodeIdleTime=0;c.nodeRoot=null;c.nodeNext=null;b.activateBody(c);c=d}M(b.sleepingComponents,a)}}};q.prototype.activateStatic=function(a){l(this.isStatic(),"Body.activateStatic() called on a non-static body.");for(var b=this.arbiterList;b;b=b.next(this))if(!a||a==b.a||a==b.b)(b.body_a==this?b.body_b:b.body_a).activate()};q.prototype.pushArbiter=function(a){G(null===(a.body_a===this?a.thread_a_next:a.thread_b_next),"Internal Error: Dangling contact graph pointers detected. (A)");
G(null===(a.body_a===this?a.thread_a_prev:a.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (B)");var b=this.arbiterList;G(null===b||null===(b.body_a===this?b.thread_a_prev:b.thread_b_prev),"Internal Error: Dangling contact graph pointers detected. (C)");a.body_a===this?a.thread_a_next=b:a.thread_b_next=b;b&&(b.body_a===this?b.thread_a_prev=a:b.thread_b_prev=a);this.arbiterList=a};var Da=function(a,b){if(!b.isRogue()){var c=b?b.nodeRoot:null;if(null==c){b.nodeRoot=a;b!==
a&&(b.nodeNext=a.nodeNext,a.nodeNext=b);for(c=b.arbiterList;c;c=c.next(b))Da(a,b==c.body_a?c.body_b:c.body_a);for(c=b.constraintList;c;c=c.next(b))Da(a,b==c.a?c.b:c.a)}else G(c===a,"Internal Error: Inconsistency detected in the contact graph.")}};n.prototype.processComponents=function(a){for(var b=Infinity!==this.sleepTimeThreshold,c=this.bodies,d=0;d<c.length;d++){var e=c[d];G(null===e.nodeNext,"Internal Error: Dangling next pointer detected in contact graph.");G(null===e.nodeRoot,"Internal Error: Dangling root pointer detected in contact graph.")}if(b)for(var f=
(d=this.idleSpeedThreshold)?d*d:I(this.gravity)*a*a,d=0;d<c.length;d++){var e=c[d],g=f?e.m*f:0;e.nodeIdleTime=e.kineticEnergy()>g?0:e.nodeIdleTime+a}f=this.arbiters;d=0;for(g=f.length;d<g;d++){var k=f[d],e=k.body_a;a=k.body_b;b&&((a.isRogue()&&!a.isStatic()||e.isSleeping())&&e.activate(),(e.isRogue()&&!e.isStatic()||a.isSleeping())&&a.activate());e.pushArbiter(k);a.pushArbiter(k)}if(b){b=this.constraints;for(d=0;d<b.length;d++)a=b[d],e=a.a,a=a.b,a.isRogue()&&!a.isStatic()&&e.activate(),e.isRogue()&&
!e.isStatic()&&a.activate();for(d=0;d<c.length;){e=c[d];if(null===(e?e.nodeRoot:null)){Da(e,e);a:{for(b=e;b;b=b.nodeNext)if(b.nodeIdleTime<this.sleepTimeThreshold){b=!0;break a}b=!1}if(!b){this.sleepingComponents.push(e);for(b=e;b;b=b.nodeNext)this.deactivateBody(b);continue}}d++;e.nodeRoot=null;e.nodeNext=null}}};q.prototype.sleep=function(){this.sleepWithGroup(null)};q.prototype.sleepWithGroup=function(a){l(!this.isStatic()&&!this.isRogue(),"Rogue and static bodies cannot be put to sleep.");var b=
this.space;l(b,"Cannot put a rogue body to sleep.");l(!b.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback.");l(null===a||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier.");if(this.isSleeping())l((this?this.nodeRoot:null)===(a?a.nodeRoot:null),"The body is already sleeping and it's group cannot be reassigned.");else{for(var c=0;c<body.shapeList.length;c++)body.shapeList.update(this.p,this.rot);b.deactivateBody(this);
a?(this.nodeRoot=a=a?a.nodeRoot:null,this.nodeNext=a.nodeNext,this.nodeIdleTime=0,a.nodeNext=this):(this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,b.sleepingComponents.push(this));M(b.bodies,this)}};n.prototype.activateShapesTouchingShape=function(a){Infinity!==this.sleepTimeThreshold&&this.shapeQuery(a,function(a,c){a.body.activate()})};n.prototype.pointQuery=function(a,b,c,d){var e=function(e){!(e.group&&c===e.group)&&(b&e.layers&&e.pointQuery(a))&&d(e)};this.lock();this.activeShapes.pointQuery(a,
e);this.staticShapes.pointQuery(a,e);this.unlock(!0)};n.prototype.pointQueryFirst=function(a,b,c){var d=null;this.pointQuery(a,b,c,function(a){a.sensor||(d=a)});return d};n.prototype.segmentQuery=function(a,b,c,d,e){var f=function(f){var k;!(f.group&&d===f.group)&&(c&f.layers&&(k=f.segmentQuery(a,b)))&&e(f,k.t,k.n);return 1};this.lock();this.staticShapes.segmentQuery(a,b,1,f);this.activeShapes.segmentQuery(a,b,1,f);this.unlock(!0)};n.prototype.segmentQueryFirst=function(a,b,c,d){var e=null,f=function(f){var k;
if(!(f.group&&d===f.group)&&c&f.layers&&!f.sensor&&(k=f.segmentQuery(a,b))&&(null===e||k.t<e.t))e=k;return e?e.t:1};this.staticShapes.segmentQuery(a,b,1,f);this.activeShapes.segmentQuery(a,b,e?e.t:1,f);return e};n.prototype.bbQuery=function(a,b,c,d){var e=function(e){!(e.group&&c===e.group)&&(b&e.layers&&a.l<=e.bb_r&&e.bb_l<=a.r&&a.b<=e.bb_t&&e.bb_b<=a.t)&&d(e)};this.lock();this.activeShapes.query(a,e);this.staticShapes.query(a,e);this.unlock(!0)};n.prototype.shapeQuery=function(a,b){var c=a.body;
c&&a.update(c.p,c.rot);var c=new Y(a.bb_l,a.bb_b,a.bb_r,a.bb_t),d=!1,e=function(c){if(!(a.group&&a.group===c.group||!(a.layers&c.layers)||a===c)){var e;if(a.collisionCode<=c.collisionCode)e=cpCollideShapes(a,c);else{e=cpCollideShapes(c,a);for(var k=0;k<e.length;k++)e[k].n=O(e[k].n)}if(e.length&&(d=!(a.sensor||c.sensor),b)){for(var h=Array(e.length),k=0;k<e.length;k++)h[k]=new Ra(e[k].p,e[k].n,e[k].dist);b(c,h)}}};this.lock();this.activeShapes.query(c,e);this.staticShapes.query(c,e);this.unlock(!0);
return d};n.prototype.addPostStepCallback=function(a){G(this.locked,"Adding a post-step callback when the space is not locked is unnecessary. Post-step callbacks will not called until the end of the next call to cpSpaceStep() or the next query.");this.postStepCallbacks.push(a)};n.prototype.runPostStepCallbacks=function(){for(var a=0;a<this.postStepCallbacks.length;a++)this.postStepCallbacks[a]();this.postStepCallbacks=[]};n.prototype.lock=function(){this.locked++};n.prototype.unlock=function(a){this.locked--;
l(0<=this.locked,"Internal Error: Space lock underflow.");if(!this.locked&&a){a=this.rousedBodies;for(var b=0;b<a.length;b++)this.activateBody(a[b]);a.length=0;this.runPostStepCallbacks()}};n.prototype.makeCollideShapes=function(){var a=this;return function(b,c){if(b.bb_l<=c.bb_r&&(c.bb_l<=b.bb_r&&b.bb_b<=c.bb_t&&c.bb_b<=b.bb_t)&&!(b.body===c.body||b.group&&b.group===c.group||!(b.layers&c.layers))){var d=a.lookupHandler(b.collision_type,c.collision_type),e=b.sensor||c.sensor;if(!(e&&d===Ya)){if(b.collisionCode>
c.collisionCode){var f=b;b=c;c=f}f=tb(b,c);if(0!==f.length){var g=H(b.hashid,c.hashid),h=a.cachedArbiters[g];h||(h=a.cachedArbiters[g]=new y(b,c));h.update(f,d,b,c);"first coll"==h.state&&!d.begin(h,a)&&h.ignore();"ignore"!==h.state&&d.preSolve(h,a)&&!e?a.arbiters.push(h):(h.contacts=null,"ignore"!==h.state&&(h.state="normal"));h.stamp=a.stamp}}}}};n.prototype.arbiterSetFilter=function(a){var b=this.stamp-a.stamp,c=a.body_a,d=a.body_b;if((c.isStatic()||c.isSleeping())&&(d.isStatic()||d.isSleeping()))return!0;
1<=b&&"cached"!=a.state&&(a.callSeparate(this),a.state="cached");return b>=this.collisionPersistence?(a.contacts=null,!1):!0};var ub=function(a){var b=a.body;a.update(b.p,b.rot)};n.prototype.step=function(a){if(0!==a){l(0===D.x&&0===D.y,"vzero is invalid");this.stamp++;var b=this.curr_dt;this.curr_dt=a;for(var c=this.bodies,d=this.constraints,e=this.arbiters,f=0;f<e.length;f++){var g=e[f];g.state="normal";!g.body_a.isSleeping()&&!g.body_b.isSleeping()&&g.unthread()}e.length=0;this.lock();for(f=0;f<
c.length;f++)g=c[f],g.position_func(a);this.activeShapes.each(ub);this.activeShapes.reindexQuery(this.collideShapes);this.unlock(!1);this.processComponents(a);this.lock();for(var h in this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[h])||delete this.cachedArbiters[h];g=this.collisionSlop;h=1-Math.pow(this.collisionBias,a);for(f=0;f<e.length;f++)e[f].preStep(a,g,h);for(f=0;f<d.length;f++)g=d[f],g.preSolve(this),g.preStep(a);h=Math.pow(this.damping,a);for(var m=this.gravity,f=0;f<c.length;f++)g=
c[f],g.velocity_func(m,h,a);a=0===b?0:a/b;for(f=0;f<e.length;f++)e[f].applyCachedImpulse(a);for(f=0;f<d.length;f++)g=d[f],g.applyCachedImpulse(a);for(f=0;f<this.iterations;f++){for(a=0;a<e.length;a++)e[a].applyImpulse();for(a=0;a<d.length;a++)d[a].applyImpulse()}for(f=0;f<d.length;f++)d[f].postSolve(this);for(f=0;f<e.length;f++)g=e[f],g.handler.postSolve(g,this);this.unlock(!0)}};var Ea=function(a,b,c,d){return new m(b.vx+-d.y*b.w-(a.vx+-c.y*a.w),b.vy+d.x*b.w-(a.vy+c.x*a.w))},Ba=function(a,b,c,d,
e){return(b.vx+-d.y*b.w-(a.vx+-c.y*a.w))*e.x+(b.vy+d.x*b.w-(a.vy+c.x*a.w))*e.y},va=function(a,b,c,d){a.vx+=b*a.m_inv;a.vy+=c*a.m_inv;a.w+=a.i_inv*(d.x*c-d.y*b)},J=function(a,b,c,d,e,f){va(a,-e,-f,c);va(b,e,f,d)},Ta=function(a,b,c,d){a.v_biasx+=b*a.m_inv;a.v_biasy+=c*a.m_inv;a.w_bias+=a.i_inv*(d.x*c-d.y*b)},Za=function(a,b,c){b=E(b,c);return a.m_inv+a.i_inv*b*b},fa=function(a,b,c,d,e){a=Za(a,c,e)+Za(b,d,e);G(0!==a,"Unsolvable collision or constraint.");return a},$a=function(a,b,c,d,e,f){var g;g=a.m_inv+
b.m_inv;var h=a.i_inv,l=c.x*c.x*h;a=-c.x*c.y*h;c=g+c.y*c.y*h;g+=l;h=b.i_inv;b=d.x*d.x*h;l=-d.x*d.y*h;c+=d.y*d.y*h;d=0+a+l;a=0+a+l;g+=b;b=c*g-d*a;G(0!==b,"Unsolvable constraint.");b=1/b;e.x=g*b;e.y=-d*b;f.x=-a*b;f.y=c*b},x=h.Constraint=function(a,b){this.a=a;this.b=b;this.next_b=this.next_a=this.space=null;this.maxForce=Infinity;this.errorBias=Math.pow(0.9,60);this.maxBias=Infinity};x.prototype.activateBodies=function(){this.a&&this.a.activate();this.b&&this.b.activate()};x.prototype.preStep=function(a){};
x.prototype.applyCachedImpulse=function(a){};x.prototype.applyImpulse=function(){};x.prototype.getImpulse=function(){return 0};x.prototype.preSolve=function(a){};x.prototype.postSolve=function(a){};x.prototype.next=function(a){return this.a===a?this.next_a:this.next_b};var ga=h.PinJoint=function(a,b,c,d){x.call(this,a,b);this.anchr1=c;this.anchr2=d;a=a?s(a.p,z(c,a.rot)):c;b=b?s(b.p,z(d,b.rot)):d;this.dist=N(p(b,a));G(0<this.dist,"You created a 0 length pin joint. A pivot joint will be much more stable.");
this.n=this.r1=this.r2=null;this.bias=this.jnAcc=this.jnMax=this.nMass=0};ga.prototype=Object.create(x.prototype);ga.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=z(this.anchr1,b.rot);this.r2=z(this.anchr2,c.rot);var d=p(s(c.p,this.r2),s(b.p,this.r1)),e=N(d);this.n=v(d,1/(e?e:Infinity));this.nMass=1/fa(b,c,this.r1,this.r2,this.n);b=this.maxBias;this.bias=F(-(1-Math.pow(this.errorBias,a))*(e-this.dist)/a,-b,b);this.jnMax=this.maxForce*a};ga.prototype.applyCachedImpulse=function(a){a=
v(this.n,this.jnAcc*a);J(this.a,this.b,this.r1,this.r2,a.x,a.y)};ga.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=this.n,d=Ba(a,b,this.r1,this.r2,c),d=(this.bias-d)*this.nMass,e=this.jnAcc;this.jnAcc=F(e+d,-this.jnMax,this.jnMax);d=this.jnAcc-e;J(a,b,this.r1,this.r2,c.x*d,c.y*d)};ga.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var ha=h.SlideJoint=function(a,b,c,d,e,f){x.call(this,a,b);this.anchr1=c;this.anchr2=d;this.min=e;this.max=f;this.r1=this.r2=this.n=null;this.bias=
this.jnAcc=this.jnMax=this.nMass=0};ha.prototype=Object.create(x.prototype);ha.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=z(this.anchr1,b.rot);this.r2=z(this.anchr2,c.rot);var d=p(s(c.p,this.r2),s(b.p,this.r1)),e=N(d),f=0;e>this.max?(f=e-this.max,this.n=Ia(d)):e<this.min?(f=this.min-e,this.n=O(Ia(d))):(this.n=D,this.jnAcc=0);this.nMass=1/fa(b,c,this.r1,this.r2,this.n);b=this.maxBias;this.bias=F(-(1-Math.pow(this.errorBias,a))*f/a,-b,b);this.jnMax=this.maxForce*a};ha.prototype.applyCachedImpulse=
function(a){a*=this.jnAcc;J(this.a,this.b,this.r1,this.r2,this.n.x*a,this.n.y*a)};ha.prototype.applyImpulse=function(){if(!(0===this.n.x&&0===this.n.y)){var a=this.a,b=this.b,c=this.n,d=Ea(a,b,this.r1,this.r2),d=r(d,c),d=(this.bias-d)*this.nMass,e=this.jnAcc;this.jnAcc=F(e+d,-this.jnMax,0);d=this.jnAcc-e;J(a,b,this.r1,this.r2,c.x*d,c.y*d)}};ha.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var ia=h.PivotJoint=function(a,b,c,d){x.call(this,a,b);"undefined"===typeof d&&(d=c,c=a?a.world2Local(d):
d,d=b?b.world2Local(d):d);this.anchr1=c;this.anchr2=d;this.r1=this.r2=D;this.k1=new m(0,0);this.k2=new m(0,0);this.jAcc=D;this.jMaxLen=0;this.bias=D};ia.prototype=Object.create(x.prototype);ia.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=z(this.anchr1,b.rot);this.r2=z(this.anchr2,c.rot);$a(b,c,this.r1,this.r2,this.k1,this.k2);this.jMaxLen=this.maxForce*a;b=p(s(c.p,this.r2),s(b.p,this.r1));this.bias=ba(v(b,-(1-Math.pow(this.errorBias,a))/a),this.maxBias)};ia.prototype.applyCachedImpulse=
function(a){J(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)};ia.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=Ea(a,b,this.r1,this.r2),c=p(this.bias,c),d=this.k2,c=new m(r(c,this.k1),r(c,d)),d=this.jAcc;this.jAcc=ba(s(this.jAcc,c),this.jMaxLen);J(a,b,this.r1,this.r2,this.jAcc.x-d.x,this.jAcc.y-d.y)};ia.prototype.getImpulse=function(){return N(this.jAcc)};var W=h.GrooveJoint=function(a,b,c,d,e){x.call(this,a,b);this.grv_a=c;this.grv_b=d;this.grv_n=P(Q(p(d,c)));this.anchr2=e;
this.grv_tn=null;this.clamp=0;this.r1=this.r2=null;this.k1=new m(0,0);this.k2=new m(0,0);this.jAcc=D;this.jMaxLen=0;this.bias=null};W.prototype=Object.create(x.prototype);W.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.local2World(this.grv_a),e=b.local2World(this.grv_b),f=z(this.grv_n,b.rot),g=r(d,f);this.grv_tn=f;this.r2=z(this.anchr2,c.rot);var h=E(s(c.p,this.r2),f);h<=E(d,f)?(this.clamp=1,this.r1=p(d,b.p)):h>=E(e,f)?(this.clamp=-1,this.r1=p(e,b.p)):(this.clamp=0,this.r1=p(s(v(P(f),-h),
v(f,g)),b.p));$a(b,c,this.r1,this.r2,this.k1,this.k2);this.jMaxLen=this.maxForce*a;b=p(s(c.p,this.r2),s(b.p,this.r1));this.bias=ba(v(b,-(1-Math.pow(this.errorBias,a))/a),this.maxBias)};W.prototype.applyCachedImpulse=function(a){J(this.a,this.b,this.r1,this.r2,this.jAcc.x*a,this.jAcc.y*a)};W.prototype.grooveConstrain=function(a){var b=this.grv_tn;a=0<this.clamp*E(a,b)?a:fb(a,b);return ba(a,this.jMaxLen)};W.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=Ea(a,b,this.r1,this.r2),c=p(this.bias,
c),d=this.k2,c=new m(r(c,this.k1),r(c,d)),d=this.jAcc;this.jAcc=this.grooveConstrain(s(d,c));J(a,b,this.r1,this.r2,this.jAcc.x-d.x,this.jAcc.y-d.y)};W.prototype.getImpulse=function(){return N(this.jAcc)};W.prototype.setGrooveA=function(a){this.grv_a=a;this.grv_n=P(Q(p(this.grv_b,a)));this.activateBodies()};W.prototype.setGrooveB=function(a){this.grv_b=a;this.grv_n=P(Q(p(a,this.grv_a)));this.activateBodies()};var vb=function(a,b){return(a.restLength-b)*a.stiffness},ja=h.DampedSpring=function(a,b,c,
d,e,f,g){x.call(this,a,b);this.anchr1=c;this.anchr2=d;this.restLength=e;this.stiffness=f;this.damping=g;this.springForceFunc=vb;this.target_vrn=this.v_coef=0;this.r1=this.r2=null;this.nMass=0;this.n=null};ja.prototype=Object.create(x.prototype);ja.prototype.preStep=function(a){var b=this.a,c=this.b;this.r1=z(this.anchr1,b.rot);this.r2=z(this.anchr2,c.rot);var d=p(s(c.p,this.r2),s(b.p,this.r1)),e=N(d);this.n=v(d,1/(e?e:Infinity));d=fa(b,c,this.r1,this.r2,this.n);G(0!==d,"Unsolvable this.");this.nMass=
1/d;this.target_vrn=0;this.v_coef=1-Math.exp(-this.damping*a*d);e=this.springForceFunc(this,e);J(b,c,this.r1,this.r2,this.n.x*e*a,this.n.y*e*a)};ja.prototype.applyCachedImpulse=function(a){};ja.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=Ba(a,b,this.r1,this.r2,this.n),d=(this.target_vrn-c)*this.v_coef;this.target_vrn=c+d;d*=this.nMass;J(a,b,this.r1,this.r2,this.n.x*d,this.n.y*d)};ja.prototype.getImpulse=function(){return 0};var wb=function(a,b){return(b-a.restAngle)*a.stiffness},Fa=
h.DampedRotarySpring=function(a,b,c,d,e){x.call(this,a,b);this.restAngle=c;this.stiffness=d;this.damping=e;this.springTorqueFunc=wb;this.iSum=this.w_coef=this.target_wrn=0};Fa.prototype=Object.create(x.prototype);Fa.prototype.preStep=function(a){var b=this.a,c=this.b,d=b.i_inv+c.i_inv;G(0!==d,"Unsolvable spring.");this.iSum=1/d;this.w_coef=1-Math.exp(-this.damping*a*d);this.target_wrn=0;a*=this.springTorqueFunc(this,b.a-c.a);b.w-=a*b.i_inv;c.w+=a*c.i_inv};Fa.prototype.applyImpulse=function(){var a=
this.a,b=this.b,c=a.w-b.w,d=(this.target_wrn-c)*this.w_coef;this.target_wrn=c+d;c=d*this.iSum;a.w+=c*a.i_inv;b.w-=c*b.i_inv};var ka=h.RotaryLimitJoint=function(a,b,c,d){x.call(this,a,b);this.min=c;this.max=d;this.iSum=this.bias=this.jMax=this.jAcc=0};ka.prototype=Object.create(x.prototype);ka.prototype.preStep=function(a){var b=this.a,c=this.b,d=c.a-b.a,e=0;d>this.max?e=this.max-d:d<this.min&&(e=this.min-d);this.iSum=1/(1/b.i+1/c.i);b=this.maxBias;this.bias=F(-(1-Math.pow(this.errorBias,a))*e/a,-b,
b);this.jMax=this.maxForce*a;this.bias||(this.jAcc=0)};ka.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b;a*=this.jAcc;b.w-=a*b.i_inv;c.w+=a*c.i_inv};ka.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=-(this.bias+(b.w-a.w))*this.iSum,d=this.jAcc;this.jAcc=0>this.bias?F(d+c,0,this.jMax):F(d+c,-this.jMax,0);c=this.jAcc-d;a.w-=c*a.i_inv;b.w+=c*b.i_inv}};ka.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var la=h.RatchetJoint=function(a,b,c,d){x.call(this,
a,b);this.angle=0;this.phase=c;this.ratchet=d;this.angle=(b?b.a:0)-(a?a.a:0);this.iSum=this.bias=this.jAcc=this.jMax=0};la.prototype=Object.create(x.prototype);la.prototype.preStep=function(a){var b=this.a,c=this.b,d=this.phase,e=this.ratchet,f=c.a-b.a,g=this.angle-f,h=0;0<g*e?h=g:this.angle=Math.floor((f-d)/e)*e+d;this.iSum=1/(b.i_inv+c.i_inv);b=this.maxBias;this.bias=F(-(1-Math.pow(this.errorBias,a))*h/a,-b,b);this.jMax=this.maxForce*a;this.bias||(this.jAcc=0)};la.prototype.applyCachedImpulse=function(a){var b=
this.a,c=this.b;a*=this.jAcc;b.w-=a*b.i_inv;c.w+=a*c.i_inv};la.prototype.applyImpulse=function(){if(this.bias){var a=this.a,b=this.b,c=this.ratchet,d=-(this.bias+(b.w-a.w))*this.iSum,e=this.jAcc;this.jAcc=F((e+d)*c,0,this.jMax*Math.abs(c))/c;d=this.jAcc-e;a.w-=d*a.i_inv;b.w+=d*b.i_inv}};la.prototype.getImpulse=function(a){return Math.abs(a.jAcc)};var aa=h.GearJoint=function(a,b,c,d){x.call(this,a,b);this.phase=c;this.ratio=d;this.ratio_inv=1/d;this.iSum=this.bias=this.jMax=this.jAcc=0};aa.prototype=
Object.create(x.prototype);aa.prototype.preStep=function(a){var b=this.a,c=this.b;this.iSum=1/(b.i_inv*this.ratio_inv+this.ratio*c.i_inv);var d=this.maxBias;this.bias=F(-(1-Math.pow(this.errorBias,a))*(c.a*this.ratio-b.a-this.phase)/a,-d,d);this.jMax=this.maxForce*a};aa.prototype.applyCachedImpulse=function(a){var b=this.a,c=this.b;a*=this.jAcc;b.w-=a*b.i_inv*this.ratio_inv;c.w+=a*c.i_inv};aa.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=(this.bias-(b.w*this.ratio-a.w))*this.iSum,d=this.jAcc;
this.jAcc=F(d+c,-this.jMax,this.jMax);c=this.jAcc-d;a.w-=c*a.i_inv*this.ratio_inv;b.w+=c*b.i_inv};aa.prototype.getImpulse=function(){return Math.abs(this.jAcc)};aa.prototype.setRatio=function(a){this.ratio=a;this.ratio_inv=1/a;this.activateBodies()};var ma=h.SimpleMotor=function(a,b,c){x.call(this,a,b);this.rate=c;this.iSum=this.jMax=this.jAcc=0};ma.prototype=Object.create(x.prototype);ma.prototype.preStep=function(a){this.iSum=1/(this.a.i_inv+this.b.i_inv);this.jMax=this.maxForce*a};ma.prototype.applyCachedImpulse=
function(a){var b=this.a,c=this.b;a*=this.jAcc;b.w-=a*b.i_inv;c.w+=a*c.i_inv};ma.prototype.applyImpulse=function(){var a=this.a,b=this.b,c=-(b.w-a.w+this.rate)*this.iSum,d=this.jAcc;this.jAcc=F(d+c,-this.jMax,this.jMax);c=this.jAcc-d;a.w-=c*a.i_inv;b.w+=c*b.i_inv};ma.prototype.getImpulse=function(){return Math.abs(this.jAcc)}})();